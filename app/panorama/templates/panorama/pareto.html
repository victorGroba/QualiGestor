{% extends 'base.html' %}

{% block title %}Análise de Pareto - Panorama{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Estilos compartilhados do Dashboard */
    .filter-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .chart-container {
        position: relative;
        height: 500px; /* Altura ajustada para o Pareto */
        width: 100%;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Header com Filtros (Estilo Dashboard) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-card shadow-sm">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0 text-gray-800">
                        <i class="fas fa-chart-bar me-2 text-danger"></i>
                        Análise de Pareto (80/20)
                    </h4>
                    <a href="{{ url_for('panorama.dashboard') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Voltar ao Dashboard
                    </a>
                </div>
                
                <form id="formFiltros" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Início</label>
                        <input type="date" id="dataInicio" class="form-control">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Fim</label>
                        <input type="date" id="dataFim" class="form-control">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Avaliado</label>
                        <select id="avaliadoId" class="form-select">
                            <option value="">Todos os avaliados</option>
                            {% for a in avaliados %}
                            <option value="{{ a.id }}">{{ a.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <button type="button" onclick="carregarPareto()" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-1"></i>
                            Atualizar Gráfico
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Área do Gráfico -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white border-bottom">
                    <h5 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Distribuição de Não Conformidades por Tópico
                    </h5>
                    <span class="badge bg-danger fs-6" id="totalErrosBadge">Total: 0</span>
                </div>
                
                <div class="card-body">
                    <!-- Loading -->
                    <div id="loading" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Calculando estatísticas...</p>
                    </div>
                    
                    <!-- Estado Vazio -->
                    <div id="noData" class="text-center py-5 d-none">
                        <div class="mb-3">
                            <i class="fas fa-check-circle fa-4x text-success opacity-50"></i>
                        </div>
                        <h5 class="text-gray-800">Nenhuma Não Conformidade Encontrada!</h5>
                        <p class="text-muted">Parabéns! Tudo está conforme no período selecionado.</p>
                    </div>

                    <!-- Canvas do Gráfico -->
                    <div class="chart-area" style="position: relative;">
                        <div class="chart-container">
                            <canvas id="paretoChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let myChart = null;

document.addEventListener("DOMContentLoaded", function() {
    // Define datas padrão (últimos 30 dias)
    const hoje = new Date();
    const passado = new Date();
    passado.setDate(hoje.getDate() - 30);
    
    document.getElementById('dataFim').valueAsDate = hoje;
    document.getElementById('dataInicio').valueAsDate = passado;

    carregarPareto();
});

function carregarPareto() {
    // UI Updates
    const loading = document.getElementById('loading');
    const noData = document.getElementById('noData');
    const chartCanvas = document.querySelector('.chart-container canvas');
    
    loading.style.display = 'block';
    noData.classList.add('d-none');
    if(chartCanvas) chartCanvas.style.opacity = 0;

    // Coleta filtros
    const params = new URLSearchParams({
        data_inicio: document.getElementById('dataInicio').value,
        data_fim: document.getElementById('dataFim').value,
        avaliado_id: document.getElementById('avaliadoId').value
    });

    fetch(`/panorama/api/pareto-data?${params}`)
        .then(res => res.json())
        .then(data => {
            loading.style.display = 'none';
            document.getElementById('totalErrosBadge').innerText = `Total de NCs: ${data.total_erros}`;

            if (!data.labels || data.labels.length === 0) {
                noData.classList.remove('d-none');
                if(myChart) myChart.destroy();
                return;
            }

            if(chartCanvas) chartCanvas.style.opacity = 1;
            renderizarGrafico(data);
        })
        .catch(err => {
            console.error(err);
            loading.style.display = 'none';
            alert("Erro ao carregar dados do gráfico.");
        });
}

function renderizarGrafico(data) {
    const ctx = document.getElementById('paretoChart').getContext('2d');

    if (myChart) {
        myChart.destroy();
    }

    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [
                {
                    label: 'Acumulado (%)',
                    data: data.percentual,
                    type: 'line',
                    borderColor: '#e74a3b', // Vermelho Danger
                    backgroundColor: '#e74a3b',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.1,
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Frequência (Qtd)',
                    data: data.data,
                    backgroundColor: '#4e73df', // Azul Primary
                    hoverBackgroundColor: '#2e59d9',
                    borderColor: '#4e73df',
                    borderWidth: 1,
                    yAxisID: 'y',
                    barPercentage: 0.6,
                    categoryPercentage: 0.7,
                    borderRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255,255,255,0.9)',
                    titleColor: '#6e707e',
                    bodyColor: '#858796',
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.dataset.type === 'line') {
                                label += context.parsed.y + '%';
                            } else {
                                label += context.parsed.y;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Quantidade de Erros' },
                    grid: {
                        borderDash: [2],
                        color: '#eaecf4'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    min: 0,
                    max: 100,
                    title: { display: true, text: 'Acumulado (%)' },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}