{% extends 'base.html' %}

{% block title %}Dashboard - Panorama{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
    .metric-card { transition: transform 0.2s ease-in-out; }
    .metric-card:hover { transform: translateY(-5px); }
    .chart-container { position: relative; width: 100%; }
    .scrollable-chart-area-x { width: 100%; overflow-x: auto; overflow-y: hidden; padding-top: 15px; }
    #containerAvaliados { height: 400px; }
    .loading-spinner { display: none; text-align: center; padding: 40px; }
    .filter-card { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e9ecef; }
    .ranking-item:last-child { border-bottom: none; }
    
    /* Overlay para bloquear interações enquanto carrega */
    #loadingOverlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.8);
        z-index: 1050; display: none;
        align-items: center; justify-content: center; flex-direction: column;
    }
</style>
{% endblock %}

{% block content %}

<div id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Carregando...</span>
    </div>
    <h5 class="mt-3 fw-bold text-primary">Calculando Resultados...</h5>
    <p class="text-muted">Aguarde um momento, estamos montando seus gráficos.</p>
</div>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Dashboard de Qualidade
                    </h4>
                    <a href="{{ url_for('panorama.analise_pareto') }}" class="btn btn-outline-danger">
                        <i class="fas fa-chart-bar me-1"></i>
                        Análise de Pareto (80/20)
                    </a>
                </div>
                
                <form id="filtroForm" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label text-primary fw-bold">Filtrar por Mês</label>
                        <select class="form-select border-primary" name="mes" id="mes">
                            <option value="">(Ignorar Mês)</option>
                            {% for m in filtros.meses %}
                            <option value="{{ m.valor }}" {% if filtros_aplicados.mes == m.valor %}selected{% endif %}>
                                {{ m.label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">Ou Período</label>
                        <select class="form-select" name="periodo" id="periodo">
                            <option value="7" {% if filtros_aplicados.periodo == '7' %}selected{% endif %}>Últimos 7 dias</option>
                            <option value="30" {% if filtros_aplicados.periodo == '30' %}selected{% endif %}>Últimos 30 dias</option>
                            <option value="90" {% if filtros_aplicados.periodo == '90' %}selected{% endif %}>Últimos 90 dias</option>
                            <option value="365" {% if filtros_aplicados.periodo == '365' %}selected{% endif %}>Último ano</option>
                        </select>
                    </div>

                    <div class="col-md-2">
                        <label class="form-label">GAP (Grupo)</label>
                        <select class="form-select" name="grupo_id" id="grupo_id">
                            <option value="">Todos os GAPs</option>
                            {% for grupo in filtros.grupos %}
                            <option value="{{ grupo.id }}" {% if filtros_aplicados.grupo_id == grupo.id %}selected{% endif %}>
                                {{ grupo.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Avaliado (Rancho)</label>
                        <select class="form-select" name="avaliado_id" id="avaliado_id">
                            <option value="">Todos os avaliados</option>
                            {% for avaliado in filtros.avaliados %}
                            <option value="{{ avaliado.id }}" {% if filtros_aplicados.avaliado_id == avaliado.id %}selected{% endif %}>
                                {{ avaliado.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Questionário</label>
                        <select class="form-select" name="questionario_id" id="questionario_id">
                            <option value="">Todos os questionários</option>
                            {% for questionario in filtros.questionarios %}
                            <option value="{{ questionario.id }}" {% if filtros_aplicados.questionario_id == questionario.id %}selected{% endif %}>
                                {{ questionario.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2 w-100">
                            <i class="fas fa-filter me-1"></i> Filtrar
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="exportarDados()" title="Exportar Dados">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="row mb-4" id="metricas-cards">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-primary mb-2"><i class="fas fa-clipboard-list fa-2x"></i></div>
                    <h4 class="fw-bold" id="metrica-auditorias">-</h4>
                    <p class="text-muted mb-0">Aplicações</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-success mb-2"><i class="fas fa-percentage fa-2x"></i></div>
                    <h4 class="fw-bold" id="metrica-media">-</h4>
                    <p class="text-muted mb-0">Média Geral</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-info mb-2"><i class="fas fa-store fa-2x"></i></div>
                    <h4 class="fw-bold" id="metrica-lojas">-</h4>
                    <p class="text-muted mb-0">Avaliados</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-secondary mb-2" id="icon-tendencia">
                        <i class="fas fa-trending-flat fa-2x"></i>
                    </div>
                    <h4 class="fw-bold text-secondary" id="metrica-tendencia">-</h4>
                    <p class="text-muted mb-0">Tendência</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-warning mb-2"><i class="fas fa-exclamation-triangle fa-2x"></i></div>
                    <h4 class="fw-bold" id="metrica-criticas">-</h4>
                    <p class="text-muted mb-0">Críticas</p>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card metric-card h-100 border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-success mb-2"><i class="fas fa-check-circle fa-2x"></i></div>
                    <h4 class="fw-bold" id="metrica-conformidade">-</h4>
                    <p class="text-muted mb-0">Conformidade</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Evolução Mensal Média (Nota 0-10)</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="chartEvolucao"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-list-ol me-2"></i> Demonstrativo de categorias</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="chartTopicos"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12 mb-3">
            <h5 class="fw-bold border-bottom pb-2">
                <i class="fas fa-chart-bar me-2"></i> Evolução Mensal por Tópico (Nota 0-10)
            </h5>
        </div>
        
        <div id="containerEvolucaoTopicos" class="row w-100 m-0"></div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-store me-2"></i> Performance Geral (Lista de Avaliados)</h5>
                </div>
                <div class="card-body p-2">
                    <div class="scrollable-chart-area-x" id="scrollContainerAvaliados">
                        <div class="chart-container" id="containerAvaliados">
                            <canvas id="chartAvaliados"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-trophy me-2"></i> Ranking (Top 10)</h5>
                </div>
                <div class="card-body">
                    <div id="rankingAvaliados">
                        <div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>Carregando ranking...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i> Performance por Questionário</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartQuestionarios"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> Top Não Conformidades</h5>
                </div>
                <div class="card-body">
                    <div id="topNcList" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>Carregando problemas...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);

let chartEvolucao, chartTopicos, chartAvaliados, chartQuestionarios;
let chartsEvolucaoTopicosSeparados = []; // Array para armazenar os gráficos individuais de tópicos

const defaultOptions = {
    responsive: true,
    maintainAspectRatio: false,
    layout: { padding: { top: 25, right: 15 } },
    plugins: {
        legend: { position: 'top' },
        tooltip: {
            backgroundColor: 'rgba(0,0,0,0.8)', titleColor: 'white', bodyColor: 'white', borderColor: '#007bff', borderWidth: 1
        }
    }
};

document.addEventListener('DOMContentLoaded', function() {
    
    const selectMes = document.getElementById('mes');
    const selectPeriodo = document.getElementById('periodo');
    selectMes.addEventListener('change', function() {
        if(this.value !== "") {
            selectPeriodo.value = "30";
            selectPeriodo.setAttribute('disabled', 'disabled');
        } else {
            selectPeriodo.removeAttribute('disabled');
        }
    });
    if(selectMes.value !== "") { selectPeriodo.setAttribute('disabled', 'disabled'); }

    // 1. Inicializa a página visualmente com gráficos vazios (Casca)
    initializeCharts();
    setupEventListeners();

    // 2. Mostra o Spinner Gigante e faz o Ajax buscar os dados
    document.getElementById('loadingOverlay').style.display = 'flex';
    atualizarDados();
});

function aplicarLarguraDinamica(qtdBarras) {
    const minWidth = document.getElementById('scrollContainerAvaliados').clientWidth || 600; 
    const larguraCalculada = Math.max(minWidth, qtdBarras * 60); 
    document.getElementById('containerAvaliados').style.width = larguraCalculada + 'px';
}

function initializeCharts() {
    
    // Gráficos começam vazios
    const ctxEvolucao = document.getElementById('chartEvolucao').getContext('2d');
    chartEvolucao = new Chart(ctxEvolucao, {
        type: 'bar', data: { labels: [], datasets: [] },
        options: {
            ...defaultOptions,
            scales: { y: { beginAtZero: true, max: 10, ticks: { stepSize: 1 } } },
            plugins: { ...defaultOptions.plugins, title: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: Math.round, color: '#333', font: { weight: 'bold', size: 14 } } }
        }
    });

    const ctxTopicos = document.getElementById('chartTopicos').getContext('2d');
    chartTopicos = new Chart(ctxTopicos, {
        type: 'bar', data: { labels: [], datasets: [] },
        options: {
            ...defaultOptions,
            scales: { y: { beginAtZero: true, max: 10, ticks: { stepSize: 1 } }, x: { display: false } },
            plugins: { ...defaultOptions.plugins, legend: { display: true, position: 'right', labels: { boxWidth: 15, font: { size: 11 } } }, datalabels: { anchor: 'end', align: 'top', color: '#333', font: { weight: 'bold', size: 13 } } }
        }
    });

    const ctxAvaliados = document.getElementById('chartAvaliados').getContext('2d');
    chartAvaliados = new Chart(ctxAvaliados, {
        type: 'bar', data: { labels: [], datasets: [] },
        options: {
            ...defaultOptions,
            scales: { y: { beginAtZero: true, max: 100, ticks: { callback: function(value) { return value + '%'; } } }, x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } } },
            plugins: { ...defaultOptions.plugins, legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: (value) => value + '%', color: '#333', font: { weight: 'bold', size: 13 } } }
        }
    });

    const ctxQuestionarios = document.getElementById('chartQuestionarios').getContext('2d');
    chartQuestionarios = new Chart(ctxQuestionarios, {
        type: 'pie', data: { labels: [], datasets: [] },
        options: { ...defaultOptions, plugins: { ...defaultOptions.plugins, legend: { position: 'bottom' }, datalabels: { display: false } } }
    });
}

function setupEventListeners() {
    document.getElementById('filtroForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('periodo').removeAttribute('disabled');
        aplicarFiltros();
    });
    // Atualiza invisivelmente a cada 5 min
    setInterval(function() { 
        // Chama o fetch escondido para não travar a tela
        fetchDadosAjax(false); 
    }, 300000); 
}

function aplicarFiltros() {
    // Mostra o Overlay Spinner para travar a tela enquanto carrega
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Atualiza a URL só por estética (para copiar link) sem refresh real
    const formData = new FormData(document.getElementById('filtroForm'));
    const params = new URLSearchParams(formData);
    window.history.replaceState({}, '', `${window.location.pathname}?${params.toString()}`);
    
    atualizarDados();
}

function atualizarDados() {
    fetchDadosAjax(true);
}

function fetchDadosAjax(showSpinner) {
    const formData = new FormData(document.getElementById('filtroForm'));
    const params = new URLSearchParams(formData);
    
    fetch(`/panorama/api/dashboard-data?${params.toString()}`)
        .then(response => response.json())
        .then(data => { 
            atualizarValoresMetricas(data.metricas);
            atualizarHTMLAvaliadosENC(data);
            atualizarGraficos(data); 
            
            // Tira a tela de carregamento quando terminar
            if(showSpinner) {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        })
        .catch(error => { 
            console.error(error); 
            if(showSpinner) { document.getElementById('loadingOverlay').style.display = 'none'; }
            showNotification('Erro ao carregar os dados do painel. Tente novamente.', 'danger');
        });
}

function atualizarValoresMetricas(metricas) {
    if(!metricas) return;
    document.getElementById('metrica-auditorias').innerText = metricas.total_auditorias;
    document.getElementById('metrica-media').innerText = metricas.pontuacao_media + '%';
    document.getElementById('metrica-lojas').innerText = metricas.lojas_auditadas;
    
    const h4Tendencia = document.getElementById('metrica-tendencia');
    const divIconTendencia = document.getElementById('icon-tendencia');
    let sinal = metricas.tendencia_pontuacao > 0 ? '+' : '';
    h4Tendencia.innerText = sinal + metricas.tendencia_pontuacao + '%';
    
    h4Tendencia.className = 'fw-bold ' + (metricas.tendencia_pontuacao > 0 ? 'text-success' : (metricas.tendencia_pontuacao < 0 ? 'text-danger' : 'text-secondary'));
    divIconTendencia.className = 'mb-2 ' + (metricas.tendencia_pontuacao > 0 ? 'text-success' : (metricas.tendencia_pontuacao < 0 ? 'text-danger' : 'text-secondary'));
    divIconTendencia.innerHTML = `<i class="fas fa-trending-${metricas.tendencia_pontuacao > 0 ? 'up' : (metricas.tendencia_pontuacao < 0 ? 'down' : 'flat')} fa-2x"></i>`;

    document.getElementById('metrica-criticas').innerText = metricas.auditorias_criticas;
    document.getElementById('metrica-conformidade').innerText = metricas.conformidade_geral + '%';
}

function atualizarHTMLAvaliadosENC(data) {
    // 1. Atualiza o HTML do Ranking
    const rankingDiv = document.getElementById('rankingAvaliados');
    if (data.ranking_avaliados && data.ranking_avaliados.length > 0) {
        let html = '';
        data.ranking_avaliados.forEach((item, index) => {
            html += `
            <div class="ranking-item">
                <div>
                    <span class="badge bg-secondary me-2">${index + 1}º</span>
                    <strong>${item.loja}</strong>
                    <br><small class="text-muted">${item.total_auditorias} aplicações</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-${item.status} fs-6">${item.media}%</span>
                </div>
            </div>`;
        });
        rankingDiv.innerHTML = html;
    } else {
        rankingDiv.innerHTML = `<div class="text-center text-muted py-4"><i class="fas fa-info-circle fa-2x mb-2"></i><p>Nenhum dado disponível</p></div>`;
    }

    // 2. Atualiza Top Não Conformidades
    const ncDiv = document.getElementById('topNcList');
    if (data.top_nao_conformidades && data.top_nao_conformidades.length > 0) {
        let htmlNC = '';
        data.top_nao_conformidades.forEach(nc => {
            let desc = nc.pergunta.length > 50 ? nc.pergunta.substring(0, 50) + '...' : nc.pergunta;
            htmlNC += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                <div class="flex-grow-1"><small class="fw-bold">${desc}</small></div>
                <span class="badge bg-danger">${nc.frequencia}</span>
            </div>`;
        });
        ncDiv.innerHTML = htmlNC;
    } else {
        ncDiv.innerHTML = `<div class="text-center text-muted py-4"><i class="fas fa-check-circle fa-2x mb-2"></i><p>Nenhuma não conformidade encontrada</p></div>`;
    }
}

function atualizarGraficos(data) {
    if (chartEvolucao && data.evolucao) { chartEvolucao.data = data.evolucao; chartEvolucao.update(); }
    if (chartTopicos && data.topicos) { chartTopicos.data = data.topicos; chartTopicos.update(); }
    if (chartQuestionarios && data.questionarios) { chartQuestionarios.data = data.questionarios; chartQuestionarios.update(); }
    if (chartAvaliados && data.por_avaliado) { 
        aplicarLarguraDinamica(data.por_avaliado.labels.length); 
        chartAvaliados.data = data.por_avaliado; 
        chartAvaliados.update(); 
    }

    // Recriação completa dos cards de tópicos para não encavalar dados ao filtrar
    const containerTopicos = document.getElementById('containerEvolucaoTopicos');
    containerTopicos.innerHTML = '';
    chartsEvolucaoTopicosSeparados.forEach(c => c.destroy());
    chartsEvolucaoTopicosSeparados = [];

    if (data.evolucao_topicos && data.evolucao_topicos.length > 0) {
        data.evolucao_topicos.forEach(graficoObj => {
            // Cria a Div do Card na hora
            const colDiv = document.createElement('div');
            colDiv.className = "col-lg-6 mb-4";
            colDiv.innerHTML = `
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white border-bottom text-center">
                        <h6 class="mb-0 fw-bold" style="color: ${graficoObj.cor};">${graficoObj.titulo} - Evolução Mensal</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="${graficoObj.id}"></canvas>
                        </div>
                    </div>
                </div>
            `;
            containerTopicos.appendChild(colDiv);

            // Popula o Chart.js na div recém criada
            const ctxNew = document.getElementById(graficoObj.id).getContext('2d');
            const newChart = new Chart(ctxNew, {
                type: 'bar',
                data: graficoObj.dados,
                options: {
                    ...defaultOptions,
                    scales: { y: { beginAtZero: true, max: 10, ticks: { stepSize: 2 } } },
                    plugins: {
                        ...defaultOptions.plugins,
                        legend: { display: false },
                        datalabels: { 
                            anchor: 'end', align: 'top', color: '#333', font: { weight: 'bold', size: 12 },
                            formatter: function(value) { return value !== null ? value : ''; }
                        }
                    }
                }
            });
            chartsEvolucaoTopicosSeparados.push(newChart);
        });
    } else {
        containerTopicos.innerHTML = `<div class="col-12"><div class="alert alert-light text-center border">Nenhum dado de evolução de tópicos disponível para o período.</div></div>`;
    }
}

function exportarDados() {
    const formato = prompt('Escolha o formato de exportação (csv ou json):', 'csv');
    if (formato && ['csv', 'json'].includes(formato)) {
        document.getElementById('periodo').removeAttribute('disabled');
        const formData = new FormData(document.getElementById('filtroForm'));
        const params = new URLSearchParams(formData);
        params.append('formato', formato);
        window.open(`/panorama/api/export-data?${params.toString()}`, '_blank');
        
        if(document.getElementById('mes').value !== "") {
            document.getElementById('periodo').setAttribute('disabled', 'disabled');
        }
    }
}

function showNotification(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

function handleResize() {
    if (chartEvolucao) chartEvolucao.resize();
    if (chartTopicos) chartTopicos.resize();
    if (chartsEvolucaoTopicosSeparados) { chartsEvolucaoTopicosSeparados.forEach(c => c.resize()); }
    if (chartAvaliados) chartAvaliados.resize();
    if (chartQuestionarios) chartQuestionarios.resize();
}
window.addEventListener('resize', handleResize);
</script>
{% endblock %}