<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório de Ações Corretivas</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 11px; color: #333; margin: 0; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #0056b3; padding-bottom: 10px; }
        .header img { max-height: 60px; }
        .info-table { width: 100%; margin-bottom: 20px; border-collapse: collapse; }
        .info-table td { padding: 5px; border: 1px solid #ddd; }
        .info-table th { padding: 5px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left; width: 20%; }
        
        .main-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .main-table th { background-color: #0056b3; color: white; padding: 10px; text-align: left; font-size: 12px; }
        .main-table td { border: 1px solid #ddd; padding: 10px; vertical-align: top; }
        .main-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        .badge { display: inline-block; padding: 3px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; color: white; }
        .bg-pendente { background-color: #dc3545; }
        .bg-realizado { background-color: #28a745; }
        
        .fotos-container { margin-top: 10px; }
        .img-evidencia { max-width: 120px; max-height: 120px; margin-right: 5px; border: 1px solid #ccc; }
        
        .text-muted { color: #666; font-style: italic; }
    </style>
</head>
<body>

    <div class="header">
        {% if logo_pdf %}
            <img src="{{ logo_pdf }}" alt="Logo">
        {% else %}
            <h2>QualiGestor</h2>
        {% endif %}
        <h3>Relatório de Ações Corretivas</h3>
    </div>

    <table class="info-table">
        <tr>
            <th>Unidade Avaliada</th>
            <td colspan="3"><strong>{{ aplicacao.avaliado.nome }}</strong></td>
        </tr>
        <tr>
            <th>Data da Auditoria</th>
            <td>{{ (aplicacao.visita_inicio or aplicacao.data_inicio).strftime('%d/%m/%Y') }}</td>
            <th>Consultora</th>
            <td>{{ aplicacao.aplicador.nome if aplicacao.aplicador else 'Sistema' }}</td>
        </tr>
        <tr>
            <th>Questionário</th>
            <td colspan="3">{{ aplicacao.questionario.nome }}</td>
        </tr>
    </table>

    <table class="main-table">
        <thead>
            <tr>
                <th style="width: 25%;">Item / Evidência</th>
                <th style="width: 25%;">Orientação (Consultora)</th>
                <th style="width: 30%;">O que foi feito (Gestor)</th>
                <th style="width: 20%;">Status / Criticidade</th>
            </tr>
        </thead>
        <tbody>
            {% for item in itens %}
            <tr>
                <td>
                    <strong>{{ item.topico }}</strong><br>
                    {{ item.pergunta }}<br><br>
                    <span style="color: #dc3545;"><em>Obs: {{ item.problema }}</em></span>
                    
                    {% if item.fotos %}
                    <div class="fotos-container">
                        {% for foto_b64 in item.fotos %}
                            <img src="{{ foto_b64 }}" class="img-evidencia">
                        {% endfor %}
                    </div>
                    {% endif %}
                </td>
                
                <td>
                    {{ item.sugestao or 'Sem orientação registrada.' }}
                </td>
                
                <td>
                    {% if item.acao_realizada %}
                        <span style="color: #28a745;"><strong>Realizado:</strong></span><br>
                        {{ item.acao_realizada }}
                    {% else %}
                        <span class="text-muted">Aguardando preenchimento do gestor da unidade.</span>
                    {% endif %}
                </td>
                
                <td>
                    <div style="margin-bottom: 5px;">
                        {% if item.status == 'Realizado' %}
                            <span class="badge bg-realizado">CONCLUÍDO</span>
                        {% else %}
                            <span class="badge bg-pendente">PENDENTE</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong>Criticidade:</strong> {{ item.criticidade }}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="text-align: right; margin-top: 20px; font-size: 10px; color: #777;">
        Relatório gerado em: {{ data_geracao.strftime('%d/%m/%Y %H:%M') }}
    </div>

</body>
</html>