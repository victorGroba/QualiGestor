{% extends "base_cliq.html" %}

{% block title %}Editar Usuário{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Ajustes para o Select2 parecer com o Bootstrap 5 */
    .select2-container .select2-selection--multiple {
        border: 1px solid #ced4da !important;
        min-height: 38px !important;
        border-radius: 0.375rem !important;
        padding-bottom: 0;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #0dcaf0 !important; /* Cor Cyan do tema */
        border: 1px solid #0dcaf0 !important;
        color: white !important;
        border-radius: 20px;
        padding: 2px 8px;
        margin-top: 4px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white !important;
        margin-right: 5px;
        border-right: 1px solid rgba(255,255,255,0.5);
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        background-color: transparent !important;
        color: #ffcccc !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Editar Usuário: {{ usuario.nome }}</h6>
        </div>
        <div class="card-body">
            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Nome</label>
                        <input type="text" name="nome" class="form-control" value="{{ usuario.nome }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">E-mail</label>
                        <input type="email" name="email" class="form-control" value="{{ usuario.email }}" required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Perfil</label>
                        <select class="form-select" id="tipo" name="tipo" onchange="atualizarFormulario()">
                            <option value="super_admin" {% if usuario.tipo.name == 'SUPER_ADMIN' %}selected{% endif %}>Super Admin</option>
                            <option value="admin" {% if usuario.tipo.name == 'ADMIN' %}selected{% endif %}>Admin (FAB)</option>
                            <option value="gestor" {% if usuario.tipo.name == 'GESTOR' %}selected{% endif %}>Gestor (GAP)</option>
                            <option value="auditor" {% if usuario.tipo.name == 'AUDITOR' %}selected{% endif %}>Consultora (Auditora)</option>
                            <option value="usuario" {% if usuario.tipo.name == 'USUARIO' %}selected{% endif %}>Rancho (Operacional)</option>
                        </select>
                    </div>

                    <div class="col-md-4 mb-3" id="divGap">
                        <label class="form-label text-info fw-bold">GAPs de Atuação (Multi-seleção)</label>
                        <select class="form-select border-info" id="grupos_acesso" name="grupos_acesso" multiple="multiple" style="width: 100%;">
                            {% for g in gaps %}
                            <option value="{{ g.id }}" 
                                {# CORREÇÃO CRÍTICA: Compara ID com lista de IDs para marcar corretamente #}
                                {% if g.id in usuario.grupos_acesso|map(attribute='id')|list %}selected{% endif %}>
                                {{ g.nome }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-primary small"><i class="fas fa-info-circle"></i> Clique para adicionar/remover GAPs.</div>
                    </div>

                    <div class="col-md-4 mb-3" id="divRancho">
                        <label class="form-label text-success">Vincular ao Rancho</label>
                        <select class="form-select border-success" id="avaliado_id" name="avaliado_id">
                            <option value="">-- Selecione o GAP primeiro --</option>
                        </select>
                        <div class="form-text small">Usado apenas para perfil Rancho.</div>
                    </div>
                </div>

                <div class="alert alert-warning mt-3">
                    <i class="fas fa-key me-2"></i><strong>Alterar Senha:</strong>
                    <input type="password" name="senha" class="form-control d-inline-block w-50 ms-2" placeholder="Deixe em branco para manter a atual">
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <a href="{{ url_for('cli.gerenciar_usuarios') }}" class="btn btn-secondary me-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    const todosRanchos = [
        {% for r in ranchos %}
        { "id": "{{ r.id }}", "nome": {{ r.nome|tojson }}, "grupo_id": "{{ r.grupo_id }}" },
        {% endfor %}
    ];
    
    // ID do rancho salvo no banco (para pré-selecionar)
    const ranchoAtualId = "{{ usuario.avaliado_id if usuario.avaliado_id else '' }}";

    function atualizarFormulario() {
        const tipo = document.getElementById('tipo').value;
        const divGap = document.getElementById('divGap');
        const divRancho = document.getElementById('divRancho');
        
        if (tipo === 'gestor' || tipo === 'auditor') {
            divGap.style.display = 'block';
            divRancho.style.display = 'none';
        } else if (tipo === 'usuario') {
            divGap.style.display = 'block';
            divRancho.style.display = 'block';
        } else {
            divGap.style.display = 'none';
            divRancho.style.display = 'none';
        }
    }

    function filtrarRanchos() {
        // Pega valor do Select2 (pode ser array ou string)
        const gapVal = $('#grupos_acesso').val();
        // Se for array múltiplo, pega o primeiro para filtrar os ranchos (regra de negócio: Rancho pertence a 1 GAP)
        const gapId = Array.isArray(gapVal) ? gapVal[0] : gapVal;
        
        const selectRancho = document.getElementById('avaliado_id');
        selectRancho.innerHTML = '<option value="">-- Selecione --</option>';

        if (gapId) {
            const filtrados = todosRanchos.filter(r => String(r.grupo_id) === String(gapId));
            
            if (filtrados.length > 0) {
                filtrados.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id;
                    opt.text = r.nome;
                    // Marca o rancho atual se bater o ID
                    if (String(r.id) === String(ranchoAtualId)) {
                        opt.selected = true;
                    }
                    selectRancho.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.text = "Nenhum rancho neste GAP";
                selectRancho.appendChild(opt);
            }
        }
    }

    $(document).ready(function() {
        // 1. Inicia Select2
        $('#grupos_acesso').select2({
            placeholder: "Selecione os GAPs...",
            allowClear: true,
            width: '100%'
        });

        // 2. Evento de mudança (Select2 usa jQuery events)
        $('#grupos_acesso').on('change', function() {
            filtrarRanchos();
        });

        // 3. Configuração Inicial
        atualizarFormulario();
        
        // 4. Se tiver GAP selecionado ao abrir a tela, carrega os ranchos
        if ($('#grupos_acesso').val() && $('#grupos_acesso').val().length > 0) {
            filtrarRanchos();
        }
    });
</script>
{% endblock %}