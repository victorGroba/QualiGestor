{% extends "base_cliq.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-3">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Detalhes da Aplicação</h5>
                </div>
                <div class="card-body">
                    <h6 class="card-title">{{ aplicacao.questionario.nome }}</h6>
                    <p class="card-text">
                        <strong>Avaliador:</strong> {{ aplicacao.aplicador.nome }}<br>
                        <strong>Avaliado:</strong> {{ aplicacao.avaliado.nome }}<br>
                        <strong>Data Início:</strong> {{ aplicacao.data_inicio.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                    <hr>
                    <p class="text-muted small">
                        Suas respostas são salvas automaticamente à medida que você preenche.
                    </p>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <form id="form-finalizar" action="{{ url_for('cli.finalizar_aplicacao', id=aplicacao.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                {% for topico in topicos %}
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{{ topico.nome }}</h5>
                        {% if topico.descricao %}
                        <p class="text-muted mb-0 small">{{ topico.descricao }}</p>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if perguntas_por_topico[topico.id] %}
                        {% for pergunta in perguntas_por_topico[topico.id] %}
                        <div class="mb-4 p-3 border rounded">
                            <label class="form-label fw-bold">
                                {{ topico.ordem }}.{{ pergunta.ordem }} - {{ pergunta.texto }}
                                {% if pergunta.obrigatoria %}
                                <span class="text-danger">*</span>
                                {% endif %}
                            </label>

                            ...
                        </div>

                        {% set resposta_salva = respostas_existentes.get(pergunta.id) %}

                        {% if pergunta.tipo.name == 'SIM_NAO_NA' %}
                        <div class_id="resposta-container-{{ pergunta.id }}">
                            {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="resposta-{{ pergunta.id }}"
                                    id="opcao-{{ opcao.id }}" value="{{ opcao.texto }}"
                                    data-pergunta-id="{{ pergunta.id }}" onchange="salvarResposta(this)" {% if
                                    resposta_salva and resposta_salva.resposta==opcao.texto %}checked{% endif %}>
                                <label class="form-check-label" for="opcao-{{ opcao.id }}">
                                    {{ opcao.texto }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>

                        {% elif pergunta.tipo.name == 'MULTIPLA_ESCOLHA' %}
                        <select class="form-select" name="resposta-{{ pergunta.id }}"
                            data-pergunta-id="{{ pergunta.id }}" onchange="salvarResposta(this)">
                            <option value="">Selecione...</option>
                            {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                            <option value="{{ opcao.texto }}" {% if resposta_salva and
                                resposta_salva.resposta==opcao.texto %}selected{% endif %}>
                                {{ opcao.texto }}
                            </option>
                            {% endfor %}
                        </select>

                        {% elif pergunta.tipo.name == 'NOTA' or pergunta.tipo.name == 'ESCALA_NUMERICA' %}
                        <input type="number" class="form-control" name="resposta-{{ pergunta.id }}"
                            data-pergunta-id="{{ pergunta.id }}"
                            value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                            onblur="salvarResposta(this)">

                        {% elif pergunta.tipo.name == 'TEXTO_CURTO' %}
                        <input type="text" class="form-control" name="resposta-{{ pergunta.id }}"
                            data-pergunta-id="{{ pergunta.id }}"
                            value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                            onblur="salvarResposta(this)">

                        {% elif pergunta.tipo.name == 'TEXTO_LONGO' %}
                        <textarea class="form-control" rows="3" name="resposta-{{ pergunta.id }}"
                            data-pergunta-id="{{ pergunta.id }}"
                            onblur="salvarResposta(this)">{{ resposta_salva.resposta if resposta_salva else '' }}</textarea>

                        {% else %}
                        <p class="text-danger small">Tipo de pergunta não suportado: {{ pergunta.tipo.name }}</p>
                        {% endif %}

                        {% if pergunta.permite_observacao %}
                        <div class="mt-2">
                            <label for="obs-{{ pergunta.id }}" class="form-label small text-muted">Observação:</label>
                            <textarea class="form-control form-control-sm" id="obs-{{ pergunta.id }}"
                                name="observacao-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                onblur="salvarResposta(this, true)"
                                rows="2">{{ resposta_salva.observacao if resposta_salva else '' }}</textarea>
                        </div>
                        {% endif %}

                        <div id="feedback-{{ pergunta.id }}" class="form-text small mt-1"></div>

                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">Nenhuma pergunta encontrada neste tópico.</p>
                    {% endif %}
                </div>
        </div>
        {% endfor %}

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-comment-alt me-2"></i>Observações Finais</h5>
            </div>
            <div class="card-body">
                <textarea class="form-control" name="observacoes_finais" rows="4"
                    placeholder="Digite aqui qualquer observação geral sobre a aplicação...">{{ aplicacao.observacoes_finais or '' }}</textarea>
            </div>
        </div>

        <div class="text-end mb-5">
            <a href="{{ url_for('cli.listar_aplicacoes') }}" class="btn btn-secondary">
                <i class="fas fa-times me-2"></i>Cancelar
            </a>
            <button type-="submit" class="btn btn-primary">
                <i class="fas fa-check-circle me-2"></i>Finalizar Aplicação
            </button>
        </div>
        </form>
    </div>
</div>
</div>
{% endblock %}


{% block extra_js %}
<script>
    // Função Mágica: Salva a resposta via AJAX
    async function salvarResposta(inputElement, isObservacao = false) {

        let perguntaId, respostaValue, observacaoValue;

        // Pega o ID da pergunta
        perguntaId = inputElement.dataset.perguntaId;

        // Pega os elementos corretos
        let respostaInput, observacaoInput;

        if (isObservacao) {
            // Se o trigger foi o campo OBS, o input da resposta é o outro
            observacaoInput = inputElement;
            // Tenta encontrar o input de resposta (pode ser radio, select ou text)
            respostaInput = document.querySelector(`[name="resposta-${perguntaId}"]:checked`) ||
                document.querySelector(`[name="resposta-${perguntaId}"]`);
        } else {
            // Se o trigger foi o campo RESPOSTA, o input da obs é o outro
            respostaInput = inputElement;
            observacaoInput = document.querySelector(`[name="observacao-${perguntaId}"]`);
        }

        // Pega os valores
        respostaValue = respostaInput ? respostaInput.value : '';
        observacaoValue = observacaoInput ? observacaoInput.value : '';

        // ===================== CORREÇÃO AQUI =====================
        // Adicionadas crases (`) para `feedback-${perguntaId}`
        const feedbackEl = document.getElementById(`feedback-${perguntaId}`);
        // =========================================================

        if (feedbackEl) {
            feedbackEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
            feedbackEl.className = 'form-text small text-muted';
        } else {
            // Se não encontrar o feedbackEl, loga um erro no console mas continua
            console.warn(`Elemento de feedback 'feedback-${perguntaId}' não encontrado.`);
        }

        try {
            const response = await fetch("{{ url_for('cli.salvar_resposta', id=aplicacao.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    pergunta_id: parseInt(perguntaId),
                    resposta: respostaValue,
                    observacao: observacaoValue
                })
            });

            const data = await response.json();

            if (response.ok && data.sucesso) {
                if (feedbackEl) {
                    feedbackEl.innerHTML = '<i class="fas fa-check me-1"></i>Salvo com sucesso!';
                    feedbackEl.className = 'form-text small text-success';
                }
            } else {
                throw new Error(data.erro || 'Erro desconhecido');
            }

        } catch (error) {
            console.error('Erro ao salvar resposta:', error);
            if (feedbackEl) {
                feedbackEl.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>Falha ao salvar: ${error.message}`;
                feedbackEl.className = 'form-text small text-danger';
            }
        }
    }

    // Confirmação antes de finalizar (para garantir que o usuário não clique sem querer)
    document.getElementById('form-finalizar').addEventListener('submit', function (event) {
        if (!confirm('Tem certeza que deseja finalizar esta aplicação? Você não poderá editá-la depois.')) {
            event.preventDefault();
        }
    });

</script>
{% endblock %}