{% extends "base_cliq.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-3">
            <div class="card sticky-top shadow-sm" style="top: 20px; z-index: 100;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Aplicação</h5>
                </div>
                <div class="card-body">
                    <h6 class="card-title fw-bold text-primary">{{ aplicacao.questionario.nome }}</h6>
                    <ul class="list-unstyled small mb-3">
                        <li class="mb-1"><i class="fas fa-user-tag me-2 text-muted"></i><strong>Avaliado:</strong> {{ aplicacao.avaliado.nome }}</li>
                        <li class="mb-1"><i class="fas fa-user-edit me-2 text-muted"></i><strong>Avaliador:</strong> {{ aplicacao.aplicador.nome }}</li>
                        <li><i class="far fa-clock me-2 text-muted"></i><strong>Início:</strong> {{ aplicacao.data_inicio.strftime('%d/%m/%Y %H:%M') }}</li>
                    </ul>
                    <hr>
                    <div class="d-flex align-items-center text-success small">
                        <i class="fas fa-sync fa-spin me-2"></i>
                        <span>Salvamento automático ativo</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <form id="form-finalizar" action="{{ url_for('cli.finalizar_aplicacao', id=aplicacao.id) }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                {% for topico in topicos %}
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light border-bottom">
                        <h5 class="mb-0 text-dark fw-bold">{{ topico.nome }}</h5>
                        {% if topico.descricao %}
                        <p class="text-muted mb-0 small mt-1">{{ topico.descricao }}</p>
                        {% endif %}
                    </div>
                    <div class="card-body p-2 p-md-3">
                        {% if perguntas_por_topico[topico.id] %}
                        
                            {% for pergunta in perguntas_por_topico[topico.id] %}
                            <div class="mb-3 p-3 border rounded pergunta-container bg-white" 
                                 data-pergunta-id="{{ pergunta.id }}"
                                 {% if pergunta.obrigatoria %}data-obrigatoria="true"{% endif %}>
                                
                                <label class="form-label fw-bold d-block mb-2">
                                    <span class="badge bg-secondary me-1">{{ topico.ordem }}.{{ pergunta.ordem }}</span>
                                    {{ pergunta.texto }}
                                    {% if pergunta.obrigatoria %}
                                        <span class="text-danger" title="Obrigatório">*</span>
                                    {% endif %}
                                </label>
                                
                                {% set resposta_salva = respostas_existentes.get(pergunta.id) %}

                                <div class="resposta-wrapper">
                                    
                                    {% if pergunta.tipo.name == 'SIM_NAO_NA' %}
                                    <div class="d-flex flex-wrap gap-3"> 
                                        {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                        <div class="form-check form-check-inline custom-radio-lg">
                                            <input class="form-check-input" type="radio" name="resposta-{{ pergunta.id }}"
                                                id="opcao-{{ pergunta.id }}-{{ opcao.id }}" value="{{ opcao.texto }}"
                                                data-pergunta-id="{{ pergunta.id }}" onchange="salvarResposta(this)" 
                                                {% if resposta_salva and resposta_salva.resposta==opcao.texto %}checked{% endif %}>
                                            <label class="form-check-label" for="opcao-{{ pergunta.id }}-{{ opcao.id }}">
                                                {{ opcao.texto }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    {% elif pergunta.tipo.name == 'MULTIPLA_ESCOLHA' %}
                                    <select class="form-select" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}" onchange="salvarResposta(this)">
                                        <option value="">Selecione...</option>
                                        {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                        <option value="{{ opcao.texto }}" {% if resposta_salva and resposta_salva.resposta==opcao.texto %}selected{% endif %}>
                                            {{ opcao.texto }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    {% elif pergunta.tipo.name == 'NOTA' or pergunta.tipo.name == 'ESCALA_NUMERICA' or pergunta.tipo.name == 'NUMERO' %}
                                    <input type="number" class="form-control" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                        onblur="salvarResposta(this)" step="any">

                                    {% elif pergunta.tipo.name == 'TEXTO_CURTO' %}
                                    <input type="text" class="form-control" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                        onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'TEXTO_LONGO' %}
                                    <textarea class="form-control" rows="3" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        onblur="salvarResposta(this)">{{ resposta_salva.resposta if resposta_salva else '' }}</textarea>

                                    {% elif pergunta.tipo.name == 'DATA' %}
                                    <input type="date" class="form-control" name="resposta-{{ pergunta.id }}"
                                           data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}" onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'HORA' %}
                                    <input type="time" class="form-control" name="resposta-{{ pergunta.id }}"
                                           data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}" onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'ASSINATURA' %}
                                    <div class="signature-pad-container border rounded bg-light" style="position: relative; height: 200px; width: 100%;">
                                        <canvas id="signature-pad-{{ pergunta.id }}" style="width: 100%; height: 100%; display: block;"></canvas>
                                        <input type="hidden" name="resposta-{{ pergunta.id }}" id="resposta-input-{{ pergunta.id }}"
                                               data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}">
                                        
                                        <button type="button" class="btn btn-sm btn-outline-danger clear-signature-btn" 
                                                data-pergunta-id="{{ pergunta.id }}"
                                                style="position: absolute; bottom: 10px; right: 10px; z-index: 10;">
                                            <i class="fas fa-eraser"></i> Limpar
                                        </button>
                                    </div>
                                    {% if resposta_salva and resposta_salva.resposta %}
                                    <div class="mt-2 text-center" id="preview-assinatura-{{ pergunta.id }}">
                                        <small class="text-success"><i class="fas fa-check-circle"></i> Assinatura Salva</small>
                                    </div>
                                    {% endif %}

                                    {% else %}
                                    <div class="alert alert-warning p-2 small">Tipo {{ pergunta.tipo.name }} não suportado neste formulário.</div>
                                    {% endif %}
                                </div>

                                <div id="feedback-{{ pergunta.id }}" class="form-text small mt-1" style="min-height: 20px;"></div>

                                {% if pergunta.permite_observacao %}
                                <div class="mt-2">
                                    <a class="text-decoration-none small text-muted" data-bs-toggle="collapse" href="#collapseObs{{ pergunta.id }}" role="button">
                                        <i class="far fa-comment-alt"></i> Adicionar Observação
                                    </a>
                                    <div class="collapse {% if resposta_salva and resposta_salva.observacao %}show{% endif %}" id="collapseObs{{ pergunta.id }}">
                                        <textarea class="form-control form-control-sm mt-1" id="obs-{{ pergunta.id }}"
                                            name="observacao-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                            onblur="salvarResposta(this, true)" rows="2" placeholder="Detalhes adicionais...">{{ resposta_salva.observacao if resposta_salva else '' }}</textarea>
                                    </div>
                                </div>
                                {% endif %}

                                {% if pergunta.criterio_foto != 'nenhuma' %}
                                <div class="mt-3 p-3 border border-secondary rounded bg-light foto-container">
                                    <label class="form-label fw-bold text-dark mb-2 d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fas fa-camera text-primary me-1"></i> Evidência Fotográfica
                                        </span>
                                        {% if pergunta.criterio_foto == 'obrigatoria' %}
                                            <span class="badge bg-danger">Obrigatória</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Opcional</span>
                                        {% endif %}
                                    </label>

                                    <div class="input-group">
                                        <input type="file" 
                                               class="form-control" 
                                               id="foto-{{ pergunta.id }}" 
                                               name="foto-{{ pergunta.id }}" 
                                               accept="image/*" 
                                               capture="environment"
                                               data-pergunta-id="{{ pergunta.id }}"
                                               data-resposta-id="{{ resposta_salva.id if resposta_salva else '' }}"
                                               {% if pergunta.criterio_foto == 'obrigatoria' %}data-obrigatoria="true"{% endif %}
                                               onchange="handleFotoUpload(this)">
                                    </div>

                                    <div id="feedback-foto-{{ pergunta.id }}" class="form-text small mt-1"></div>

                                    <div id="container-preview-foto-{{ pergunta.id }}" class="mt-2">
                                        {% if resposta_salva and resposta_salva.caminho_foto %}
                                            <div class="position-relative d-inline-block img-salva-container">
                                                <img src="{{ url_for('cli.get_foto_resposta', filename=resposta_salva.caminho_foto) }}" 
                                                     class="img-thumbnail rounded" 
                                                     style="height: 120px; width: auto; object-fit: cover;">
                                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                            </div>
                            {% endfor %}

                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Nenhuma pergunta neste tópico.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <div class="card mb-5 shadow-sm border-0">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-flag-checkered me-2"></i>Conclusão</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Observações Gerais da Aplicação</label>
                            <textarea class="form-control" name="observacoes_finais" rows="4"
                                placeholder="Resumo geral, intercorrências ou comentários finais...">{{ aplicacao.observacoes_finais or '' }}</textarea>
                        </div>

                        <div class="alert alert-danger d-none" role="alert" id="alerta-validacao">
                            <h6 class="alert-heading fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Impedimento de Envio</h6>
                            <p class="mb-2" id="alerta-validacao-mensagem">Existem pendências obrigatórias:</p>
                            <ul id="alerta-validacao-lista" class="mb-0 small"></ul>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('cli.listar_aplicacoes') }}" class="btn btn-outline-secondary me-md-2">
                                Cancelar e Sair
                            </a>
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="fas fa-check-circle me-2"></i> Finalizar Aplicação
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
    // ========================================================================
    // 1. SALVAR RESPOSTA (Texto, Radio, Select)
    // ========================================================================
    async function salvarResposta(inputElement, isObservacao = false) {
        const perguntaId = inputElement.dataset.perguntaId;
        const feedbackEl = document.getElementById(`feedback-${perguntaId}`);
        const fotoInput = document.getElementById(`foto-${perguntaId}`);

        let respostaValue = '';
        let observacaoValue = '';

        // Identifica os valores
        if (isObservacao) {
            observacaoValue = inputElement.value;
            // Busca a resposta atual para não sobrescrever com vazio
            const respEl = document.querySelector(`[name="resposta-${perguntaId}"]:checked`) || 
                           document.querySelector(`[name="resposta-${perguntaId}"]`);
            if(respEl) respostaValue = respEl.value;
        } else {
            respostaValue = inputElement.value;
            // Busca obs atual
            const obsEl = document.getElementById(`obs-${perguntaId}`);
            if(obsEl) observacaoValue = obsEl.value;
        }

        // Feedback Visual de "Salvando..."
        if (feedbackEl) {
            feedbackEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
            feedbackEl.className = 'form-text small text-muted';
        }

        // Remove borda vermelha de erro se houver
        inputElement.closest('.pergunta-container').classList.remove('border-danger');

        try {
            const response = await fetch("{{ url_for('cli.salvar_resposta', id=aplicacao.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    pergunta_id: parseInt(perguntaId),
                    resposta: respostaValue,
                    observacao: observacaoValue
                })
            });

            const data = await response.json();

            if (response.ok && data.sucesso) {
                if (feedbackEl) {
                    feedbackEl.innerHTML = '<i class="fas fa-check me-1"></i>Salvo';
                    feedbackEl.className = 'form-text small text-success';
                    // Some após 2s
                    setTimeout(() => { feedbackEl.innerHTML = ''; }, 2000);
                }
                
                // Atualiza o ID da resposta no campo de foto (se existir)
                // Isso permite enviar foto logo após responder sem recarregar
                if (fotoInput && data.resposta_id) {
                    fotoInput.dataset.respostaId = data.resposta_id;
                }
            } else {
                throw new Error(data.erro || 'Erro ao processar');
            }

        } catch (error) {
            console.error('Erro:', error);
            if (feedbackEl) {
                feedbackEl.innerHTML = '<span class="text-danger">Erro ao salvar! Tente novamente.</span>';
            }
        }
    }

    // ========================================================================
    // 2. UPLOAD DE FOTO (Mobile Optimized)
    // ========================================================================
    async function handleFotoUpload(fileInput) {
        const perguntaId = fileInput.dataset.perguntaId;
        const respostaId = fileInput.dataset.respostaId;
        const feedbackEl = document.getElementById(`feedback-foto-${perguntaId}`);
        const previewContainer = document.getElementById(`container-preview-foto-${perguntaId}`);

        // Validação: Precisa ter respondido a pergunta antes (para ter um ID de resposta)
        if (!respostaId || respostaId === '') {
            alert("Por favor, responda a pergunta (Sim/Não, Nota, etc) antes de anexar a foto.");
            fileInput.value = ''; // Limpa
            return;
        }

        const file = fileInput.files[0];
        if (!file) return;

        // Feedback de envio
        if (feedbackEl) {
            feedbackEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando foto (' + (file.size/1024/1024).toFixed(2) + 'MB)...';
            feedbackEl.className = 'form-text small text-primary';
        }

        const formData = new FormData();
        formData.append('foto', file);

        try {
            const response = await fetch(`/cli/resposta/${respostaId}/upload-foto`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                body: formData
            });

            const data = await response.json();

            if (response.ok && data.sucesso) {
                if (feedbackEl) {
                    feedbackEl.innerHTML = '<i class="fas fa-check-circle me-1"></i>Foto enviada!';
                    feedbackEl.className = 'form-text small text-success';
                }
                
                // Atualiza Preview
                // Como a URL pode demorar a propagar, usamos FileReader para mostrar a local imediatamente ou recarregamos
                // Opção Simples: Mostrar "Imagem Salva" ou recarregar a div
                previewContainer.innerHTML = `
                    <div class="position-relative d-inline-block">
                        <img src="${URL.createObjectURL(file)}" class="img-thumbnail rounded" style="height: 120px; opacity: 0.8">
                         <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                            <i class="fas fa-check"></i> Nova
                        </span>
                    </div>`;
                
                // Remove erro visual se tivesse
                fileInput.closest('.pergunta-container').classList.remove('border-danger');

            } else {
                throw new Error(data.erro || 'Falha no upload');
            }

        } catch (error) {
            console.error(error);
            if (feedbackEl) {
                feedbackEl.innerHTML = `<span class="text-danger"><i class="fas fa-times"></i> ${error.message}</span>`;
            }
            alert("Erro ao enviar foto: " + error.message + ". Tente uma foto menor ou verifique a conexão.");
        }
    }

    // ========================================================================
    // 3. VALIDAÇÃO ANTES DE ENVIAR
    // ========================================================================
    document.getElementById('form-finalizar').addEventListener('submit', function(e) {
        const alerta = document.getElementById('alerta-validacao');
        const listaErros = document.getElementById('alerta-validacao-lista');
        let erros = [];

        // Limpa estados anteriores
        document.querySelectorAll('.pergunta-container').forEach(el => el.classList.remove('border-danger', 'bg-warning-subtle'));

        // 3.1. Validação de Perguntas Obrigatórias (Texto/Radio/Select)
        document.querySelectorAll('.pergunta-container[data-obrigatoria="true"]').forEach(container => {
            const pid = container.dataset.perguntaId;
            let respondido = false;

            // Checa Radio
            const radioCheck = container.querySelector(`input[type="radio"]:checked`);
            if (radioCheck) respondido = true;

            // Checa Inputs Texto/Number/Date
            const textInput = container.querySelector(`input[type="text"], input[type="number"], input[type="date"], input[type="time"], textarea`);
            if (textInput && textInput.value.trim() !== '') respondido = true;
            
            // Checa Select
            const select = container.querySelector('select');
            if (select && select.value !== '') respondido = true;

            // Checa Assinatura (hidden input)
            const signInput = container.querySelector(`#resposta-input-${pid}`);
            if (signInput && signInput.value.trim() !== '') respondido = true;

            if (!respondido) {
                erros.push(`Pergunta obrigatória não respondida: "${container.querySelector('label').innerText.split('\n')[0]}"`);
                container.classList.add('border-danger', 'bg-warning-subtle');
            }
        });

        // 3.2. Validação de FOTOS Obrigatórias
        document.querySelectorAll('input[type="file"][data-obrigatoria="true"]').forEach(fileInput => {
            const container = fileInput.closest('.pergunta-container');
            const temFotoSalva = container.querySelector('.img-salva-container, .badge.bg-success') !== null;
            
            // Se não selecionou arquivo AGORA e NÃO tem foto salva ANTES
            if (fileInput.files.length === 0 && !temFotoSalva) {
                erros.push(`Foto obrigatória ausente: "${container.querySelector('label').innerText.split('\n')[0]}"`);
                container.classList.add('border-danger', 'bg-warning-subtle');
            }
        });

        if (erros.length > 0) {
            e.preventDefault(); // Bloqueia envio
            
            listaErros.innerHTML = '';
            erros.forEach(erro => {
                const li = document.createElement('li');
                li.innerText = erro;
                listaErros.appendChild(li);
            });

            alerta.classList.remove('d-none');
            alerta.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            // Tudo certo
            if(!confirm("Deseja realmente finalizar a aplicação?")) {
                e.preventDefault();
            }
        }
    });

    // ========================================================================
    // 4. INICIALIZAÇÃO E ASSINATURA DIGITAL
    // ========================================================================
    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa Signature Pads
        const pads = document.querySelectorAll('canvas[id^="signature-pad-"]');
        pads.forEach(canvas => {
            const pid = canvas.id.split('-')[2];
            const hiddenInput = document.getElementById(`resposta-input-${pid}`);
            const parent = canvas.parentElement;

            // Ajusta tamanho do canvas para o container
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;

            const pad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

            // Se já tem assinatura salva, carrega
            if (hiddenInput && hiddenInput.value) {
                pad.fromDataURL(hiddenInput.value);
            }

            // Ao terminar traço, salva no hidden e envia
            pad.addEventListener("endStroke", () => {
                if (!pad.isEmpty()) {
                    hiddenInput.value = pad.toDataURL();
                    salvarResposta(hiddenInput); // Reusa a lógica de salvar
                }
            });

            // Botão Limpar
            const btnClear = parent.querySelector('.clear-signature-btn');
            if (btnClear) {
                btnClear.addEventListener('click', () => {
                    pad.clear();
                    hiddenInput.value = '';
                    salvarResposta(hiddenInput);
                });
            }
            
            // Redimensionamento responsivo
            window.addEventListener('resize', () => {
                // Nota: Redimensionar limpa o canvas. Em prod, ideal é salvar imagem e redesenhar.
                // Aqui mantemos simples.
            });
        });
    });
    function atualizarRegraFoto(radio) {
        // O name do radio é "resposta-ID" (ex: resposta-105). Pegamos o ID.
        const parts = radio.name.split('-');
        if (parts.length < 2) return;
        const pid = parts[1];

        const fileInput = document.getElementById(`foto-${pid}`);
        // Procura o label para adicionar o asterisco visual
        // Tenta achar pelo 'for' ou pega o label próximo
        let labelFoto = document.querySelector(`label[for="foto-${pid}"]`);
        
        // Fallback: se não achar pelo 'for', tenta achar dentro do container de foto
        if (!labelFoto && fileInput) {
            const container = fileInput.closest('.mb-2') || fileInput.parentElement;
            if(container) labelFoto = container.querySelector('label');
        }

        if (!fileInput) return;

        const valor = radio.value.toLowerCase();

        // Lógica: Se for "nao" ou "nc" -> Foto Obrigatória
        if (valor === 'nao' || valor === 'nc') {
            // 1. Ativa a flag que o seu validador (Seção 3.2) procura
            fileInput.setAttribute('data-obrigatoria', 'true');
            
            // 2. Feedback Visual (Texto Vermelho)
            if (labelFoto && !labelFoto.innerHTML.includes('(Obrigatória)')) {
                labelFoto.originalText = labelFoto.innerHTML; // Salva texto original
                labelFoto.innerHTML += ' <span class="text-danger fw-bold small">* (Foto Obrigatória)</span>';
            }
            // Adiciona borda vermelha suave no input para destacar
            fileInput.classList.add('border', 'border-danger');

        } else {
            // 1. Remove a obrigatoriedade
            fileInput.setAttribute('data-obrigatoria', 'false');
            
            // 2. Remove Feedback Visual
            if (labelFoto && labelFoto.innerHTML.includes('(Obrigatória)')) {
                // Remove o span de erro mantendo o ícone/texto original
                const spanErro = labelFoto.querySelector('.text-danger');
                if(spanErro) spanErro.remove();
            }
            fileInput.classList.remove('border', 'border-danger');
        }
    }

    // Inicializa os ouvintes (Listeners)
    document.addEventListener("DOMContentLoaded", function() {
        const todosRadios = document.querySelectorAll('input[type="radio"]');

        todosRadios.forEach(radio => {
            // A. Quando o usuário clica/muda a opção
            radio.addEventListener('change', function() {
                atualizarRegraFoto(this);
                // Se o radio já tiver onchange="salvarResposta(this)" no HTML, 
                // ele vai salvar e depois rodar essa regra visual. Tudo certo.
            });

            // B. Ao carregar a página (para aplicar a regra em respostas já salvas/carregadas)
            if (radio.checked) {
                atualizarRegraFoto(radio);
            }
        });
    });
</script>
{% endblock %}