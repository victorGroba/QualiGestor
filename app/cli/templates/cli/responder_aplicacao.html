{% extends "base_cliq.html" %}

{% block content %}
<div id="sync-alert" class="alert alert-info d-none position-fixed top-0 start-50 translate-middle-x mt-3 shadow" style="z-index: 9999; min-width: 300px;">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-3" role="status"></div>
        <span id="sync-message">Sincronizando dados offline...</span>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="row">
        <div class="col-lg-3 mb-4">
            <div class="card sticky-top shadow-sm" style="top: 20px; z-index: 100;">
                <div class="card-header {{ 'bg-success' if modo_assinatura else 'bg-primary' }} text-white">
                    <h5 class="mb-0 fs-6">
                        {% if modo_assinatura %}
                            <i class="fas fa-file-signature me-2"></i>Fase de Assinatura
                        {% else %}
                            <i class="fas fa-clipboard-check me-2"></i>Status da Aplicação
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <h6 class="card-title fw-bold text-primary">{{ aplicacao.questionario.nome }}</h6>
                    <ul class="list-unstyled small mb-3 text-muted">
                        <li class="mb-1"><i class="fas fa-store me-2"></i>{{ aplicacao.avaliado.nome }}</li>
                        <li class="mb-1"><i class="fas fa-user me-2"></i>{{ aplicacao.aplicador.nome if aplicacao.aplicador else 'Desconhecido' }}</li>
                        <li><i class="far fa-clock me-2"></i>{{ aplicacao.data_inicio.strftime('%d/%m/%Y %H:%M') }}</li>
                    </ul>
                    <hr>
                    <div id="status-conexao" class="d-flex align-items-center text-success small fw-bold">
                        <i class="fas fa-wifi me-2"></i>
                        <span id="status-texto">Online</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <form id="form-finalizar" 
                  action="{{ url_for('cli.finalizar_definitivamente', id=aplicacao.id) if modo_assinatura else url_for('cli.concluir_coleta', id=aplicacao.id) }}" 
                  method="POST" enctype="multipart/form-data">
                
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                {% for topico in topicos %}
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light border-bottom py-3">
                        <h5 class="mb-0 text-dark fw-bold">{{ topico.nome }}</h5>
                        {% if topico.descricao %}
                        <p class="text-muted mb-0 small mt-1">{{ topico.descricao }}</p>
                        {% endif %}
                    </div>
                    <div class="card-body p-2 p-md-3">
                        {% if perguntas_por_topico[topico.id] %}
                        
                            {% for pergunta in perguntas_por_topico[topico.id] %}
                            
                            {% set eh_assinatura = (pergunta.tipo.name == 'ASSINATURA') %}
                            {% set deve_validar = (pergunta.obrigatoria and (not eh_assinatura or modo_assinatura)) %}

                            <div class="mb-3 p-3 border rounded pergunta-container bg-white transition-all" 
                                 id="container-pergunta-{{ pergunta.id }}"
                                 data-pergunta-id="{{ pergunta.id }}"
                                 data-tipo="{{ pergunta.tipo.name }}"
                                 {% if deve_validar %}data-obrigatoria="true"{% endif %}>
                                
                                <label class="form-label fw-bold d-block mb-2 text-dark">
                                    <span class="badge bg-secondary me-1">{{ topico.ordem }}.{{ pergunta.ordem }}</span>
                                    {{ pergunta.texto }}
                                    {% if pergunta.obrigatoria %}
                                        <span class="text-danger" title="Obrigatório">*</span>
                                    {% endif %}
                                </label>
                                
                                {% set resposta_salva = respostas_existentes.get(pergunta.id) %}

                                <div class="resposta-wrapper">
                                    
                                    {% if pergunta.tipo.name == 'SIM_NAO_NA' %}
                                    <div class="d-flex flex-wrap gap-3"> 
                                        {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                        <div class="form-check form-check-inline custom-radio-lg">
                                            <input class="form-check-input input-conforme" type="radio" name="resposta-{{ pergunta.id }}"
                                                id="opcao-{{ pergunta.id }}-{{ opcao.id }}" value="{{ opcao.texto }}"
                                                data-pergunta-id="{{ pergunta.id }}" onchange="verificarConformidade(this)" 
                                                {% if resposta_salva and resposta_salva.resposta==opcao.texto %}checked{% endif %}>
                                            <label class="form-check-label" for="opcao-{{ pergunta.id }}-{{ opcao.id }}">
                                                {{ opcao.texto }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    {% elif pergunta.tipo.name == 'MULTIPLA_ESCOLHA' %}
                                    <select class="form-select input-conforme" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}" onchange="verificarConformidade(this)">
                                        <option value="">Selecione...</option>
                                        {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                        <option value="{{ opcao.texto }}" {% if resposta_salva and resposta_salva.resposta==opcao.texto %}selected{% endif %}>
                                            {{ opcao.texto }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    {% elif pergunta.tipo.name in ['NOTA', 'ESCALA_NUMERICA', 'NUMERO'] %}
                                    <input type="number" class="form-control" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                        onblur="salvarResposta(this)" step="any">

                                    {% elif pergunta.tipo.name == 'TEXTO_CURTO' %}
                                    <input type="text" class="form-control" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                        onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'TEXTO_LONGO' %}
                                    <textarea class="form-control" rows="3" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        onblur="salvarResposta(this)">{{ resposta_salva.resposta if resposta_salva else '' }}</textarea>

                                    {% elif pergunta.tipo.name == 'DATA' %}
                                    <input type="date" class="form-control" name="resposta-{{ pergunta.id }}"
                                           data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}" onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'HORA' %}
                                    <input type="time" class="form-control" name="resposta-{{ pergunta.id }}"
                                           data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}" onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'ASSINATURA' %}
                                    <div class="card bg-light border text-center p-3">
                                        <label class="small text-muted mb-2">Toque abaixo para assinar:</label>
                                        
                                        <div id="preview-box-{{ pergunta.id }}" 
                                             class="mb-3 d-flex justify-content-center align-items-center rounded bg-white" 
                                             style="min-height: 120px; border: 2px dashed #dee2e6; overflow: hidden;">
                                            
                                            {% if resposta_salva and resposta_salva.resposta %}
                                                <img src="{{ resposta_salva.resposta }}" id="img-preview-{{ pergunta.id }}" style="max-height: 110px; max-width: 100%;">
                                                <span id="placeholder-{{ pergunta.id }}" class="text-muted small d-none">Nenhuma assinatura</span>
                                            {% else %}
                                                <img src="" id="img-preview-{{ pergunta.id }}" style="max-height: 110px; max-width: 100%; display: none;">
                                                <span id="placeholder-{{ pergunta.id }}" class="text-muted small">Nenhuma assinatura</span>
                                            {% endif %}
                                        </div>

                                        <input type="hidden" name="resposta-{{ pergunta.id }}" id="resposta-input-{{ pergunta.id }}"
                                               data-pergunta-id="{{ pergunta.id }}" 
                                               value="{{ resposta_salva.resposta if resposta_salva else '' }}">

                                        <button type="button" class="btn btn-outline-primary w-100 py-2" 
                                                onclick="abrirModalAssinatura({{ pergunta.id }}, '{{ pergunta.texto|escape }}')">
                                            <i class="fas fa-pen-nib me-2"></i> Abrir Painel de Assinatura
                                        </button>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-warning p-2 small">Tipo {{ pergunta.tipo.name }} não suportado.</div>
                                    {% endif %}
                                </div>

                                <div id="feedback-{{ pergunta.id }}" class="form-text small mt-1" style="min-height: 20px;"></div>

                                {% if pergunta.permite_observacao %}
                                <div class="mt-2">
                                    <a class="text-decoration-none small text-muted link-obs-toggle" 
                                       data-bs-toggle="collapse" 
                                       href="#collapseObs{{ pergunta.id }}" 
                                       id="btn-obs-{{ pergunta.id }}"
                                       role="button">
                                        <i class="far fa-comment-alt"></i> Adicionar Observação
                                    </a>
                                    <div class="collapse {% if (resposta_salva and resposta_salva.observacao) %}show{% endif %}" id="collapseObs{{ pergunta.id }}">
                                        <textarea class="form-control form-control-sm mt-1" id="obs-{{ pergunta.id }}"
                                            name="observacao-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                            onblur="salvarResposta(this, true)" rows="2" 
                                            placeholder="Descreva o que houve (obrigatório se Não Conforme)...">{{ resposta_salva.observacao if resposta_salva else '' }}</textarea>
                                    </div>
                                </div>
                                {% endif %}

                                {% if pergunta.criterio_foto != 'nenhuma' %}
                                <div class="mt-3 p-3 border border-secondary rounded bg-light foto-container" id="foto-container-{{ pergunta.id }}">
                                    <label class="form-label fw-bold text-dark mb-2 d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-camera text-primary me-1"></i> Evidências</span>
                                        <span class="badge {% if pergunta.criterio_foto == 'obrigatoria' %}bg-secondary{% else %}bg-secondary{% endif %} badge-status-foto">
                                            {% if pergunta.criterio_foto == 'obrigatoria' %}Obrigatória{% else %}Opcional{% endif %}
                                        </span>
                                    </label>

                                    <div class="mb-2">
                                        <label for="input-foto-{{ pergunta.id }}" class="btn btn-outline-primary btn-sm w-100 cursor-pointer">
                                            <i class="fas fa-plus-circle me-1"></i> Adicionar Foto
                                        </label>
                                        <input type="file" 
                                               class="d-none" 
                                               id="input-foto-{{ pergunta.id }}" 
                                               accept="image/*" 
                                               capture="environment"
                                               data-pergunta-id="{{ pergunta.id }}"
                                               data-criterio-original="{{ pergunta.criterio_foto }}"
                                               {% if pergunta.criterio_foto == 'obrigatoria' %}data-obrigatoria="true"{% endif %}
                                               onchange="handleFotoUpload(this)">
                                    </div>

                                    <div id="galeria-fotos-{{ pergunta.id }}" class="d-flex flex-wrap gap-2 mt-2">
                                        
                                        {% if resposta_salva and resposta_salva.fotos %}
                                            {% for foto in resposta_salva.fotos %}
                                            <div class="position-relative d-inline-block foto-item" id="foto-server-{{ foto.id }}">
                                                <img src="{{ url_for('cli.get_foto_resposta', filename=foto.caminho) }}" 
                                                     class="img-thumbnail rounded" 
                                                     style="height: 100px; width: 100px; object-fit: cover;"
                                                     onclick="window.open(this.src, '_blank')">
                                                
                                                <button type="button" 
                                                        class="btn btn-danger btn-sm position-absolute top-0 end-0 translate-middle rounded-circle p-0 d-flex align-items-center justify-content-center shadow-sm"
                                                        style="width: 24px; height: 24px;"
                                                        onclick="deletarFotoServidor({{ foto.id }})">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                        
                                    </div>
                                    <div id="feedback-foto-{{ pergunta.id }}" class="form-text small mt-1"></div>
                                </div>
                                {% endif %}
                                
                            </div>
                            {% endfor %}

                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Nenhuma pergunta neste tópico.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <div class="card mb-5 shadow-sm border-0" id="card-conclusao">
                    <div class="card-header {{ 'bg-success' if modo_assinatura else 'bg-secondary' }} text-white">
                        <h5 class="mb-0">
                            {% if modo_assinatura %}
                                <i class="fas fa-file-signature me-2"></i>Assinatura e Encerramento
                            {% else %}
                                <i class="fas fa-step-forward me-2"></i>Conclusão da Coleta
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Observações Gerais</label>
                            <textarea class="form-control" name="observacoes_finais" rows="4"
                                placeholder="Resumo geral, intercorrências ou comentários preliminares...">{{ aplicacao.observacoes_finais or '' }}</textarea>
                        </div>

                        <div class="alert alert-danger d-none shadow-sm" role="alert" id="alerta-validacao">
                            <h6 class="alert-heading fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Impedimento de Envio</h6>
                            <p class="mb-2">Por favor, corrija os itens abaixo:</p>
                            <ul id="alerta-validacao-lista" class="mb-0 small ps-3"></ul>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('cli.listar_aplicacoes') }}" class="btn btn-outline-secondary me-md-2">
                                Cancelar
                            </a>
                            
                            {% if modo_assinatura %}
                                <button type="submit" class="btn btn-success btn-lg px-5 w-100">
                                    <i class="fas fa-check-double me-2"></i> Finalizar Definitivamente
                                </button>
                            {% else %}
                                <button type="submit" class="btn btn-primary btn-lg px-5">
                                    <i class="fas fa-arrow-right me-2"></i> Concluir Coleta e Revisar
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAssinaturaUnico" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-signature me-2"></i>Assinar: <span id="titulo-modal-assinatura"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 bg-light" style="position: relative;">
                <canvas id="canvas-unico" style="width: 100%; height: 350px; touch-action: none; display: block;"></canvas>
                
                <div class="text-center text-muted small position-absolute bottom-0 w-100 mb-2 pe-none">
                    Assine na área acima (Dedo ou Caneta)
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-danger" onclick="limparCanvasAtual()">
                    <i class="fas fa-eraser"></i> Limpar
                </button>
                <button type="button" class="btn btn-success px-4" onclick="confirmarAssinaturaModal()">
                    <i class="fas fa-check me-2"></i> Confirmar Assinatura
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
    // 1. Banco de Dados Offline
    const dbLocal = new Dexie("QualiGestorOffline");
    dbLocal.version(1).stores({
        fotos: 'id, pergunta_id, resposta_id, blob, nome, timestamp'
    });

    // 2. Variáveis de Assinatura
    let signaturePadGlobal = null;
    let currentPerguntaId = null;
    const modalElement = document.getElementById('modalAssinaturaUnico');
    const bsModal = new bootstrap.Modal(modalElement);
    
    // Variável que vem do Python para saber em qual fase estamos
    const MODO_ASSINATURA = {{ 'true' if modo_assinatura else 'false' }};

    // 3. Inicialização
    window.addEventListener('online', () => { atualizarUIConexao(true); sincronizarPendencias(); });
    window.addEventListener('offline', () => { atualizarUIConexao(false); });

    document.addEventListener('DOMContentLoaded', () => {
        atualizarUIConexao(navigator.onLine);
        restaurarBadgesPendentes();
        if(navigator.onLine) setTimeout(sincronizarPendencias, 1500);
        
        // --- Setup do Canvas Único ---
        const canvas = document.getElementById('canvas-unico');
        signaturePadGlobal = new SignaturePad(canvas, {
            backgroundColor: 'rgba(255, 255, 255, 1)', 
            penColor: "rgb(0, 0, 0)",
            velocityFilterWeight: 0.7
        });

        modalElement.addEventListener('shown.bs.modal', () => {
            resizeCanvas();
            // Carrega assinatura anterior se houver
            const inputAtual = document.getElementById(`resposta-input-${currentPerguntaId}`);
            if (inputAtual && inputAtual.value) {
                signaturePadGlobal.fromDataURL(inputAtual.value);
            }
        });

        // Verifica conformidade inicial
        document.querySelectorAll('.input-conforme').forEach(el => {
            if(el.type === 'radio' && el.checked) verificarConformidade(el);
            if(el.tagName === 'SELECT' && el.value) verificarConformidade(el);
        });

        // Se estiver no modo assinatura, rola para o final automaticamente
        if (MODO_ASSINATURA) {
            setTimeout(() => {
                const conclusao = document.getElementById('card-conclusao');
                if(conclusao) conclusao.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 600);
        }
    });

    // ========================================================================
    // FUNÇÕES DE ASSINATURA (MODAL)
    // ========================================================================
    window.abrirModalAssinatura = function(perguntaId, tituloPergunta) {
        currentPerguntaId = perguntaId;
        document.getElementById('titulo-modal-assinatura').innerText = tituloPergunta;
        signaturePadGlobal.clear();
        bsModal.show();
    };

    function resizeCanvas() {
        const canvas = document.getElementById('canvas-unico');
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
    }

    window.limparCanvasAtual = function() {
        signaturePadGlobal.clear();
    };

    window.confirmarAssinaturaModal = function() {
        if (signaturePadGlobal.isEmpty()) {
            if(!confirm("Deseja confirmar sem assinatura (em branco)?")) return;
            salvarDadosAssinatura('');
        } else {
            const dataUrl = signaturePadGlobal.toDataURL("image/png");
            salvarDadosAssinatura(dataUrl);
        }
        bsModal.hide();
    };

    function salvarDadosAssinatura(dataUrl) {
        const input = document.getElementById(`resposta-input-${currentPerguntaId}`);
        const imgPreview = document.getElementById(`img-preview-${currentPerguntaId}`);
        const placeholder = document.getElementById(`placeholder-${currentPerguntaId}`);

        input.value = dataUrl;

        if (dataUrl) {
            imgPreview.src = dataUrl;
            imgPreview.style.display = 'block';
            placeholder.classList.add('d-none');
        } else {
            imgPreview.src = '';
            imgPreview.style.display = 'none';
            placeholder.classList.remove('d-none');
        }
        salvarResposta(input);
    }

    // ========================================================================
    // LÓGICA DE CONFORMIDADE
    // ========================================================================
    function verificarConformidade(inputElement) {
        salvarResposta(inputElement);

        const pid = inputElement.getAttribute('data-pergunta-id');
        const valor = inputElement.value.toLowerCase().trim();
        const container = document.getElementById(`container-pergunta-${pid}`);
        
        const isNC = ['não', 'nao', '0', 'ruim', 'irregular', 'não conforme'].includes(valor);

        const fotoInput = document.getElementById(`input-foto-${pid}`); 
        const obsInput = document.getElementById(`obs-${pid}`);
        const obsCollapse = document.getElementById(`collapseObs${pid}`);
        const obsLink = document.getElementById(`btn-obs-${pid}`);
        const fotoBadge = container.querySelector('.badge-status-foto');

        if (isNC) {
            container.classList.add('border-danger', 'border-2');
            
            // Foto Obrigatória
            if (fotoInput) {
                const criterioOriginal = fotoInput.getAttribute('data-criterio-original');
                
                if (criterioOriginal === 'obrigatoria') {
                    fotoInput.setAttribute('data-obrigatoria', 'true');
                    if (fotoBadge) {
                        fotoBadge.className = 'badge bg-danger badge-status-foto';
                        fotoBadge.innerText = 'Obrigatória (NC)';
                    }
                } else {
                    fotoInput.setAttribute('data-obrigatoria', 'false');
                     if (fotoBadge) {
                        fotoBadge.className = 'badge bg-secondary badge-status-foto';
                        fotoBadge.innerText = 'Opcional';
                    }
                }
            }

            // Obs Obrigatória
            if (obsInput) {
                obsInput.setAttribute('data-obrigatoria', 'true');
                obsInput.placeholder = "Descreva o problema (Obrigatório para NC)...";
                if (obsCollapse && !obsCollapse.classList.contains('show')) {
                    new bootstrap.Collapse(obsCollapse, { toggle: true, show: true });
                }
                if (obsLink) obsLink.classList.add('text-danger', 'fw-bold');
            }

        } else {
            container.classList.remove('border-danger', 'border-2');

            if (fotoInput) {
                fotoInput.setAttribute('data-obrigatoria', 'false'); 
                if (fotoBadge) {
                    fotoBadge.className = 'badge bg-secondary badge-status-foto';
                    fotoBadge.innerText = 'Opcional';
                }
            }

            if (obsInput) {
                obsInput.setAttribute('data-obrigatoria', 'false');
                obsInput.placeholder = "Detalhes adicionais...";
                if (obsLink) obsLink.classList.remove('text-danger', 'fw-bold');
            }
        }
    }

    // ========================================================================
    // SALVAR TEXTO
    // ========================================================================
    async function salvarResposta(inputElement, isObservacao = false) {
        const perguntaId = parseInt(inputElement.dataset.perguntaId); 
        const feedbackEl = document.getElementById(`feedback-${perguntaId}`);
        const fotoInput = document.getElementById(`input-foto-${perguntaId}`);

        let respostaValue = '';
        let observacaoValue = '';

        if (isObservacao) {
            observacaoValue = inputElement.value;
            const radio = document.querySelector(`input[name="resposta-${perguntaId}"]:checked`);
            const select = document.querySelector(`select[name="resposta-${perguntaId}"]`);
            const text = document.querySelector(`input[type=text][name="resposta-${perguntaId}"]`) || document.querySelector(`textarea[name="resposta-${perguntaId}"]`);
            
            if(radio) respostaValue = radio.value;
            else if(select) respostaValue = select.value;
            else if(text) respostaValue = text.value;
        } else {
            respostaValue = inputElement.value;
            const obsEl = document.getElementById(`obs-${perguntaId}`);
            if(obsEl) observacaoValue = obsEl.value;
        }

        if (feedbackEl) feedbackEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';

        const dados = {
            pergunta_id: perguntaId,
            resposta: respostaValue,
            observacao: observacaoValue,
            timestamp: Date.now()
        };

        try {
            const res = await fetch("{{ url_for('cli.salvar_resposta', id=aplicacao.id) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify(dados)
            });
            const data = await res.json();

            if (data.sucesso) {
                if (feedbackEl) {
                    feedbackEl.innerHTML = '<span class="text-success"><i class="fas fa-check"></i> Salvo</span>';
                    setTimeout(() => feedbackEl.innerHTML = '', 2000);
                }
                if (data.resposta_id) {
                    if (fotoInput) fotoInput.dataset.respostaId = data.resposta_id;
                    await dbLocal.fotos.filter(f => f.pergunta_id == perguntaId).modify({ resposta_id: data.resposta_id });
                }
            } else { throw new Error(); }
        } catch (error) {
            let fila = JSON.parse(localStorage.getItem('fila_respostas_offline') || '[]');
            fila = fila.filter(i => i.pergunta_id !== perguntaId);
            fila.push(dados);
            localStorage.setItem('fila_respostas_offline', JSON.stringify(fila));
            if (feedbackEl) feedbackEl.innerHTML = '<span class="text-warning"><i class="fas fa-sd-card"></i> Salvo no dispositivo</span>';
        }
    }

    // ========================================================================
    // UPLOAD MÚLTIPLO DE FOTOS
    // ========================================================================
    async function handleFotoUpload(fileInput) {
        const perguntaId = parseInt(fileInput.dataset.perguntaId);
        let respostaId = fileInput.dataset.respostaId || document.querySelector(`[name="resposta-${perguntaId}"]`)?.dataset.respostaId;
        
        if(!respostaId) {
           await salvarResposta(document.querySelector(`[name="resposta-${perguntaId}"]`) || {value:'', dataset:{perguntaId:perguntaId}});
           respostaId = document.querySelector(`[name="resposta-${perguntaId}"]`)?.dataset.respostaId || fileInput.dataset.respostaId;
        }

        const file = fileInput.files[0];
        if (!file) return;

        const tempId = Date.now();
        const galeria = document.getElementById(`galeria-fotos-${perguntaId}`);
        
        const div = document.createElement('div');
        div.id = `foto-local-${tempId}`;
        div.className = 'position-relative d-inline-block foto-item me-2 mb-2 fade-in';
        div.innerHTML = `
            <img src="${URL.createObjectURL(file)}" class="img-thumbnail rounded" style="height: 100px; width: 100px; object-fit: cover; opacity: 0.7">
            <button onclick="deletarFotoLocal(${tempId})" type="button" class="btn btn-secondary btn-sm position-absolute top-0 end-0 translate-middle rounded-circle p-0 d-flex align-items-center justify-content-center" style="width:24px;height:24px;">
                <i class="fas fa-times" style="font-size:10px"></i>
            </button>
            <span id="badge-${tempId}" class="position-absolute bottom-0 end-0 badge bg-warning p-1 border border-white">
                <i class="fas fa-sync fa-spin"></i>
            </span>
        `;
        galeria.appendChild(div);

        fileInput.value = '';

        await dbLocal.fotos.add({
            id: tempId,
            pergunta_id: perguntaId,
            resposta_id: respostaId || null,
            blob: file,
            nome: file.name,
            timestamp: Date.now()
        });

        if (navigator.onLine && respostaId) {
            enviarFoto(file, respostaId, perguntaId, tempId);
        } else {
            const badge = document.getElementById(`badge-${tempId}`);
            if(badge) {
                badge.className = "position-absolute bottom-0 end-0 badge bg-warning p-1";
                badge.innerHTML = '<i class="fas fa-sd-card"></i>';
            }
        }
    }

    async function enviarFoto(file, respostaId, perguntaId, tempId) {
        const formData = new FormData();
        formData.append('foto', file);
        
        try {
            const res = await fetch(`/cli/resposta/${respostaId}/upload-foto`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                body: formData
            });
            const data = await res.json();
            
            if (data.sucesso) {
                await dbLocal.fotos.delete(tempId);
                const el = document.getElementById(`foto-local-${tempId}`);
                if(el) {
                    el.innerHTML = `
                        <img src="${URL.createObjectURL(file)}" class="img-thumbnail rounded" style="height: 100px; width: 100px; object-fit: cover;">
                        <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 translate-middle rounded-circle p-0 d-flex align-items-center justify-content-center shadow-sm" style="width: 24px; height: 24px;" onclick="deletarFotoServidor(${data.foto_id})">
                            <i class="fas fa-times"></i>
                        </button>
                        <span class="position-absolute bottom-0 end-0 badge bg-success p-1 border border-white"><i class="fas fa-check"></i></span>
                    `;
                    el.id = `foto-server-${data.foto_id}`;
                }
                return true;
            }
            throw new Error();
        } catch (e) {
            console.error(e);
            const badge = document.getElementById(`badge-${tempId}`);
            if(badge) {
                badge.className = "position-absolute bottom-0 end-0 badge bg-danger p-1";
                badge.innerHTML = '<i class="fas fa-exclamation"></i>';
            }
            return false;
        }
    }

    async function deletarFotoServidor(fotoId) {
        if(!confirm('Tem certeza que deseja excluir esta evidência?')) return;
        const el = document.getElementById(`foto-server-${fotoId}`);
        if(el) el.style.opacity = '0.5';

        try {
            const res = await fetch(`/cli/foto/${fotoId}/deletar`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
            });
            const data = await res.json();
            
            if(data.sucesso) {
                if(el) el.remove();
            } else {
                alert('Erro ao excluir: ' + (data.erro || 'Desconhecido'));
                if(el) el.style.opacity = '1';
            }
        } catch(e) {
            alert('Erro de conexão ao excluir.');
            if(el) el.style.opacity = '1';
        }
    }

    async function deletarFotoLocal(tempId) {
        if(!confirm("Remover esta foto pendente?")) return;
        const el = document.getElementById(`foto-local-${tempId}`);
        if(el) el.remove();
        await dbLocal.fotos.delete(tempId);
    }

    async function sincronizarPendencias() {
        const filaTexto = JSON.parse(localStorage.getItem('fila_respostas_offline') || '[]');
        const fotosOffline = await dbLocal.fotos.toArray();
        if (filaTexto.length === 0 && fotosOffline.length === 0) return;

        const alertSync = document.getElementById('sync-alert');
        if(alertSync) alertSync.classList.remove('d-none');

        for (let item of filaTexto) {
            try {
                const res = await fetch("{{ url_for('cli.salvar_resposta', id=aplicacao.id) }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                    body: JSON.stringify(item)
                });
                const data = await res.json();
                if (data.sucesso && data.resposta_id) {
                    await dbLocal.fotos.filter(f => f.pergunta_id == item.pergunta_id).modify({ resposta_id: data.resposta_id });
                }
            } catch (e) {}
        }
        localStorage.removeItem('fila_respostas_offline');

        const fotosAtualizadas = await dbLocal.fotos.toArray();
        for (let foto of fotosAtualizadas) {
            if (foto.resposta_id) {
                await enviarFoto(foto.blob, foto.resposta_id, foto.pergunta_id, foto.id);
            }
        }

        if(alertSync) setTimeout(() => alertSync.classList.add('d-none'), 2000);
    }

    async function restaurarBadgesPendentes() {
        const pendentes = await dbLocal.fotos.toArray();
        pendentes.forEach(f => {
            const galeria = document.getElementById(`galeria-fotos-${f.pergunta_id}`);
            if (galeria && !document.getElementById(`foto-local-${f.id}`)) {
                const div = document.createElement('div');
                div.id = `foto-local-${f.id}`;
                div.className = 'position-relative d-inline-block foto-item me-2 mb-2';
                div.innerHTML = `
                    <img src="${URL.createObjectURL(f.blob)}" class="img-thumbnail rounded" style="height: 100px; width: 100px; object-fit: cover; opacity: 0.6">
                    <button onclick="deletarFotoLocal(${f.id})" type="button" class="btn btn-secondary btn-sm position-absolute top-0 end-0 translate-middle rounded-circle p-0 d-flex align-items-center justify-content-center" style="width:24px;height:24px;"><i class="fas fa-times" style="font-size:10px"></i></button>
                    <span class="position-absolute bottom-0 end-0 badge bg-warning p-1"><i class="fas fa-clock"></i></span>
                `;
                galeria.appendChild(div);
            }
        });
    }

    function atualizarUIConexao(online) {
        const txt = document.getElementById('status-texto');
        const icon = document.getElementById('status-conexao');
        if(online) {
            icon.className = 'd-flex align-items-center text-success small fw-bold';
            txt.innerText = 'Online - Sincronizado';
        } else {
            icon.className = 'd-flex align-items-center text-warning small fw-bold';
            txt.innerText = 'Offline - Salvando Localmente';
        }
    }

    // VALIDAÇÃO E ENVIO
    document.getElementById('form-finalizar').addEventListener('submit', function(e) {
        const alerta = document.getElementById('alerta-validacao');
        const lista = document.getElementById('alerta-validacao-lista');
        let erros = [];

        // 1. Perguntas Obrigatórias
        document.querySelectorAll('.pergunta-container[data-obrigatoria="true"]').forEach(el => {
            const pid = el.dataset.perguntaId;
            const val = el.querySelector(`input[name="resposta-${pid}"]`)?.value || 
                        el.querySelector(`textarea[name="resposta-${pid}"]`)?.value ||
                        el.querySelector(`select[name="resposta-${pid}"]`)?.value ||
                        el.querySelector('input:checked')?.value;
            
            if (!val || val === "") {
                erros.push(`Pergunta não respondida: ${el.querySelector('label').innerText.split('\n')[0]}`);
                el.classList.add('border-danger');
            }
        });

        // 2. Fotos Obrigatórias
        document.querySelectorAll('input[type="file"][data-obrigatoria="true"]').forEach(inp => {
            const pid = inp.dataset.perguntaId;
            const container = inp.closest('.pergunta-container');
            const galeria = document.getElementById(`galeria-fotos-${pid}`);
            const temFoto = galeria && galeria.children.length > 0;

            if (!temFoto) {
                erros.push(`Foto obrigatória faltando em: ${container.querySelector('label').innerText.split('\n')[0]}`);
                container.classList.add('border-danger');
            }
        });

        // 3. Observações Obrigatórias
        document.querySelectorAll('textarea[data-obrigatoria="true"]').forEach(obs => {
            if (!obs.value.trim()) {
                const container = obs.closest('.pergunta-container');
                erros.push(`Observação obrigatória faltando em: ${container.querySelector('label').innerText.split('\n')[0]}`);
                container.classList.add('border-danger');
            }
        });

        if (erros.length > 0) {
            e.preventDefault();
            lista.innerHTML = erros.map(err => `<li>${err}</li>`).join('');
            alerta.classList.remove('d-none');
            alerta.scrollIntoView({block: 'center'});
        } else {
            // MENSAGEM DIFERENTE DEPENDENDO DA FASE
            let msg = MODO_ASSINATURA 
                ? "Confirma a Assinatura e a Finalização DEFINITIVA desta auditoria?" 
                : "Confirma o encerramento da coleta? Você irá para a etapa de Revisão.";
                
            if(!confirm(msg)) e.preventDefault();
        }
    });
</script>
{% endblock %}