{% extends "base_cliq.html" %}

{% block content %}
<div id="sync-alert" class="alert alert-info d-none position-fixed top-0 start-50 translate-middle-x mt-3 shadow" style="z-index: 9999; min-width: 300px;">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-3" role="status"></div>
        <span id="sync-message">Sincronizando dados offline...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-3">
            <div class="card sticky-top shadow-sm" style="top: 20px; z-index: 100;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Aplicação</h5>
                </div>
                <div class="card-body">
                    <h6 class="card-title fw-bold text-primary">{{ aplicacao.questionario.nome }}</h6>
                    <ul class="list-unstyled small mb-3">
                        <li class="mb-1"><i class="fas fa-user-tag me-2 text-muted"></i><strong>Avaliado:</strong> {{ aplicacao.avaliado.nome }}</li>
                        <li class="mb-1"><i class="fas fa-user-edit me-2 text-muted"></i><strong>Avaliador:</strong> {{ aplicacao.aplicador.nome }}</li>
                        <li><i class="far fa-clock me-2 text-muted"></i><strong>Início:</strong> {{ aplicacao.data_inicio.strftime('%d/%m/%Y %H:%M') }}</li>
                    </ul>
                    <hr>
                    <div id="status-conexao" class="d-flex align-items-center text-success small">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="status-texto">Online - Salvamento automático ativo</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <form id="form-finalizar" action="{{ url_for('cli.finalizar_aplicacao', id=aplicacao.id) }}" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                {% for topico in topicos %}
                <div class="card mb-4 shadow-sm border-0">
                    <div class="card-header bg-light border-bottom">
                        <h5 class="mb-0 text-dark fw-bold">{{ topico.nome }}</h5>
                        {% if topico.descricao %}
                        <p class="text-muted mb-0 small mt-1">{{ topico.descricao }}</p>
                        {% endif %}
                    </div>
                    <div class="card-body p-2 p-md-3">
                        {% if perguntas_por_topico[topico.id] %}
                        
                            {% for pergunta in perguntas_por_topico[topico.id] %}
                            <div class="mb-3 p-3 border rounded pergunta-container bg-white" 
                                 data-pergunta-id="{{ pergunta.id }}"
                                 {% if pergunta.obrigatoria %}data-obrigatoria="true"{% endif %}>
                                
                                <label class="form-label fw-bold d-block mb-2">
                                    <span class="badge bg-secondary me-1">{{ topico.ordem }}.{{ pergunta.ordem }}</span>
                                    {{ pergunta.texto }}
                                    {% if pergunta.obrigatoria %}
                                        <span class="text-danger" title="Obrigatório">*</span>
                                    {% endif %}
                                </label>
                                
                                {% set resposta_salva = respostas_existentes.get(pergunta.id) %}

                                <div class="resposta-wrapper">
                                    
                                    {% if pergunta.tipo.name == 'SIM_NAO_NA' %}
                                    <div class="d-flex flex-wrap gap-3"> 
                                        {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                        <div class="form-check form-check-inline custom-radio-lg">
                                            <input class="form-check-input" type="radio" name="resposta-{{ pergunta.id }}"
                                                id="opcao-{{ pergunta.id }}-{{ opcao.id }}" value="{{ opcao.texto }}"
                                                data-pergunta-id="{{ pergunta.id }}" onchange="salvarResposta(this)" 
                                                {% if resposta_salva and resposta_salva.resposta==opcao.texto %}checked{% endif %}>
                                            <label class="form-check-label" for="opcao-{{ pergunta.id }}-{{ opcao.id }}">
                                                {{ opcao.texto }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>

                                    {% elif pergunta.tipo.name == 'MULTIPLA_ESCOLHA' %}
                                    <select class="form-select" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}" onchange="salvarResposta(this)">
                                        <option value="">Selecione...</option>
                                        {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                        <option value="{{ opcao.texto }}" {% if resposta_salva and resposta_salva.resposta==opcao.texto %}selected{% endif %}>
                                            {{ opcao.texto }}
                                        </option>
                                        {% endfor %}
                                    </select>

                                    {% elif pergunta.tipo.name == 'NOTA' or pergunta.tipo.name == 'ESCALA_NUMERICA' or pergunta.tipo.name == 'NUMERO' %}
                                    <input type="number" class="form-control" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                        onblur="salvarResposta(this)" step="any">

                                    {% elif pergunta.tipo.name == 'TEXTO_CURTO' %}
                                    <input type="text" class="form-control" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                        onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'TEXTO_LONGO' %}
                                    <textarea class="form-control" rows="3" name="resposta-{{ pergunta.id }}"
                                        data-pergunta-id="{{ pergunta.id }}"
                                        onblur="salvarResposta(this)">{{ resposta_salva.resposta if resposta_salva else '' }}</textarea>

                                    {% elif pergunta.tipo.name == 'DATA' %}
                                    <input type="date" class="form-control" name="resposta-{{ pergunta.id }}"
                                           data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}" onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'HORA' %}
                                    <input type="time" class="form-control" name="resposta-{{ pergunta.id }}"
                                           data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}" onblur="salvarResposta(this)">

                                    {% elif pergunta.tipo.name == 'ASSINATURA' %}
                                    <div class="signature-pad-container border rounded bg-light" style="position: relative; height: 200px; width: 100%;">
                                        <canvas id="signature-pad-{{ pergunta.id }}" style="width: 100%; height: 100%; display: block;"></canvas>
                                        <input type="hidden" name="resposta-{{ pergunta.id }}" id="resposta-input-{{ pergunta.id }}"
                                               data-pergunta-id="{{ pergunta.id }}" value="{{ resposta_salva.resposta if resposta_salva else '' }}">
                                        
                                        <button type="button" class="btn btn-sm btn-outline-danger clear-signature-btn" 
                                                data-pergunta-id="{{ pergunta.id }}"
                                                style="position: absolute; bottom: 10px; right: 10px; z-index: 10;">
                                            <i class="fas fa-eraser"></i> Limpar
                                        </button>
                                    </div>
                                    {% if resposta_salva and resposta_salva.resposta %}
                                    <div class="mt-2 text-center" id="preview-assinatura-{{ pergunta.id }}">
                                        <small class="text-success"><i class="fas fa-check-circle"></i> Assinatura Salva</small>
                                    </div>
                                    {% endif %}

                                    {% else %}
                                    <div class="alert alert-warning p-2 small">Tipo {{ pergunta.tipo.name }} não suportado neste formulário.</div>
                                    {% endif %}
                                </div>

                                <div id="feedback-{{ pergunta.id }}" class="form-text small mt-1" style="min-height: 20px;"></div>

                                {% if pergunta.permite_observacao %}
                                <div class="mt-2">
                                    <a class="text-decoration-none small text-muted" data-bs-toggle="collapse" href="#collapseObs{{ pergunta.id }}" role="button">
                                        <i class="far fa-comment-alt"></i> Adicionar Observação
                                    </a>
                                    <div class="collapse {% if resposta_salva and resposta_salva.observacao %}show{% endif %}" id="collapseObs{{ pergunta.id }}">
                                        <textarea class="form-control form-control-sm mt-1" id="obs-{{ pergunta.id }}"
                                            name="observacao-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                            onblur="salvarResposta(this, true)" rows="2" placeholder="Detalhes adicionais...">{{ resposta_salva.observacao if resposta_salva else '' }}</textarea>
                                    </div>
                                </div>
                                {% endif %}

                                {% if pergunta.criterio_foto != 'nenhuma' %}
                                <div class="mt-3 p-3 border border-secondary rounded bg-light foto-container">
                                    <label class="form-label fw-bold text-dark mb-2 d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="fas fa-camera text-primary me-1"></i> Evidência Fotográfica
                                        </span>
                                        {% if pergunta.criterio_foto == 'obrigatoria' %}
                                            <span class="badge bg-danger">Obrigatória</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Opcional</span>
                                        {% endif %}
                                    </label>

                                    <div class="input-group">
                                        <input type="file" 
                                               class="form-control" 
                                               id="foto-{{ pergunta.id }}" 
                                               name="foto-{{ pergunta.id }}" 
                                               accept="image/*" 
                                               capture="environment"
                                               data-pergunta-id="{{ pergunta.id }}"
                                               data-resposta-id="{{ resposta_salva.id if resposta_salva else '' }}"
                                               {% if pergunta.criterio_foto == 'obrigatoria' %}data-obrigatoria="true"{% endif %}
                                               onchange="handleFotoUpload(this)">
                                    </div>

                                    <div id="feedback-foto-{{ pergunta.id }}" class="form-text small mt-1"></div>

                                    <div id="container-preview-foto-{{ pergunta.id }}" class="mt-2">
                                        {% if resposta_salva and resposta_salva.caminho_foto %}
                                            <div class="position-relative d-inline-block img-salva-container">
                                                <img src="{{ url_for('cli.get_foto_resposta', filename=resposta_salva.caminho_foto) }}" 
                                                     class="img-thumbnail rounded" 
                                                     style="height: 120px; width: auto; object-fit: cover;">
                                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                            </div>
                            {% endfor %}

                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p>Nenhuma pergunta neste tópico.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <div class="card mb-5 shadow-sm border-0">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-flag-checkered me-2"></i>Conclusão</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Observações Gerais da Aplicação</label>
                            <textarea class="form-control" name="observacoes_finais" rows="4"
                                placeholder="Resumo geral, intercorrências ou comentários finais...">{{ aplicacao.observacoes_finais or '' }}</textarea>
                        </div>

                        <div class="alert alert-danger d-none" role="alert" id="alerta-validacao">
                            <h6 class="alert-heading fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Impedimento de Envio</h6>
                            <p class="mb-2" id="alerta-validacao-mensagem">Existem pendências obrigatórias:</p>
                            <ul id="alerta-validacao-lista" class="mb-0 small"></ul>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('cli.listar_aplicacoes') }}" class="btn btn-outline-secondary me-md-2">
                                Cancelar e Sair
                            </a>
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="fas fa-check-circle me-2"></i> Finalizar Aplicação
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
    // Configuração do Banco de Dados Local (IndexedDB) para Fotos
    const dbLocal = new Dexie("QualiGestorOffline");
    dbLocal.version(1).stores({
        fotos: '++id, pergunta_id, resposta_id, blob, nome, timestamp'
    });

    // Monitor de Conexão em tempo real
    window.addEventListener('online', () => {
        atualizarUIConexao(true);
        sincronizarPendencias();
    });
    window.addEventListener('offline', () => {
        atualizarUIConexao(false);
    });

    function atualizarUIConexao(online) {
        const statusEl = document.getElementById('status-conexao');
        const statusTxt = document.getElementById('status-texto');
        if (online) {
            statusEl.className = 'd-flex align-items-center text-success small';
            statusTxt.innerText = 'Online - Salvamento automático ativo';
        } else {
            statusEl.className = 'd-flex align-items-center text-warning small';
            statusTxt.innerText = 'Offline - Salvando no dispositivo';
        }
    }

    // ========================================================================
    // 1. SALVAR RESPOSTA (Híbrido: Online/Offline)
    // ========================================================================
    async function salvarResposta(inputElement, isObservacao = false) {
        const perguntaId = inputElement.dataset.perguntaId;
        const feedbackEl = document.getElementById(`feedback-${perguntaId}`);
        const fotoInput = document.getElementById(`foto-${perguntaId}`);

        let respostaValue = '';
        let observacaoValue = '';

        if (isObservacao) {
            observacaoValue = inputElement.value;
            const respEl = document.querySelector(`[name="resposta-${perguntaId}"]:checked`) || 
                           document.querySelector(`[name="resposta-${perguntaId}"]`);
            if(respEl) respostaValue = respEl.value;
        } else {
            respostaValue = inputElement.value;
            const obsEl = document.getElementById(`obs-${perguntaId}`);
            if(obsEl) observacaoValue = obsEl.value;
        }

        if (feedbackEl) {
            feedbackEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
            feedbackEl.className = 'form-text small text-muted';
        }

        const dadosParaSincronizar = {
            pergunta_id: parseInt(perguntaId),
            resposta: respostaValue,
            observacao: observacaoValue,
            timestamp: Date.now()
        };

        try {
            const response = await fetch("{{ url_for('cli.salvar_resposta', id=aplicacao.id) }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(dadosParaSincronizar)
            });

            const data = await response.json();

            if (response.ok && data.sucesso) {
                if (feedbackEl) {
                    feedbackEl.innerHTML = '<i class="fas fa-check me-1"></i>Salvo';
                    feedbackEl.className = 'form-text small text-success';
                    setTimeout(() => { if(feedbackEl.innerText === 'Salvo') feedbackEl.innerHTML = ''; }, 2000);
                }
                if (fotoInput && data.resposta_id) {
                    fotoInput.dataset.respostaId = data.resposta_id;
                    // Se houver foto pendente para essa pergunta no banco local, atualiza o resposta_id dela
                    await dbLocal.fotos.where("pergunta_id").equals(perguntaId).modify({ resposta_id: data.resposta_id });
                }
            } else { throw new Error(); }

        } catch (error) {
            // FALHA DE CONEXÃO: Salva no LocalStorage
            let fila = JSON.parse(localStorage.getItem('fila_respostas_offline') || '[]');
            // Remove entrada antiga da mesma pergunta para não duplicar
            fila = fila.filter(item => item.pergunta_id !== dadosParaSincronizar.pergunta_id);
            fila.push(dadosParaSincronizar);
            localStorage.setItem('fila_respostas_offline', JSON.stringify(fila));
            
            if (feedbackEl) {
                feedbackEl.innerHTML = '<i class="fas fa-hdd me-1"></i>Salvo no dispositivo (sem sinal)';
                feedbackEl.className = 'form-text small text-warning';
            }
        }
    }

    // ========================================================================
    // 2. UPLOAD DE FOTO (Híbrido: Online/Offline)
    // ========================================================================
    async function handleFotoUpload(fileInput) {
        const perguntaId = fileInput.dataset.perguntaId;
        let respostaId = fileInput.dataset.respostaId;
        const feedbackEl = document.getElementById(`feedback-foto-${perguntaId}`);
        const previewContainer = document.getElementById(`container-preview-foto-${perguntaId}`);
        const file = fileInput.files[0];

        if (!file) return;

        // Preview imediato (funciona offline)
        previewContainer.innerHTML = `
            <div class="position-relative d-inline-block img-salva-container">
                <img src="${URL.createObjectURL(file)}" class="img-thumbnail rounded" style="height: 120px; opacity: 0.7;">
                <span class="position-absolute top-50 start-50 translate-middle badge rounded-pill bg-warning">
                    <i class="fas fa-clock"></i> Pendente
                </span>
            </div>`;

        // Se estiver offline OU ainda não tiver RespostaId (porque a pergunta não foi respondida)
        if (!navigator.onLine || !respostaId) {
            await dbLocal.fotos.add({
                pergunta_id: perguntaId,
                resposta_id: respostaId || null,
                blob: file,
                nome: file.name,
                timestamp: Date.now()
            });
            if (feedbackEl) feedbackEl.innerHTML = '<i class="fas fa-hdd me-1"></i>Foto salva localmente';
            return;
        }

        // Se estiver Online, tenta o upload normal
        const formData = new FormData();
        formData.append('foto', file);

        try {
            if (feedbackEl) feedbackEl.innerHTML = 'Enviando foto...';
            const response = await fetch(`/cli/resposta/${respostaId}/upload-foto`, {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                body: formData
            });
            const data = await response.json();
            if (data.sucesso) {
                feedbackEl.innerHTML = 'Foto enviada com sucesso!';
                previewContainer.querySelector('.badge').className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success';
                previewContainer.querySelector('.badge').innerHTML = '<i class="fas fa-check"></i>';
                previewContainer.querySelector('img').style.opacity = '1';
            }
        } catch (e) {
            // Se falhar o upload online por instabilidade, guarda no banco local
            await dbLocal.fotos.add({ pergunta_id: perguntaId, resposta_id: respostaId, blob: file, nome: file.name, timestamp: Date.now() });
            feedbackEl.innerHTML = 'Conexão instável. Foto salva no dispositivo.';
        }
    }

    // ========================================================================
    // 3. SINCRONIZADOR AUTOMÁTICO
    // ========================================================================
    async function sincronizarPendencias() {
        const filaTexto = JSON.parse(localStorage.getItem('fila_respostas_offline') || '[]');
        const fotosOffline = await dbLocal.fotos.toArray();

        if (filaTexto.length === 0 && fotosOffline.length === 0) return;

        const alertSync = document.getElementById('sync-alert');
        alertSync.classList.remove('d-none');

        // A. Sincroniza Textos primeiro (para gerar os RespostaIds necessários para as fotos)
        for (let item of filaTexto) {
            try {
                const response = await fetch("{{ url_for('cli.salvar_resposta', id=aplicacao.id) }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                    body: JSON.stringify(item)
                });
                const data = await response.json();
                if (data.sucesso) {
                    // Atualiza a UI e limpa feedback
                    const fb = document.getElementById(`feedback-${item.pergunta_id}`);
                    if(fb) fb.innerHTML = '<i class="fas fa-check"></i> Sincronizado';
                    
                    // Se havia foto esperando por esse ID, atualiza o banco local de fotos
                    await dbLocal.fotos.where("pergunta_id").equals(item.pergunta_id.toString()).modify({ resposta_id: data.resposta_id });
                }
            } catch (e) { console.error("Falha ao sincronizar item", item); }
        }
        localStorage.removeItem('fila_respostas_offline');

        // B. Sincroniza Fotos
        const fotosAtualizadas = await dbLocal.fotos.toArray();
        for (let foto of fotosAtualizadas) {
            if (!foto.resposta_id) continue; // Pula se ainda não tiver ID de resposta

            const formData = new FormData();
            formData.append('foto', foto.blob);

            try {
                const response = await fetch(`/cli/resposta/${foto.resposta_id}/upload-foto`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
                    body: formData
                });
                if (response.ok) {
                    await dbLocal.fotos.delete(foto.id);
                    const fbFoto = document.getElementById(`feedback-foto-${foto.pergunta_id}`);
                    if(fbFoto) fbFoto.innerHTML = '<i class="fas fa-check"></i> Foto Sincronizada';
                }
            } catch (e) { console.error("Falha ao sincronizar foto", foto); }
        }

        document.getElementById('sync-message').innerText = "Sincronização concluída!";
        setTimeout(() => alertSync.classList.add('d-none'), 3000);
    }

    // ========================================================================
    // 4. VALIDAÇÃO E ASSINATURA (Preservado do seu original)
    // ========================================================================
    document.getElementById('form-finalizar').addEventListener('submit', function(e) {
        const alerta = document.getElementById('alerta-validacao');
        const listaErros = document.getElementById('alerta-validacao-lista');
        let erros = [];

        document.querySelectorAll('.pergunta-container').forEach(el => el.classList.remove('border-danger', 'bg-warning-subtle'));

        document.querySelectorAll('.pergunta-container[data-obrigatoria="true"]').forEach(container => {
            const pid = container.dataset.perguntaId;
            let respondido = false;

            const radioCheck = container.querySelector(`input[type="radio"]:checked`);
            if (radioCheck) respondido = true;

            const textInput = container.querySelector(`input[type="text"], input[type="number"], input[type="date"], input[type="time"], textarea`);
            if (textInput && textInput.value.trim() !== '') respondido = true;
            
            const select = container.querySelector('select');
            if (select && select.value !== '') respondido = true;

            const signInput = container.querySelector(`#resposta-input-${pid}`);
            if (signInput && signInput.value.trim() !== '') respondido = true;

            if (!respondido) {
                erros.push(`Pergunta obrigatória não respondida: "${container.querySelector('label').innerText.split('\n')[0]}"`);
                container.classList.add('border-danger', 'bg-warning-subtle');
            }
        });

        // Validação de Foto Obrigatória (Considera fotos no banco local também)
        document.querySelectorAll('input[type="file"][data-obrigatoria="true"]').forEach(async fileInput => {
            const container = fileInput.closest('.pergunta-container');
            const temFotoServidor = container.querySelector('.img-salva-container') !== null;
            
            if (fileInput.files.length === 0 && !temFotoServidor) {
                erros.push(`Foto obrigatória ausente: "${container.querySelector('label').innerText.split('\n')[0]}"`);
                container.classList.add('border-danger', 'bg-warning-subtle');
            }
        });

        if (erros.length > 0) {
            e.preventDefault();
            listaErros.innerHTML = '';
            erros.forEach(erro => {
                const li = document.createElement('li');
                li.innerText = erro;
                listaErros.appendChild(li);
            });
            alerta.classList.remove('d-none');
            alerta.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
            if(!confirm("Deseja realmente finalizar a aplicação?")) e.preventDefault();
        }
    });

    // Inicialização de Assinaturas e Listeners de Radio
    document.addEventListener('DOMContentLoaded', () => {
        atualizarUIConexao(navigator.onLine);
        if(navigator.onLine) sincronizarPendencias();

        const pads = document.querySelectorAll('canvas[id^="signature-pad-"]');
        pads.forEach(canvas => {
            const pid = canvas.id.split('-')[2];
            const hiddenInput = document.getElementById(`resposta-input-${pid}`);
            const parent = canvas.parentElement;
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;
            const pad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

            if (hiddenInput && hiddenInput.value) pad.fromDataURL(hiddenInput.value);

            pad.addEventListener("endStroke", () => {
                if (!pad.isEmpty()) {
                    hiddenInput.value = pad.toDataURL();
                    salvarResposta(hiddenInput);
                }
            });

            const btnClear = parent.querySelector('.clear-signature-btn');
            if (btnClear) {
                btnClear.addEventListener('click', () => {
                    pad.clear();
                    hiddenInput.value = '';
                    salvarResposta(hiddenInput);
                });
            }
        });

        // Ouvintes para regra de foto obrigatória
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() { atualizarRegraFoto(this); });
            if (radio.checked) atualizarRegraFoto(radio);
        });
    });

    function atualizarRegraFoto(radio) {
        const pid = radio.name.split('-')[1];
        const fileInput = document.getElementById(`foto-${pid}`);
        let labelFoto = document.querySelector(`label[for="foto-${pid}"]`) || fileInput?.closest('.foto-container')?.querySelector('label');
        if (!fileInput) return;

        const valor = radio.value.toLowerCase();
        if (valor === 'nao' || valor === 'nc') {
            fileInput.setAttribute('data-obrigatoria', 'true');
            if (labelFoto && !labelFoto.innerHTML.includes('(Foto Obrigatória)')) {
                labelFoto.innerHTML += ' <span class="text-danger fw-bold small">* (Foto Obrigatória)</span>';
            }
            fileInput.classList.add('border-danger');
        } else {
            fileInput.setAttribute('data-obrigatoria', 'false');
            const spanErro = labelFoto?.querySelector('.text-danger');
            if(spanErro) spanErro.remove();
            fileInput.classList.remove('border-danger');
        }
    }
</script>
{% endblock %}