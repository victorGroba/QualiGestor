{% extends "base_cliq.html" %}

{% block title %}Novo Usuário{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-user-plus me-2"></i>Novo Usuário
        </h1>
        <a href="{{ url_for('cli.gerenciar_usuarios') }}" class="btn btn-secondary btn-sm shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50 me-1"></i> Voltar
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dados do Usuário</h6>
        </div>
        <div class="card-body">
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('cli.novo_usuario') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nome" class="form-label font-weight-bold">Nome Completo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nome" name="nome" required placeholder="Ex: Sgt. Silva">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label font-weight-bold">E-mail (Login) <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" required placeholder="exemplo@fab.mil.br">
                    </div>
                </div>

                <hr class="my-3">
                <h6 class="text-secondary mb-3"><i class="fas fa-shield-alt me-1"></i> Permissões e Hierarquia</h6>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="tipo" class="form-label font-weight-bold">Nível de Acesso <span class="text-danger">*</span></label>
                        <select class="form-select" id="tipo" name="tipo" required onchange="toggleHierarquia()">
                            <option value="" selected disabled>Selecione...</option>
                            <option value="ADMIN">Gerencial (SDAB - Visão Nacional)</option>
                            <option value="GESTOR">Intermediário (GAP - Visão Regional)</option>
                            <option value="USUARIO">Operacional (Rancho/OM - Visão Local)</option>
                        </select>
                        <div class="form-text small">Define o nível de visibilidade dos dados.</div>
                    </div>

                    <div class="col-md-4 mb-3" id="div_grupo" style="display: none;">
                        <label for="grupo_id" class="form-label font-weight-bold text-info">Vincular a GAP (Regional)</label>
                        <select class="form-select border-info" id="grupo_id" name="grupo_id">
                            <option value="">-- Selecione a GAP --</option>
                            {% for grupo in grupos %}
                                <option value="{{ grupo.id }}">{{ grupo.nome }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-info">Obrigatório para nível Intermediário.</div>
                    </div>

                    <div class="col-md-4 mb-3" id="div_avaliado" style="display: none;">
                        <label for="avaliado_id" class="form-label font-weight-bold text-success">Vincular a Rancho/OM</label>
                        <select class="form-select border-success" id="avaliado_id" name="avaliado_id">
                            <option value="">-- Selecione o Rancho --</option>
                            {% for avaliado in avaliados %}
                                <option value="{{ avaliado.id }}">{{ avaliado.nome }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-success">Obrigatório para nível Operacional.</div>
                    </div>
                </div>

                <div class="alert alert-light border mt-2">
                    <small><i class="fas fa-info-circle text-primary"></i> <strong>Nota:</strong> A senha padrão inicial será <code>123456</code>. O usuário poderá alterá-la no primeiro acesso.</small>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <a href="{{ url_for('cli.gerenciar_usuarios') }}" class="btn btn-light border me-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="fas fa-save me-1"></i> Salvar Usuário
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    function toggleHierarquia() {
        var tipo = document.getElementById("tipo").value;
        var divGrupo = document.getElementById("div_grupo");
        var divAvaliado = document.getElementById("div_avaliado");
        var selectGrupo = document.getElementById("grupo_id");
        var selectAvaliado = document.getElementById("avaliado_id");

        // Reseta visibilidade
        divGrupo.style.display = "none";
        divAvaliado.style.display = "none";
        
        // Remove obrigatoriedade HTML5 temporariamente
        selectGrupo.removeAttribute("required");
        selectAvaliado.removeAttribute("required");

        if (tipo === "GESTOR") { // Intermediário (GAP)
            divGrupo.style.display = "block";
            selectGrupo.setAttribute("required", "required");
            selectAvaliado.value = ""; // Limpa seleção anterior
        } 
        else if (tipo === "USUARIO") { // Operacional (Rancho)
            divAvaliado.style.display = "block";
            selectAvaliado.setAttribute("required", "required");
            selectGrupo.value = ""; // Limpa seleção anterior
        }
        // ADMIN (Gerencial) não precisa selecionar nada (vê tudo)
    }

    // Executa ao carregar a página para garantir estado correto (caso haja erro de validação e retorno)
    document.addEventListener("DOMContentLoaded", function() {
        toggleHierarquia();
    });
</script>

{% endblock %}