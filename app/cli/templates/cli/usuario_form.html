{% extends "base_cliq.html" %}

{% block title %}Novo Usuário{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-user-plus me-2"></i>Novo Usuário
        </h1>
        <a href="{{ url_for('cli.gerenciar_usuarios') }}" class="btn btn-secondary btn-sm shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50 me-1"></i> Voltar
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dados do Usuário</h6>
        </div>
        <div class="card-body">
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('cli.novo_usuario') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nome" class="form-label font-weight-bold">Nome Completo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nome" name="nome" required placeholder="Ex: Sgt. Silva" autocomplete="off">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label font-weight-bold">E-mail (Login) <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" required placeholder="exemplo@fab.mil.br" autocomplete="off">
                    </div>
                </div>

                <hr class="my-3">
                <h6 class="text-secondary mb-3"><i class="fas fa-shield-alt me-1"></i> Permissões e Hierarquia</h6>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="tipo" class="form-label font-weight-bold">Perfil de Acesso <span class="text-danger">*</span></label>
                        <select class="form-select" id="tipo" name="tipo" required onchange="atualizarFormulario()">
                            <option value="" selected disabled>Selecione...</option>
                            
                            <optgroup label="Administração Global">
                                <option value="super_admin">Laboratório (Super Admin)</option>
                                <option value="admin">SDAB / FAB (Admin)</option>
                            </optgroup>
                            
                            <optgroup label="Nível Regional (GAP)">
                                <option value="gestor">Comando GAP (Gestor)</option>
                                <option value="auditor">Consultora (Auditora)</option>
                            </optgroup>
                            
                            <optgroup label="Nível Local">
                                <option value="usuario">Rancho (Operacional)</option>
                            </optgroup>
                        </select>
                        <div class="form-text small" id="textoAjuda">Selecione o perfil para ver as opções.</div>
                    </div>

                    <div class="col-md-4 mb-3" id="divGap" style="display: none;">
                        <label for="grupo_id" class="form-label font-weight-bold text-info">Vincular a qual GAP?</label>
                        <select class="form-select border-info" id="grupo_id" name="grupo_id" onchange="filtrarRanchos()">
                            <option value="">-- Selecione o GAP --</option>
                            {% for gap in grupos %} <option value="{{ gap.id }}">{{ gap.nome }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-info">Define a região de atuação.</div>
                    </div>

                    <div class="col-md-4 mb-3" id="divRancho" style="display: none;">
                        <label for="avaliado_id" class="form-label font-weight-bold text-success">Vincular a qual Rancho?</label>
                        <select class="form-select border-success" id="avaliado_id" name="avaliado_id">
                            <option value="">-- Selecione o GAP primeiro --</option>
                        </select>
                        <div class="form-text text-success">Define o local específico.</div>
                    </div>
                </div>

                <div class="alert alert-light border mt-2">
                    <small><i class="fas fa-info-circle text-primary"></i> <strong>Nota:</strong> A senha padrão inicial será <code>123456</code>.</small>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <a href="{{ url_for('cli.gerenciar_usuarios') }}" class="btn btn-light border me-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="fas fa-save me-1"></i> Salvar Usuário
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    /* Gera o array de objetos JS com dados vindos do Flask.
       Isso permite filtrar no cliente sem recarregar a página.
    */
    const todosRanchos = [
        {% for r in avaliados %}
        { 
            id: "{{ r.id }}", 
            nome: "{{ r.nome }}", 
            grupo_id: "{{ r.grupo_id if r.grupo_id else '' }}" 
        },
        {% endfor %}
    ];

    function atualizarFormulario() {
        const tipo = document.getElementById('tipo').value;
        const divGap = document.getElementById('divGap');
        const divRancho = document.getElementById('divRancho');
        const selectGap = document.getElementById('grupo_id');
        const selectRancho = document.getElementById('avaliado_id');
        const textoAjuda = document.getElementById('textoAjuda');

        // 1. Reseta visualização
        divGap.style.display = 'none';
        divRancho.style.display = 'none';
        
        // 2. Remove obrigatoriedade (para não travar o form se oculto)
        selectGap.removeAttribute('required');
        selectRancho.removeAttribute('required');

        // 3. Aplica lógica baseada no tipo selecionado
        if (tipo === 'gestor' || tipo === 'auditor') {
            // Nível GAP
            divGap.style.display = 'block';
            selectGap.setAttribute('required', 'required');
            textoAjuda.innerText = "Selecione o GAP de atuação.";
            
            // Limpa seleção de rancho se houver
            selectRancho.value = ""; 

        } else if (tipo === 'usuario') {
            // Nível Rancho (precisa de GAP + Rancho)
            divGap.style.display = 'block';
            divRancho.style.display = 'block';
            
            selectGap.setAttribute('required', 'required');
            selectRancho.setAttribute('required', 'required');
            textoAjuda.innerText = "Selecione o GAP e o Rancho específico.";
            
        } else {
            // Admins
            selectGap.value = "";
            selectRancho.value = "";
            textoAjuda.innerText = "Administradores possuem visão global.";
        }
    }

    function filtrarRanchos() {
        const gapId = document.getElementById('grupo_id').value;
        const selectRancho = document.getElementById('avaliado_id');
        
        // Limpa opções atuais
        selectRancho.innerHTML = '<option value="">-- Selecione o Rancho --</option>';

        if (gapId) {
            // Filtra o array JS
            // A comparação usa == para permitir string vs int (HTML value é sempre string)
            const ranchosFiltrados = todosRanchos.filter(r => r.grupo_id == gapId);
            
            if (ranchosFiltrados.length > 0) {
                ranchosFiltrados.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.text = r.nome;
                    selectRancho.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.text = "Nenhum rancho cadastrado neste GAP";
                selectRancho.appendChild(option);
            }
        } else {
            // Se o usuário "des-selecionar" o GAP
            const option = document.createElement('option');
            option.text = "-- Selecione o GAP primeiro --";
            selectRancho.appendChild(option);
        }
    }

    // Inicializa ao carregar (caso haja erro de validação e o form retorne preenchido)
    document.addEventListener("DOMContentLoaded", function() {
        atualizarFormulario();
        
        // Opcional: Se já houver um GAP selecionado e estivermos no modo Usuario, filtra os ranchos
        const tipo = document.getElementById('tipo').value;
        const gapId = document.getElementById('grupo_id').value;
        if (tipo === 'usuario' && gapId) {
            filtrarRanchos();
        }
    });
</script>

{% endblock %}