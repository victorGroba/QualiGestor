{% extends "base_cliq.html" %}

{% block title %}Novo Usuário{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Ajustes para o Select2 parecer com o Bootstrap 5 */
    .select2-container .select2-selection--multiple {
        border: 1px solid #ced4da !important;
        min-height: 38px !important;
        border-radius: 0.375rem !important;
        padding-bottom: 0;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #0dcaf0 !important; /* Cor Cyan do tema */
        border: 1px solid #0dcaf0 !important;
        color: white !important;
        border-radius: 20px;
        padding: 2px 8px;
        margin-top: 4px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white !important;
        margin-right: 5px;
        border-right: 1px solid rgba(255,255,255,0.5);
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        background-color: transparent !important;
        color: #ffcccc !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-user-plus me-2"></i>Novo Usuário
        </h1>
        <a href="{{ url_for('cli.gerenciar_usuarios') }}" class="btn btn-secondary btn-sm shadow-sm">
            <i class="fas fa-arrow-left fa-sm text-white-50 me-1"></i> Voltar
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Dados do Usuário</h6>
        </div>
        <div class="card-body">
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('cli.novo_usuario') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nome" class="form-label font-weight-bold">Nome Completo <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nome" name="nome" required placeholder="Ex: Sgt. Silva" autocomplete="off">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label font-weight-bold">E-mail (Login) <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" required placeholder="exemplo@fab.mil.br" autocomplete="off">
                    </div>
                </div>

                <hr class="my-3">
                <h6 class="text-secondary mb-3"><i class="fas fa-shield-alt me-1"></i> Permissões e Hierarquia</h6>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="tipo" class="form-label font-weight-bold">Perfil de Acesso <span class="text-danger">*</span></label>
                        <select class="form-select" id="tipo" name="tipo" required onchange="atualizarFormulario()">
                            <option value="" selected disabled>Selecione...</option>
                            
                            <optgroup label="Administração Global">
                                <option value="super_admin">Laboratório (Super Admin)</option>
                                <option value="admin">SDAB / FAB (Admin)</option>
                            </optgroup>
                            
                            <optgroup label="Nível Regional (GAP)">
                                <option value="gestor">Comando GAP (Gestor)</option>
                                <option value="auditor">Consultora (Auditora)</option>
                            </optgroup>
                            
                            <optgroup label="Nível Local">
                                <option value="usuario">Rancho (Operacional)</option>
                            </optgroup>
                        </select>
                        <div class="form-text small" id="textoAjuda">Selecione o perfil para ver as opções.</div>
                    </div>

                    <div class="col-md-4 mb-3" id="divGap" style="display: none;">
                        <label for="grupos_acesso" class="form-label font-weight-bold text-info">GAPs de Atuação (Multi-seleção)</label>
                        <select class="form-select border-info" id="grupos_acesso" name="grupos_acesso" multiple="multiple" style="width: 100%;">
                            {% for gap in grupos %}
                                <option value="{{ gap.id }}">{{ gap.nome }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-primary">
                            <i class="fas fa-info-circle"></i> Clique na caixa para adicionar ou remover GAPs.
                        </div>
                    </div>

                    <div class="col-md-4 mb-3" id="divRancho" style="display: none;">
                        <label for="avaliado_id" class="form-label font-weight-bold text-success">Vincular a qual Rancho?</label>
                        <select class="form-select border-success" id="avaliado_id" name="avaliado_id">
                            <option value="">-- Selecione o GAP primeiro --</option>
                        </select>
                        <div class="form-text text-success">Define o local específico (Para perfil Rancho).</div>
                    </div>
                </div>

                <div class="alert alert-light border mt-2">
                    <small><i class="fas fa-info-circle text-primary"></i> <strong>Nota:</strong> A senha padrão inicial será <code>123456</code>.</small>
                </div>

                <div class="d-flex justify-content-end mt-4">
                    <a href="{{ url_for('cli.gerenciar_usuarios') }}" class="btn btn-light border me-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="fas fa-save me-1"></i> Salvar Usuário
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // Geramos o array de ranchos protegendo os nomes contra aspas simples/duplas com |tojson
    const todosRanchos = [
        {% for r in ranchos %}
        { 
            "id": "{{ r.id }}", 
            "nome": {{ r.nome|tojson }}, 
            "grupo_id": "{{ r.grupo_id if r.grupo_id else '' }}" 
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    function atualizarFormulario() {
        const tipo = document.getElementById('tipo').value;
        const divGap = document.getElementById('divGap');
        const divRancho = document.getElementById('divRancho');
        const selectGap = document.getElementById('grupos_acesso');
        const selectRancho = document.getElementById('avaliado_id');
        const textoAjuda = document.getElementById('textoAjuda');

        // Reset padrão
        divGap.style.display = 'none';
        divRancho.style.display = 'none';
        selectGap.removeAttribute('required');
        selectRancho.removeAttribute('required');

        if (tipo === 'gestor' || tipo === 'auditor') {
            divGap.style.display = 'block';
            selectGap.setAttribute('required', 'required'); // Torna GAP obrigatório
            textoAjuda.innerText = "Selecione um ou mais GAPs de atuação.";
            selectRancho.value = ""; 
        } else if (tipo === 'usuario') {
            divGap.style.display = 'block';
            divRancho.style.display = 'block';
            selectGap.setAttribute('required', 'required');
            selectRancho.setAttribute('required', 'required');
            textoAjuda.innerText = "Selecione o GAP e o Rancho específico.";
        } else {
            // Se for admin, limpa tudo
            // Para Select2, usamos jQuery para limpar
            $('#grupos_acesso').val(null).trigger('change');
            selectRancho.value = "";
            textoAjuda.innerText = "Administradores possuem visão global.";
        }
    }

    function filtrarRanchos() {
        // Com Select2, usamos jQuery para pegar o valor (pega o primeiro se for múltiplo ou array)
        // No contexto de "filtrar ranchos", usamos o primeiro GAP selecionado como base
        const gapVal = $('#grupos_acesso').val(); 
        const gapId = Array.isArray(gapVal) ? gapVal[0] : gapVal;
        
        const selectRancho = document.getElementById('avaliado_id');
        
        // Limpa opções atuais
        selectRancho.innerHTML = '<option value="">-- Selecione o Rancho --</option>';

        if (gapId) {
            const ranchosFiltrados = todosRanchos.filter(r => String(r.grupo_id) === String(gapId));
            
            if (ranchosFiltrados.length > 0) {
                ranchosFiltrados.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.text = r.nome;
                    selectRancho.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.text = "Nenhum rancho cadastrado neste GAP";
                selectRancho.appendChild(option);
            }
        } else {
            const option = document.createElement('option');
            option.text = "-- Selecione o GAP primeiro --";
            selectRancho.appendChild(option);
        }
    }

    // Inicialização ao carregar a página
    $(document).ready(function() {
        // 1. Ativa o Select2 no campo de GAPs
        $('#grupos_acesso').select2({
            placeholder: "Clique para selecionar GAPs...",
            allowClear: true,
            width: '100%'
        });

        // 2. Vincula o evento de mudança do Select2 à função de filtro
        $('#grupos_acesso').on('change', function() {
            filtrarRanchos();
        });

        // 3. Inicializa o estado do formulário
        atualizarFormulario();
        
        // 4. Se já houver valor (ex: erro de validação), filtra
        if ($('#grupos_acesso').val() && $('#grupos_acesso').val().length > 0) {
            filtrarRanchos();
        }
    });
</script>

{% endblock %}