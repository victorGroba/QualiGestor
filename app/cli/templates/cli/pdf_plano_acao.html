<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Plano de Ação - {{ aplicacao.id }}</title>
    <style>
        @page {
            size: A4;
            margin: 1cm; /* Margem reduzida para ocupar a tela toda */
            @bottom-center {
                content: "Página " counter(page) " de " counter(pages);
                font-family: Helvetica, Arial, sans-serif;
                font-size: 8pt;
                color: #999;
            }
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 9pt;
            color: #333;
            line-height: 1.3;
        }

        /* === HEADER === */
        .header-table { width: 100%; border-bottom: 2px solid #e67e22; padding-bottom: 5px; margin-bottom: 10px; }
        .logo-cell { width: 30%; vertical-align: middle; }
        .title-cell { width: 70%; text-align: right; vertical-align: middle; }
        .logo-img { max-height: 55px; max-width: 180px; }
        h1 { margin: 0; color: #e67e22; font-size: 16pt; text-transform: uppercase; }
        p.sub { margin: 0; color: #666; font-size: 8pt; }

        /* === INFO === */
        .info-box {
            width: 100%; background-color: #fffcf5; 
            border: 1px solid #e67e22; border-radius: 4px;
            padding: 8px; margin-bottom: 15px;
        }
        .info-table { width: 100%; }
        .lbl { font-size: 7pt; color: #e67e22; font-weight: bold; text-transform: uppercase; display: block; }
        .val { font-size: 10pt; font-weight: bold; color: #333; }

        /* === TABELA NCs === */
        .main-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .main-table th {
            background-color: #e67e22; color: white;
            padding: 6px 8px; font-size: 8pt; text-transform: uppercase; text-align: left;
            border: 1px solid #d35400;
        }
        .main-table td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
        .main-table tr:nth-child(even) { background-color: #fcfcfc; }

        /* Itens */
        .badge { display: inline-block; background: #444; color: #fff; padding: 2px 5px; border-radius: 3px; font-size: 7pt; margin-bottom: 3px; }
        .question { font-weight: bold; font-size: 9pt; color: #2c3e50; margin-bottom: 3px; }
        .obs { font-style: italic; color: #666; font-size: 8pt; border-left: 2px solid #ccc; padding-left: 5px; margin-top: 4px; }
        
        .plan-box { background: #fff; border: 1px solid #eee; padding: 6px; border-radius: 3px; min-height: 30px; margin-bottom: 5px;}
        .date-tag { display: inline-block; background: #fff5e6; color: #d35400; border: 1px solid #e67e22; padding: 2px 8px; border-radius: 10px; font-size: 7pt; font-weight: bold; float: right; }
        
        .evidencia { max-width: 90px; max-height: 90px; display: block; margin: 0 auto; border: 1px solid #ddd; padding: 2px; background: #fff; }

        /* === ASSINATURAS (LAYOUT DIGITAL) === */
        .signatures { margin-top: 30px; width: 100%; page-break-inside: avoid; }
        .sig-cell { width: 50%; text-align: center; vertical-align: bottom; padding: 0 20px; }
        
        .sig-box {
            border: 1px dashed #ccc;
            background-color: #fdfdfd;
            padding: 10px;
            border-radius: 5px;
            min-height: 80px;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
        }

        .sig-img { max-height: 60px; max-width: 200px; display: block; margin-bottom: 5px; }
        
        .sig-name { font-weight: bold; font-size: 9pt; color: #333; margin-top: 5px; border-top: 1px solid #ddd; padding-top: 5px; width: 100%; display: block;}
        .sig-role { font-size: 7pt; color: #777; text-transform: uppercase; }
        .sig-digital-mark { font-family: 'Courier New', monospace; font-size: 7pt; color: #aaa; margin-bottom: 5px; }

        /* Footer */
        .footer-sys { text-align: center; font-size: 7pt; color: #aaa; margin-top: 10px; border-top: 1px dotted #eee; padding-top: 4px; }
    </style>
</head>
<body>

    <table class="header-table">
        <tr>
            <td class="logo-cell">
                {% if logo_uri %}<img src="{{ logo_uri }}" class="logo-img">{% else %}<h2 style="color:#e67e22;">QUALIGESTOR</h2>{% endif %}
            </td>
            <td class="title-cell">
                <h1>Plano de Ação</h1>
                <p class="sub">Relatório de Auditoria #{{ aplicacao.id }}</p>
            </td>
        </tr>
    </table>

    <div class="info-box">
        <table class="info-table">
            <tr>
                <td width="50%"><span class="lbl">Unidade Avaliada</span><span class="val">{{ aplicacao.avaliado.nome }}</span></td>
                <td width="25%"><span class="lbl">Data Auditoria</span><span class="val">{{ aplicacao.data_inicio.strftime('%d/%m/%Y') }}</span></td>
                <td width="25%"><span class="lbl">Total NCs</span><span class="val">{{ itens|length }}</span></td>
            </tr>
        </table>
    </div>

    <table class="main-table">
        <thead>
            <tr>
                <th width="40%">Não Conformidade</th>
                <th width="45%">Plano de Ação</th>
                <th width="15%" align="center">Evidência</th>
            </tr>
        </thead>
        <tbody>
            {% for item in itens %}
            <tr>
                <td>
                    <span class="badge">{{ item.topico_ordem }}</span> <span style="font-size:8pt; color:#666;">{{ item.topico_nome }}</span>
                    <div class="question">{{ item.pergunta_ordem }}. {{ item.pergunta_texto }}</div>
                    {% if item.observacao %}<div class="obs">"{{ item.observacao }}"</div>{% endif %}
                </td>
                <td>
                    <div class="plan-box">{{ item.plano_acao }}</div>
                    {% if item.prazo %}
                        <div class="date-tag">Vencimento: {{ item.prazo.strftime('%d/%m/%Y') }}</div>
                    {% else %}
                        <div style="text-align:right; font-size:7pt; color:#999;">(Sem prazo)</div>
                    {% endif %}
                </td>
                <td align="center">
                    {% if item.foto_uri %}<img src="{{ item.foto_uri }}" class="evidencia">{% else %}-{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <table class="signatures">
        <tr>
            <td class="sig-cell">
                <div class="sig-box">
                    {% if assinatura_cliente_uri %}
                        <img src="{{ assinatura_cliente_uri }}" class="sig-img">
                        <span class="sig-digital-mark">Assinatura Digital Coletada</span>
                    {% else %}
                        <span class="sig-digital-mark" style="color:#d35400;">(Assinatura Pendente)</span>
                    {% endif %}
                    
                    <span class="sig-name">{{ assinatura_responsavel or 'Responsável pela Unidade' }}</span>
                    <span class="sig-role">{{ cargo_responsavel or 'Gestor' }}</span>
                </div>
            </td>

            <td class="sig-cell">
                <div class="sig-box">
                    {% if assinatura_auditor_uri %}
                        <img src="{{ assinatura_auditor_uri }}" class="sig-img">
                    {% else %}
                        <div style="font-size: 20px; color: #e67e22; margin-bottom: 5px;">
                            <i class="fas fa-check-circle"></i> ✔
                        </div>
                    {% endif %}
                    
                    <span class="sig-digital-mark">VALIDADO PELO SISTEMA</span>
                    <span class="sig-name">{{ aplicacao.aplicador.nome if aplicacao.aplicador else 'Consultor QualiGestor' }}</span>
                    <span class="sig-role">Auditor Técnico</span>
                </div>
            </td>
        </tr>
    </table>

    <div class="footer-sys">
        Documento gerado eletronicamente em {{ data_geracao.strftime('%d/%m/%Y às %H:%M') }} - QualiGestor
    </div>

</body>
</html>