{% extends "base_cliq.html" %}

{% block title %}Gestão de Usuários{% endblock %}

{% block head %}
<style>
    /* CSS dos Cards */
    .user-card {
        background: #fff;
        border: none;
        border-radius: 12px;
        transition: all 0.3s ease;
        border-left: 5px solid transparent;
        height: 100%;
    }
    .user-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1) !important;
    }
    /* Cores das bordas */
    .border-admin { border-left-color: #dc3545; }
    .border-gestor { border-left-color: #0dcaf0; }
    .border-usuario { border-left-color: #198754; }

    /* Avatar */
    .user-avatar {
        width: 55px; height: 55px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: white; font-weight: 600; font-size: 1.3rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .bg-gradient-admin { background: linear-gradient(135deg, #dc3545, #a71d2a); }
    .bg-gradient-gestor { background: linear-gradient(135deg, #0dcaf0, #0aa2c0); }
    .bg-gradient-usuario { background: linear-gradient(135deg, #198754, #146c43); }

    .search-input { border-radius: 20px 0 0 20px; border-right: none; }
    .search-icon { border-radius: 0 20px 20px 0; background: white; border-left: none; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
        <div>
            <h1 class="h3 mb-1 text-gray-800 fw-bold">
                <i class="fas fa-users text-primary me-2"></i>Gestão de Usuários
            </h1>
            <p class="text-muted mb-0">Controle de acesso e hierarquia (SDAB, GAP, Ranchos)</p>
        </div>
        <a href="{{ url_for('cli.novo_usuario') }}" class="btn btn-primary shadow-sm px-4 py-2 rounded-pill">
            <i class="fas fa-user-plus me-2"></i>Novo Usuário
        </a>
    </div>

    <div class="card border-0 shadow-sm mb-4 rounded-3">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control search-input" placeholder="Buscar por nome, e-mail..." id="filtroNome" onkeyup="filtrarUsuarios()">
                        <span class="input-group-text search-icon text-muted"><i class="fas fa-search"></i></span>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select rounded-pill border-light bg-light" id="filtroTipo" onchange="filtrarUsuarios()">
                        <option value="">Todos os Perfis</option>
                        <option value="ADMIN">SDAB (Nacional)</option>
                        <option value="GESTOR">GAP (Regional)</option>
                        <option value="USUARIO">Rancho (Operacional)</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select rounded-pill border-light bg-light" id="filtroStatus" onchange="filtrarUsuarios()">
                        <option value="">Todos os Status</option>
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
                <div class="col-md-2 text-end">
                    <button class="btn btn-link text-decoration-none text-muted" onclick="limparFiltros()">
                        <i class="fas fa-sync-alt me-1"></i> Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4" id="listaUsuarios">
        {% for usuario in usuarios %}
        
        {% set tipo_cod = usuario.tipo.name %}
        {% if tipo_cod == 'SUPER_ADMIN' %}{% set tipo_cod = 'ADMIN' %}{% endif %}
        
        <div class="col-md-6 col-lg-4 d-flex align-items-stretch usuario-card-wrapper" 
             data-nome="{{ usuario.nome.lower() }} {{ usuario.email.lower() }}" 
             data-tipo="{{ tipo_cod }}"
             data-status="{% if usuario.ativo %}ativo{% else %}inativo{% endif %}">
            
            <div class="user-card w-100 shadow-sm {% if tipo_cod == 'ADMIN' %}border-admin{% elif tipo_cod == 'GESTOR' or tipo_cod == 'AUDITOR' %}border-gestor{% else %}border-usuario{% endif %}">
                <div class="card-body p-4 d-flex flex-column h-100">
                    
                    <div class="d-flex align-items-start mb-3">
                        <div class="user-avatar me-3 flex-shrink-0 {% if tipo_cod == 'ADMIN' %}bg-gradient-admin{% elif tipo_cod == 'GESTOR' or tipo_cod == 'AUDITOR' %}bg-gradient-gestor{% else %}bg-gradient-usuario{% endif %}">
                            {{ usuario.nome[0].upper() }}
                        </div>
                        <div class="flex-grow-1 overflow-hidden">
                            <h5 class="card-title mb-1 fw-bold text-truncate" title="{{ usuario.nome }}">{{ usuario.nome }}</h5>
                            <div class="text-muted small text-truncate" title="{{ usuario.email }}">{{ usuario.email }}</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {% if tipo_cod == 'ADMIN' %}
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-2 py-1 rounded-pill">SDAB (Nacional)</span>
                        {% elif tipo_cod == 'GESTOR' or tipo_cod == 'AUDITOR' %}
                            <span class="badge bg-info bg-opacity-10 text-info border border-info px-2 py-1 rounded-pill">
                                {{ 'Consultora' if tipo_cod == 'AUDITOR' else 'GAP (Regional)' }}
                            </span>
                        {% else %}
                            <span class="badge bg-success bg-opacity-10 text-success border border-success px-2 py-1 rounded-pill">Rancho (Local)</span>
                        {% endif %}
                    </div>

                    <div class="p-2 bg-light rounded mb-4 small" style="min-height: 60px;">
                        <i class="fas fa-map-marker-alt text-secondary me-1"></i>
                        
                        {# PRIORIDADE 1: CONSULTORAS E GESTORES (Mostra Lista) #}
                        {% if (tipo_cod == 'GESTOR' or tipo_cod == 'AUDITOR') %}
                            
                            {% if usuario.grupos_acesso|length > 0 %}
                                <div class="fw-bold text-dark mb-1" style="font-size: 0.8rem;">GAPs Vinculados:</div>
                                <div class="d-flex flex-wrap gap-1">
                                    {% for gap in usuario.grupos_acesso %}
                                        <span class="badge bg-white text-dark border border-secondary fw-normal">
                                            {{ gap.nome }}
                                        </span>
                                    {% endfor %}
                                </div>
                            {% elif usuario.grupo %}
                                <span class="fw-bold text-dark">{{ usuario.grupo.nome }}</span>
                            {% else %}
                                <span class="text-danger fst-italic">Sem vínculo</span>
                            {% endif %}

                        {# PRIORIDADE 2: USUÁRIO DE RANCHO (Mostra Local) #}
                        {% elif tipo_cod == 'USUARIO' and usuario.avaliado %}
                            <span class="fw-bold text-dark">{{ usuario.avaliado.nome }}</span>
                            <div class="text-muted fst-italic mt-1" style="font-size: 0.85em;">
                                ({{ usuario.avaliado.grupo.nome if usuario.avaliado.grupo else 'Sem GAP' }})
                            </div>

                        {# PRIORIDADE 3: ADMIN #}
                        {% else %}
                            <span class="text-muted fst-italic">Acesso Global (Todos)</span>
                        {% endif %}
                    </div>

                    <div class="mt-auto pt-3 border-top d-flex justify-content-between align-items-center">
                        <div>
                            {% if usuario.ativo %}
                                <small class="text-success fw-bold"><i class="fas fa-circle fa-xs me-1"></i> Ativo</small>
                            {% else %}
                                <small class="text-secondary fw-bold"><i class="fas fa-circle fa-xs me-1"></i> Inativo</small>
                            {% endif %}
                        </div>
                        <div class="btn-group">
                            <a href="{{ url_for('cli.editar_usuario', user_id=usuario.id) }}" class="btn btn-sm btn-outline-primary rounded-start" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger rounded-end" onclick="confirmarExclusao('{{ usuario.nome }}')" title="Excluir">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5">
            <div class="text-muted opacity-50">
                <i class="fas fa-users fa-4x mb-3"></i>
                <h4>Nenhum usuário encontrado</h4>
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="nenhumResultado" class="d-none text-center py-5">
        <div class="text-muted">
            <i class="fas fa-search fa-3x mb-3 opacity-50"></i>
            <h5>Nenhum resultado para sua busca</h5>
            <button class="btn btn-link" onclick="limparFiltros()">Limpar filtros</button>
        </div>
    </div>
</div>

<script>
function filtrarUsuarios() {
    const nome = document.getElementById('filtroNome').value.toLowerCase();
    const tipo = document.getElementById('filtroTipo').value;
    const status = document.getElementById('filtroStatus').value;
    
    const cards = document.querySelectorAll('.usuario-card-wrapper');
    let visiveis = 0;

    cards.forEach(card => {
        const cardNome = card.dataset.nome;
        const cardTipo = card.dataset.tipo;
        const cardStatus = card.dataset.status;

        let mostrar = true;
        if (nome && !cardNome.includes(nome)) mostrar = false;
        if (tipo && cardTipo !== tipo) mostrar = false;
        if (status && cardStatus !== status) mostrar = false;

        if (mostrar) {
            card.classList.remove('d-none');
            visiveis++;
        } else {
            card.classList.add('d-none');
        }
    });
    document.getElementById('nenhumResultado').classList.toggle('d-none', visiveis > 0);
}

function limparFiltros() {
    document.getElementById('filtroNome').value = '';
    document.getElementById('filtroTipo').value = '';
    document.getElementById('filtroStatus').value = '';
    filtrarUsuarios();
}

function confirmarExclusao(nome) {
    if(confirm('Tem certeza que deseja excluir ' + nome + '?')) alert('Função de exclusão em desenvolvimento.');
}
</script>
{% endblock %}