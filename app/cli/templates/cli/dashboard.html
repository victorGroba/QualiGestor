{% extends "base_cliq.html" %}

{% block title %}Dashboard CLIQ{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        transition: transform 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 400px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-tachometer-alt text-primary me-2"></i>
            Dashboard Executivo
        </h1>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="atualizarDashboard()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <button class="btn btn-primary" onclick="exportarDashboard()">
                <i class="fas fa-download"></i> Exportar
            </button>
        </div>
    </div>

    <!-- MÃ©tricas Principais -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card metric-card h-100">
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="graficoEvolucao"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-pie-chart text-success me-2"></i>
                        Conformidade por Categoria
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="graficoConformidade"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ranking e AnÃ¡lises -->
    <div class="row mb-4">
        <div class="col-xl-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy text-warning me-2"></i>
                        Top 10 Lojas
                    </h5>
                </div>
                <div class="card-body">
                    <div id="rankingLojas" style="max-height: 400px; overflow-y: auto;">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                        Principais NÃ£o-Conformidades
                    </h5>
                </div>
                <div class="card-body">
                    <div id="topNaoConformidades" style="max-height: 400px; overflow-y: auto;">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// VariÃ¡veis globais para os grÃ¡ficos
let graficoEvolucao, graficoConformidade;

document.addEventListener('DOMContentLoaded', function() {
    inicializarGraficos();
    carregarDadosDashboard();
});

function inicializarGraficos() {
    // GrÃ¡fico de evoluÃ§Ã£o
    const ctxEvolucao = document.getElementById('graficoEvolucao').getContext('2d');
    graficoEvolucao = new Chart(ctxEvolucao, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'EvoluÃ§Ã£o das Notas MÃ©dias'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    // GrÃ¡fico de conformidade
    const ctxConformidade = document.getElementById('graficoConformidade').getContext('2d');
    graficoConformidade = new Chart(ctxConformidade, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#28a745',
                    '#dc3545',
                    '#ffc107',
                    '#17a2b8',
                    '#6f42c1'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function carregarDadosDashboard() {
    // Carregar dados dos grÃ¡ficos
    Promise.all([
        fetch('/cli/api/relatorio/dados?tipo=evolucao').then(r => r.json()),
        fetch('/cli/api/relatorio/dados?tipo=categorias').then(r => r.json()),
        fetch('/cli/api/relatorio/dados?tipo=ranking').then(r => r.json()),
        fetch('/cli/api/relatorio/dados?tipo=conformidade').then(r => r.json())
    ]).then(([evolucao, categorias, ranking, conformidade]) => {
        atualizarGraficoEvolucao(evolucao);
        atualizarGraficoConformidade(categorias);
        atualizarRankingLojas(ranking);
        atualizarNaoConformidades(conformidade);
    }).catch(console.error);
}

function atualizarGraficoEvolucao(dados) {
    const cores = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8'];
    let datasets = [];
    let todasDatas = new Set();

    // Coletar todas as datas
    Object.values(dados.dados).forEach(lojaDados => {
        lojaDados.forEach(ponto => todasDatas.add(ponto.data));
    });

    const datasOrdenadas = Array.from(todasDatas).sort();

    // Criar datasets para cada loja
    Object.entries(dados.dados).forEach(([loja, pontos], index) => {
        const dadosLoja = datasOrdenadas.map(data => {
            const ponto = pontos.find(p => p.data === data);
            return ponto ? ponto.nota : null;
        });

        datasets.push({
            label: loja,
            data: dadosLoja,
            borderColor: cores[index % cores.length],
            backgroundColor: cores[index % cores.length] + '20',
            tension: 0.1,
            fill: false
        });
    });

    graficoEvolucao.data.labels = datasOrdenadas.map(data => {
        return new Date(data).toLocaleDateString('pt-BR');
    });
    graficoEvolucao.data.datasets = datasets;
    graficoEvolucao.update();
}

function atualizarGraficoConformidade(dados) {
    const labels = dados.dados.map(item => item.categoria);
    const percentuais = dados.dados.map(item => item.percentual_conformidade);

    graficoConformidade.data.labels = labels;
    graficoConformidade.data.datasets[0].data = percentuais;
    graficoConformidade.update();
}

function atualizarRankingLojas(dados) {
    const container = document.getElementById('rankingLojas');
    let html = '';

    dados.ranking.forEach((loja, index) => {
        const medalha = index < 3 ? ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][index] : `${index + 1}Âº`;
        const corBarra = loja.media >= 80 ? 'success' : loja.media >= 60 ? 'warning' : 'danger';

        html += `
            <div class="d-flex align-items-center mb-3">
                <div class="me-3">
                    <span class="h5 mb-0">${medalha}</span>
                </div>
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${loja.loja}</strong>
                        <span class="badge bg-${corBarra}">${loja.media}%</span>
                    </div>
                    <div class="progress mt-1" style="height: 6px;">
                        <div class="progress-bar bg-${corBarra}" style="width: ${loja.media}%"></div>
                    </div>
                    <small class="text-muted">${loja.total_auditorias} auditorias</small>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function atualizarNaoConformidades(dados) {
    const container = document.getElementById('topNaoConformidades');
    let html = '';

    // Agrupar nÃ£o-conformidades por pergunta
    const naoConformidadesPorPergunta = {};
    
    dados.detalhes.forEach(item => {
        const key = item.pergunta;
        if (!naoConformidadesPorPergunta[key]) {
            naoConformidadesPorPergunta[key] = {
                pergunta: item.pergunta,
                categoria: item.categoria,
                ocorrencias: 0,
                lojas: new Set()
            };
        }
        naoConformidadesPorPergunta[key].ocorrencias++;
        naoConformidadesPorPergunta[key].lojas.add(item.loja);
    });

    // Ordenar por ocorrÃªncias
    const topNaoConformidades = Object.values(naoConformidadesPorPergunta)
        .sort((a, b) => b.ocorrencias - a.ocorrencias)
        .slice(0, 10);

    topNaoConformidades.forEach((item, index) => {
        html += `
            <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.pergunta}</h6>
                        <div class="text-muted small">
                            <span class="badge bg-secondary me-1">${item.categoria}</span>
                            ${item.ocorrencias} ocorrÃªncias em ${item.lojas.size} lojas
                        </div>
                    </div>
                    <span class="badge bg-danger">${index + 1}Âº</span>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function atualizarDashboard() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
    btn.disabled = true;

    carregarDadosDashboard();

    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
}

function alterarPeriodoGrafico(periodo) {
    // Remover classe active de todos os botÃµes
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Adicionar classe active ao botÃ£o clicado
    event.target.classList.add('active');
    
    // Recarregar dados com novo perÃ­odo
    carregarDadosDashboard();
}

function exportarDashboard() {
    window.open('/cli/relatorio/exportar/pdf?tipo=dashboard', '_blank');
}
</script>
{% endblock %}

<!-- app/templates/cli/relatorios.html -->
