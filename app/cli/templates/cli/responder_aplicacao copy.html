{% extends "base_cliq.html" %}

{% block content %}
<div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">
    <div id="liveToast" class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-sync fa-spin me-2"></i> <span id="sync-message">Sincronizando dados...</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
</div>

<div id="status-flutuante" class="shadow-lg d-flex align-items-center justify-content-center text-white"
    style="position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; border-radius: 50%; z-index: 1050; transition: all 0.3s ease;">
    <i class="fas fa-wifi fa-lg"></i>
</div>

<div class="container-fluid py-4 pb-5">
    <div class="row g-4">

        <div class="col-lg-3">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header py-3 {{ 'bg-success' if modo_assinatura else 'bg-dark' }} text-white">
                    <h5 class="mb-0 fs-6 fw-bold">
                        {% if modo_assinatura %}
                        <i class="fas fa-file-signature me-2"></i>Assinatura
                        {% else %}
                        <i class="fas fa-clipboard-check me-2"></i>Auditoria
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body bg-white">
                    <h6 class="card-title fw-bold text-dark mb-1">{{ aplicacao.questionario.nome }}</h6>
                    <p class="text-muted small mb-3">{{ aplicacao.avaliado.nome }}</p>

                    <div class="d-flex align-items-center text-muted small mb-3">
                        <i class="far fa-clock me-2"></i>
                        <span>{{ aplicacao.data_inicio.strftime('%d/%m %H:%M') }}</span>
                    </div>

                    <hr class="my-3">

                    <div id="status-conexao"
                        class="alert alert-light border d-flex align-items-center justify-content-center py-2 mb-3">
                        <i class="fas fa-spinner fa-spin me-2"></i> <span class="fw-bold"
                            style="font-size: 0.85rem;">Carregando...</span>
                    </div>

                    <button type="button" class="btn btn-info text-white w-100 fw-bold mb-2 shadow-sm"
                        id="btn-force-sync" onclick="forcarSincronizacaoManual()">
                        <i class="fas fa-sync-alt me-2"></i> Sincronizar Agora
                    </button>

                    <button type="button" class="btn btn-outline-primary w-100 fw-bold mb-2" id="btn-offline-sync"
                        onclick="baixarParaOffline()">
                        <i class="fas fa-download me-2"></i> Baixar Offline
                    </button>

                    <div class="text-center mt-2">
                        <small class="text-muted" id="contador-pendencias">Verificando...</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <form id="form-finalizar"
                action="{{ url_for('cli.finalizar_definitivamente', id=aplicacao.id) if modo_assinatura else url_for('cli.concluir_coleta', id=aplicacao.id) }}"
                method="POST" enctype="multipart/form-data">

                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="accordion" id="accordionTopicos">
                    {% for topico in topicos %}
                    <div class="accordion-item border-0 shadow-sm mb-3 rounded overflow-hidden">
                        <h2 class="accordion-header" id="heading-{{ topico.id }}">
                            <button class="accordion-button collapsed py-3 bg-white" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapse-{{ topico.id }}">
                                <div class="d-flex w-100 justify-content-between align-items-center me-3">
                                    <div>
                                        <span class="fw-bold text-dark" style="font-size: 1.05rem;">
                                            {{ topico.ordem }}. {{ topico.nome }}
                                        </span>
                                        {% if topico.descricao %}
                                        <div class="text-muted small mt-1 fw-normal">{{ topico.descricao }}</div>
                                        {% endif %}
                                    </div>
                                    <span class="badge bg-secondary badge-progresso rounded-pill"
                                        id="badge-topico-{{ topico.id }}">0/0</span>
                                </div>
                            </button>
                        </h2>

                        <div id="collapse-{{ topico.id }}" class="accordion-collapse collapse"
                            data-bs-parent="#accordionTopicos">
                            <div class="accordion-body bg-light pt-4 pb-2">

                                {% if perguntas_por_topico[topico.id] %}
                                {% for pergunta in perguntas_por_topico[topico.id] %}
                                {% set eh_assinatura = (pergunta.tipo.name == 'ASSINATURA') %}
                                {% set deve_validar = (pergunta.obrigatoria and (not eh_assinatura or modo_assinatura))
                                %}
                                {% set resposta_salva = respostas_existentes.get(pergunta.id) %}

                                <div class="card mb-3 border-0 shadow-sm question-card"
                                    id="container-pergunta-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                    data-topico-id="{{ topico.id }}"
                                    data-obrigatoria="{{ 'true' if deve_validar else 'false' }}">

                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between mb-2">
                                            <label class="form-label fw-bold text-dark mb-0 w-100">
                                                <span class="badge bg-secondary me-2">{{ topico.ordem }}.{{
                                                    pergunta.ordem }}</span>
                                                {{ pergunta.texto }}
                                                {% if pergunta.obrigatoria %}<span class="text-danger ms-1">*</span>{%
                                                endif %}
                                            </label>
                                            <span id="status-icon-{{ pergunta.id }}" class="ms-2"></span>
                                        </div>

                                        <div class="resposta-wrapper ms-1">
                                            {% if pergunta.tipo.name == 'SIM_NAO_NA' %}
                                            <div class="btn-group w-100" role="group">
                                                {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                                <input type="radio" class="btn-check input-conforme input-progresso"
                                                    name="resposta-{{ pergunta.id }}"
                                                    id="opcao-{{ pergunta.id }}-{{ opcao.id }}"
                                                    value="{{ opcao.texto }}" data-pergunta-id="{{ pergunta.id }}"
                                                    onchange="verificarConformidade(this)" {% if resposta_salva and
                                                    resposta_salva.resposta==opcao.texto %}checked{% endif %}>
                                                <label class="btn btn-outline-secondary"
                                                    for="opcao-{{ pergunta.id }}-{{ opcao.id }}">
                                                    {{ opcao.texto }}
                                                </label>
                                                {% endfor %}
                                            </div>

                                            {% elif pergunta.tipo.name == 'MULTIPLA_ESCOLHA' %}
                                            <select class="form-select input-conforme input-progresso"
                                                name="resposta-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                                onchange="verificarConformidade(this)">
                                                <option value="">Selecione...</option>
                                                {% for opcao in pergunta.opcoes|sort(attribute='ordem') %}
                                                <option value="{{ opcao.texto }}" {% if resposta_salva and
                                                    resposta_salva.resposta==opcao.texto %}selected{% endif %}>
                                                    {{ opcao.texto }}
                                                </option>
                                                {% endfor %}
                                            </select>

                                            {% elif pergunta.tipo.name in ['NOTA', 'ESCALA_NUMERICA', 'NUMERO'] %}
                                            <input type="number" class="form-control input-progresso"
                                                name="resposta-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                                value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                                onblur="salvarResposta(this); atualizarProgressoGlobal();" step="any">

                                            {% elif pergunta.tipo.name == 'TEXTO_CURTO' %}
                                            <input type="text" class="form-control input-progresso"
                                                name="resposta-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                                value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                                onblur="salvarResposta(this); atualizarProgressoGlobal();">

                                            {% elif pergunta.tipo.name == 'TEXTO_LONGO' %}
                                            <textarea class="form-control input-progresso" rows="3"
                                                name="resposta-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                                onblur="salvarResposta(this); atualizarProgressoGlobal();">{{ resposta_salva.resposta if resposta_salva else '' }}</textarea>

                                            {% elif pergunta.tipo.name == 'DATA' %}
                                            <input type="date" class="form-control input-progresso"
                                                name="resposta-{{ pergunta.id }}" data-pergunta-id="{{ pergunta.id }}"
                                                value="{{ resposta_salva.resposta if resposta_salva else '' }}"
                                                onblur="salvarResposta(this); atualizarProgressoGlobal();">

                                            {% elif pergunta.tipo.name == 'ASSINATURA' %}
                                            <div class="border rounded p-3 text-center bg-light">
                                                <div id="preview-box-{{ pergunta.id }}"
                                                    class="mb-3 d-flex justify-content-center align-items-center bg-white border rounded"
                                                    style="min-height: 100px;">
                                                    {% if resposta_salva and resposta_salva.resposta %}
                                                    <img src="{{ resposta_salva.resposta }}"
                                                        id="img-preview-{{ pergunta.id }}"
                                                        style="max-height: 90px; max-width: 100%;">
                                                    <span id="placeholder-{{ pergunta.id }}"
                                                        class="d-none text-muted small">Assinado</span>
                                                    {% else %}
                                                    <img src="" id="img-preview-{{ pergunta.id }}"
                                                        style="max-height: 90px; max-width: 100%; display: none;">
                                                    <span id="placeholder-{{ pergunta.id }}" class="text-muted small"><i
                                                            class="fas fa-signature fa-2x mb-2 d-block"></i>Toque para
                                                        assinar</span>
                                                    {% endif %}
                                                </div>
                                                <input type="hidden" name="resposta-{{ pergunta.id }}"
                                                    id="resposta-input-{{ pergunta.id }}" class="input-progresso"
                                                    data-pergunta-id="{{ pergunta.id }}"
                                                    value="{{ resposta_salva.resposta if resposta_salva else '' }}">

                                                <button type="button" class="btn btn-dark w-100"
                                                    onclick="abrirModalAssinatura({{ pergunta.id }}, '{{ pergunta.texto|escape }}')">
                                                    <i class="fas fa-pen-nib me-2"></i> Assinar
                                                </button>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="bg-light rounded p-2 mt-2 border border-dotted">

                                            {% if pergunta.permite_observacao %}
                                            <div class="mb-2">
                                                <a class="text-decoration-none text-muted fw-bold"
                                                    style="font-size: 0.8rem; cursor: pointer;"
                                                    data-bs-toggle="collapse" href="#collapseObs{{ pergunta.id }}"
                                                    id="btn-obs-{{ pergunta.id }}">
                                                    <i class="far fa-comment-alt me-1"></i> Observação
                                                </a>
                                                <div class="collapse {% if (resposta_salva and resposta_salva.observacao) %}show{% endif %}"
                                                    id="collapseObs{{ pergunta.id }}">
                                                    <textarea class="form-control form-control-sm mt-1"
                                                        id="obs-{{ pergunta.id }}" name="observacao-{{ pergunta.id }}"
                                                        data-pergunta-id="{{ pergunta.id }}"
                                                        onblur="salvarResposta(this, true)" rows="2"
                                                        placeholder="Detalhes...">{{ resposta_salva.observacao if resposta_salva else '' }}</textarea>
                                                </div>
                                            </div>
                                            {% endif %}

                                            {% if pergunta.criterio_foto != 'nenhuma' %}
                                            <div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted fw-bold" style="font-size: 0.8rem;">
                                                        <i class="fas fa-camera me-1"></i> Fotos
                                                        <span
                                                            class="badge {% if pergunta.criterio_foto == 'obrigatoria' %}bg-secondary{% else %}bg-light text-dark border{% endif %} badge-status-foto ms-1">
                                                            {{ 'Obrigatória' if pergunta.criterio_foto == 'obrigatoria'
                                                            else 'Opcional' }}
                                                        </span>
                                                    </span>
                                                    <label for="input-foto-{{ pergunta.id }}"
                                                        class="btn btn-sm btn-outline-primary py-0"
                                                        style="font-size: 0.8rem;">
                                                        <i class="fas fa-plus me-1"></i>
                                                    </label>
                                                    <input type="file" class="d-none" id="input-foto-{{ pergunta.id }}"
                                                        accept="image/*" data-pergunta-id="{{ pergunta.id }}"
                                                        data-criterio-original="{{ pergunta.criterio_foto }}" {% if
                                                        pergunta.criterio_foto=='obrigatoria' %}data-obrigatoria="true"
                                                        {% endif %} onchange="handleFotoUpload(this)">
                                                </div>

                                                <div id="galeria-fotos-{{ pergunta.id }}"
                                                    class="d-flex gap-2 overflow-auto py-2"
                                                    style="white-space: nowrap;">
                                                    {% if resposta_salva and resposta_salva.fotos %}
                                                    {% for foto in resposta_salva.fotos %}
                                                    <div class="position-relative d-inline-block flex-shrink-0 me-2"
                                                        id="foto-server-{{ foto.id }}"
                                                        style="width: 70px; height: 70px;">
                                                        <img src="{{ url_for('cli.get_foto_resposta', filename=foto.caminho) }}"
                                                            class="rounded w-100 h-100 border"
                                                            style="object-fit: cover; cursor: pointer;"
                                                            onclick="window.open(this.src, '_blank')">
                                                        <button type="button"
                                                            class="btn btn-danger btn-sm p-0 position-absolute top-0 end-0 translate-middle rounded-circle shadow-sm"
                                                            style="width: 20px; height: 20px; font-size: 10px; z-index: 10;"
                                                            onclick="deletarFotoServidor({{ foto.id }})"><i
                                                                class="fas fa-times"></i></button>
                                                    </div>
                                                    {% endfor %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                {% else %}
                                <div class="text-center py-3 text-muted">Nenhuma pergunta.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="card shadow border-0 mt-4 mb-5" id="card-conclusao">
                    <div class="card-body p-4">
                        <h5 class="card-title fw-bold mb-3">Finalização</h5>
                        <div class="mb-3">
                            <label class="form-label text-muted small fw-bold text-uppercase">Observações Gerais</label>
                            <textarea class="form-control bg-light" name="observacoes_finais"
                                rows="3">{{ aplicacao.observacoes_finais or '' }}</textarea>
                        </div>

                        <div class="alert alert-danger d-none shadow-sm" id="alerta-validacao">
                            <h6 class="alert-heading fw-bold"><i class="fas fa-exclamation-triangle me-2"></i>Pendências
                            </h6>
                            <ul id="alerta-validacao-lista" class="mb-0 small ps-3"></ul>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{{ url_for('cli.listar_aplicacoes') }}"
                                class="btn btn-outline-secondary px-4">Voltar</a>
                            {% if modo_assinatura %}
                            <button type="submit" class="btn btn-success btn-lg px-5 fw-bold">
                                <i class="fas fa-check-double me-2"></i> Encerrar
                            </button>
                            {% else %}
                            <button type="submit" class="btn btn-primary btn-lg px-5 fw-bold">
                                <i class="fas fa-paper-plane me-2"></i> Concluir
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAssinaturaUnico" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title">Assinatura</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-0"><canvas id="canvas-unico"
                    style="width: 100%; height: 250px; background: #fff;"></canvas></div>
            <div class="modal-footer justify-content-between bg-white">
                <button type="button" class="btn btn-outline-danger btn-sm"
                    onclick="limparCanvasAtual()">Limpar</button>
                <button type="button" class="btn btn-success btn-sm px-4"
                    onclick="confirmarAssinaturaModal()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
    const APLICACAO_ID = {{ aplicacao.id }};
    const MODO_ASSINATURA = {{ 'true' if modo_assinatura else 'false' }};
    const CSRF_TOKEN = '{{ csrf_token() }}';

    // =========================================================
    // 1. BANCO DE DADOS LOCAL (Dexie) - VERSÃO 3
    // =========================================================
    const dbLocal = new Dexie("QualiGestorDB");
    window.dbLocal = dbLocal;

    dbLocal.version(3).stores({
        respostas_pendentes: 'pergunta_id, aplicacao_id, dados_completos, timestamp', 
        fotos_pendentes: 'id, aplicacao_id, pergunta_id, resposta_id, blob, nome, timestamp', 
        fila_deletar: 'id_item, tipo, timestamp' 
    });

    let signaturePadGlobal = null;
    let currentPerguntaId = null;
    const modalElement = document.getElementById('modalAssinaturaUnico');
    const modalAssinatura = new bootstrap.Modal(modalElement);

    // =========================================================
    // 2. INICIALIZAÇÃO
    // =========================================================
    document.addEventListener('DOMContentLoaded', async () => {
        initCanvas();
        reconhecerRespostasExistentes(); 
        
        // Recupera dados salvos localmente
        await restaurarEstadoOffline();

        atualizarProgressoGlobal();
        atualizarContadorPendencias();

        window.addEventListener('online', () => {
            updateStatusConexao(true);
            sincronizarTudo();
        });
        window.addEventListener('offline', () => updateStatusConexao(false));
        updateStatusConexao(navigator.onLine);

        if (navigator.onLine) sincronizarTudo();
    });

    // =========================================================
    // 3. CORE: SALVAR (TEXTOS)
    // =========================================================
    async function salvarResposta(input, isObs = false) {
        const pid = input.dataset.perguntaId;
        const icon = document.getElementById(`status-icon-${pid}`);
        if (icon) icon.innerHTML = '<i class="fas fa-spinner fa-spin text-muted"></i>';

        let resp = '', obs = '';
        if (isObs) {
            obs = input.value;
            const r = document.querySelector(`input[name="resposta-${pid}"]:checked`) || document.querySelector(`[name="resposta-${pid}"]:not([type="radio"])`);
            if (r) resp = r.value;
        } else {
            resp = input.value;
            const o = document.getElementById(`obs-${pid}`);
            if (o) obs = o.value;
        }

        const payload = {
            pergunta_id: pid,
            aplicacao_id: APLICACAO_ID,
            resposta: resp,
            observacao: obs,
            timestamp: Date.now()
        };

        try {
            await dbLocal.respostas_pendentes.put({
                pergunta_id: pid,
                aplicacao_id: APLICACAO_ID,
                dados_completos: payload,
                timestamp: Date.now()
            });

            if (icon) icon.innerHTML = '<i class="fas fa-save text-warning" title="Salvo no Dispositivo"></i>';
            atualizarContadorPendencias();

            if (navigator.onLine) {
                await sincronizarUmaResposta(pid);
            }
        } catch (e) {
            console.error("Erro crítico ao salvar local:", e);
            if (icon) icon.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i>';
            alert("Erro de armazenamento local (Espaço cheio?)");
        }
    }

    // =========================================================
    // 4. SINCRONIZAÇÃO (NUVEM)
    // =========================================================
    async function sincronizarUmaResposta(pid) {
        const item = await dbLocal.respostas_pendentes.get(pid);
        if (!item) return; 

        const icon = document.getElementById(`status-icon-${pid}`);

        try {
            const res = await fetch("{{ url_for('cli.salvar_resposta', id=aplicacao.id) }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                body: JSON.stringify(item.dados_completos)
            });

            if (res.ok) {
                const d = await res.json();
                await dbLocal.respostas_pendentes.delete(pid);

                if (icon) icon.innerHTML = '<i class="fas fa-check text-success" title="Salvo na Nuvem"></i>';
                setTimeout(() => { if (icon.innerHTML.includes('fa-check')) icon.innerHTML = ''; }, 2000);

                // Se salvou o texto e gerou ID, verifica se tinha foto esperando esse ID
                if (d.resposta_id) {
                    const inputs = document.querySelectorAll(`[data-pergunta-id="${pid}"]`);
                    inputs.forEach(el => el.dataset.respostaId = d.resposta_id);
                    verificarFotosPendentes(pid, d.resposta_id);
                }
                atualizarContadorPendencias();
            }
        } catch (e) {
            console.log("Sync texto falhou, mantendo local.");
        }
    }

    async function sincronizarTudo() {
    if (!navigator.onLine) return;

    const toastEl = document.getElementById('liveToast');
    const toast = new bootstrap.Toast(toastEl);
    let mostrouToast = false;

    // =================================================================
    // 1. TEXTOS (RESPOSAS) - ESSENCIAL RODAR PRIMEIRO
    // =================================================================
    // Isso garante que a resposta exista no servidor para vincularmos a foto depois
    const pendentesTexto = await dbLocal.respostas_pendentes.where('aplicacao_id').equals(APLICACAO_ID).toArray();
    
    if (pendentesTexto.length > 0) {
        if(!mostrouToast) { toast.show(); mostrouToast = true; }
        
        for (const item of pendentesTexto) {
            await sincronizarUmaResposta(item.pergunta_id);
        }
    }

    // =================================================================
    // 2. FOTOS (Lógica Blindada para iOS)
    // =================================================================
    const countFotos = await dbLocal.fotos_pendentes.where('aplicacao_id').equals(APLICACAO_ID).count();

    if (countFotos > 0) {
        if(!mostrouToast) { toast.show(); mostrouToast = true; }

        // Pega apenas os IDs (super leve) para não estourar a memória
        const idsFotos = await dbLocal.fotos_pendentes.where('aplicacao_id').equals(APLICACAO_ID).primaryKeys();

        for (const idFoto of idsFotos) {
            // Carrega UMA foto por vez para a memória RAM
            const f = await dbLocal.fotos_pendentes.get(idFoto);

            if (f) {
                let rid = f.resposta_id;

                // Tenta achar o ID da resposta se não tiver (Fallback visual)
                if (!rid) {
                    const inp = document.querySelector(`[data-pergunta-id="${f.pergunta_id}"]`);
                    if (inp && inp.dataset.respostaId) rid = inp.dataset.respostaId;
                }

                if (rid) {
                    const div = document.getElementById(`foto-local-${f.id}`);
                    const elVisual = div || document.createElement('div'); 

                    // Envia e ESPERA terminar antes de pegar a próxima (await)
                    await enviarFoto(f.blob, f.nome, f.pergunta_id, f.id, rid, elVisual);
                }
            }
            // O Garbage Collector limpa a foto anterior da memória aqui
        }
    }

    // =================================================================
    // 3. DELEÇÕES (Limpeza do que foi apagado offline)
    // =================================================================
    const deletes = await dbLocal.fila_deletar.toArray();
    for (const del of deletes) {
        if (del.tipo === 'foto') {
            try {
                await fetch(`/cli/foto/${del.id_item}/deletar`, { 
                    method: 'DELETE', 
                    headers: { 'X-CSRFToken': CSRF_TOKEN } 
                });
                await dbLocal.fila_deletar.where('id_item').equals(del.id_item).delete();
            } catch (e) {
                console.log("Erro ao sincronizar deleção:", e);
            }
        }
    }

    atualizarContadorPendencias();
}

    async function verificarFotosPendentes(pid, rid) {
        const fotos = await dbLocal.fotos_pendentes.where('pergunta_id').equals(String(pid)).toArray();
        for(let f of fotos) {
            if(!f.resposta_id) {
                f.resposta_id = rid;
                await dbLocal.fotos_pendentes.put(f);
                const div = document.getElementById(`foto-local-${f.id}`);
                if(div) enviarFoto(f.blob, f.nome, pid, f.id, rid, div);
            }
        }
    }

    async function atualizarContadorPendencias() {
        const qtdTexto = await dbLocal.respostas_pendentes.where('aplicacao_id').equals(APLICACAO_ID).count();
        const qtdFotos = await dbLocal.fotos_pendentes.where('aplicacao_id').equals(APLICACAO_ID).count();
        const total = qtdTexto + qtdFotos;

        const el = document.getElementById('contador-pendencias');
        if (!el) return;

        if (total === 0) {
            el.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Tudo sincronizado</span>';
        } else {
            el.innerHTML = `<span class="text-warning fw-bold"><i class="fas fa-exclamation-circle"></i> ${total} item(s) pendente(s)</span>`;
        }
    }

    // =========================================================
    // 5. UPLOAD DE FOTOS (CORRIGIDO PARA ERRO 400)
    // =========================================================
    
   // =========================================================
    // NOVA FUNÇÃO AUXILIAR: COMPRESSÃO DE IMAGEM
    // Reduz drasticamente o tamanho do arquivo antes de salvar
    // =========================================================
    function comprimirImagem(file, maxWidth = 1280, quality = 0.7) {
    return new Promise((resolve, reject) => {
        // MUDANÇA CRÍTICA: Usamos createObjectURL em vez de FileReader
        // Isso evita carregar a imagem inteira como texto na RAM (Base64)
        const imgUrl = URL.createObjectURL(file);
        const img = new Image();
        
        img.src = imgUrl; 
        
        img.onload = () => {
            // Libera a memória do "link" imediatamente
            URL.revokeObjectURL(imgUrl); 

            let width = img.width;
            let height = img.height;

            // Mantém a proporção
            if (width > maxWidth) {
                height = Math.round(height * maxWidth / width);
                width = maxWidth;
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Desenha redimensionado
            ctx.drawImage(img, 0, 0, width, height);

            // Converte para Blob (Arquivo leve)
            canvas.toBlob((blob) => {
                if (!blob) {
                    reject(new Error('Erro na compressão.'));
                    return;
                }
                // Recria o arquivo com o nome original
                const compressedFile = new File([blob], file.name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                resolve(compressedFile);
            }, 'image/jpeg', quality);
        };
        
        img.onerror = (e) => {
            URL.revokeObjectURL(imgUrl);
            reject(e);
        };
    });
}

    // =========================================================
    // 5. UPLOAD DE FOTOS (ATUALIZADO COM COMPRESSÃO)
    // =========================================================
    // ARQUIVO: app/cli/templates/cli/responder_aplicacao.html

// ARQUIVO: app/cli/templates/cli/responder_aplicacao.html

async function handleFotoUpload(input) {
    if (!input.files || input.files.length === 0) return;
    
    const fileOriginal = input.files[0];
    const pid = input.dataset.perguntaId;
    let rid = input.dataset.respostaId;

    // 1. TRAVA VISUAL
    const labelBtn = document.querySelector(`label[for="input-foto-${pid}"]`);
    const iconeOriginal = labelBtn ? labelBtn.innerHTML : '';
    if (labelBtn) {
        labelBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
        labelBtn.classList.add('disabled', 'btn-warning'); 
        input.disabled = true;
    }

    try {
        // 2. COMPRESSÃO (Mantendo a que funciona)
        const file = await comprimirImagem(fileOriginal, 1024, 0.6);
        input.value = ''; 

        // Garante RID
        if (!rid) {
            await salvarResposta(document.querySelector(`[name="resposta-${pid}"]`));
            const el = document.querySelector(`[data-pergunta-id="${pid}"]`);
            rid = el ? el.dataset.respostaId : null;
        }

        // 3. DECISÃO DE SALVAMENTO
        if (navigator.onLine && rid) {
            // ONLINE: Tenta envio direto (Bypass do banco)
            console.log("Online: Tentando envio direto...");
            await enviarDiretoParaServidor(file, pid, rid);
        } else {
            // OFFLINE: Salva no dispositivo
            console.log("Offline: Salvando no dispositivo...");
            const tid = Date.now();
            
            try {
                // Tenta salvar como ARQUIVO (Blob)
                await dbLocal.fotos_pendentes.add({
                    id: tid,
                    aplicacao_id: APLICACAO_ID,
                    pergunta_id: pid,
                    resposta_id: rid || null,
                    blob: file, 
                    tipo: 'blob', // Marcador
                    nome: file.name, 
                    timestamp: Date.now()
                });
                // CORREÇÃO DO ERRO URL AQUI NA CHAMADA:
                criarPreviewLocal(pid, tid, file); 

            } catch (erroBlob) {
                // SE DER "FEATURE IS DISABLED", ENTRA AQUI (PLANO B)
                console.warn("Blob bloqueado pelo navegador. Convertendo para Texto...", erroBlob);
                
                try {
                    const base64 = await blobParaBase64(file);
                    await dbLocal.fotos_pendentes.add({
                        id: tid,
                        aplicacao_id: APLICACAO_ID,
                        pergunta_id: pid,
                        resposta_id: rid || null,
                        blob: base64, // Salva o texto gigante
                        tipo: 'base64', // Marcador importante
                        nome: file.name, 
                        timestamp: Date.now()
                    });
                    criarPreviewLocal(pid, tid, file);
                    console.log("Salvo com sucesso em modo Texto (Base64).");
                } catch (erroFatal) {
                    alert("Erro: Seu dispositivo está impedindo salvar fotos offline.");
                    console.error(erroFatal);
                }
            }
        }

    } catch (erroGeral) {
        console.error("Erro processo:", erroGeral);
        alert("Falha ao processar foto.");
    } finally {
        if (labelBtn) {
            labelBtn.innerHTML = iconeOriginal;
            labelBtn.classList.remove('disabled', 'btn-warning');
            input.disabled = false;
        }
    }
}

// --- FUNÇÃO DE PREVIEW CORRIGIDA (WINDOW.URL) ---
function criarPreviewLocal(pid, tid, file) {
    const g = document.getElementById(`galeria-fotos-${pid}`);
    const d = document.createElement('div');
    d.id = `foto-local-${tid}`;
    d.className = 'position-relative d-inline-block flex-shrink-0 me-2';
    d.style.width = '70px'; d.style.height = '70px';
    
    // CORREÇÃO CRÍTICA 1: Usar window.URL explicitamente
    const imgUrl = window.URL.createObjectURL(file);
    
    // CORREÇÃO CRÍTICA 2: Usar window.URL.revokeObjectURL dentro do HTML string
    d.innerHTML = `
        <img src="${imgUrl}" class="rounded w-100 h-100 border border-warning" 
             style="object-fit:cover;" onload="window.URL.revokeObjectURL(this.src)"> 
        <div class="position-absolute top-50 start-50 translate-middle status-icon">
            <i class="fas fa-clock text-warning"></i>
        </div>
        <button type="button" class="btn btn-danger btn-sm p-0 position-absolute top-0 end-0 translate-middle rounded-circle shadow-sm" 
                style="width:20px;height:20px;font-size:10px;z-index:10;" onclick="deletarFotoLocal(${tid})">
            <i class="fas fa-times"></i>
        </button>
    `;
    g.appendChild(d);
}

// Helper para converter Blob em Texto (Base64)
function blobParaBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// Helper para converter Blob em Texto (Base64)
function blobParaBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

// --- FUNÇÃO AUXILIAR 1: ENVIO DIRETO (Sem passar pelo banco local) ---
async function enviarDiretoParaServidor(file, pid, rid) {
    // Cria um preview temporário de "Carregando..."
    const g = document.getElementById(`galeria-fotos-${pid}`);
    const tempId = 'temp-' + Date.now();
    const d = document.createElement('div');
    d.id = tempId;
    d.className = 'position-relative d-inline-block flex-shrink-0 me-2';
    d.style.width = '70px'; d.style.height = '70px';
    d.innerHTML = `<div class="d-flex align-items-center justify-content-center w-100 h-100 bg-light border rounded"><i class="fas fa-circle-notch fa-spin text-primary"></i></div>`;
    g.appendChild(d);

    try {
        const fd = new FormData();
        // Garante nome seguro
        let safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '');
        if (!safeName.toLowerCase().endsWith('.jpg')) safeName += '.jpg';
        
        fd.append('foto', file, safeName);

        const r = await fetch(`/cli/resposta/${rid}/upload-foto`, {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN },
            body: fd
        });

        if (r.ok) {
            const data = await r.json();
            // SUCESSO! Substitui o loading pela foto oficial do servidor (Borda Verde)
            d.outerHTML = `
                <div class="position-relative d-inline-block flex-shrink-0 me-2" id="foto-server-${data.foto_id}" style="width: 70px; height: 70px;">
                    <img src="${URL.createObjectURL(file)}" class="rounded w-100 h-100 border border-success" style="object-fit: cover; cursor: pointer;" onclick="window.open(this.src)">
                    <button type="button" class="btn btn-danger btn-sm p-0 position-absolute top-0 end-0 translate-middle rounded-circle shadow-sm" style="width: 20px; height: 20px; font-size: 10px; z-index: 10;" onclick="deletarFotoServidor(${data.foto_id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>`;
        } else {
            throw new Error("Servidor rejeitou");
        }
    } catch (e) {
        console.warn("Falha no envio direto. Caindo para o modo offline...", e);
        d.remove(); // Remove o loading
        await salvarLocalmente(file, pid, rid); // FALLBACK: Tenta salvar local
    }
}

// --- FUNÇÃO AUXILIAR 2: SALVAR LOCAL (Só usada se estiver offline ou falhar envio) ---
async function salvarLocalmente(file, pid, rid) {
    const tid = Date.now();
    
    try {
        await dbLocal.fotos_pendentes.add({
            id: tid,
            aplicacao_id: APLICACAO_ID,
            pergunta_id: pid,
            resposta_id: rid || null,
            blob: file, 
            nome: file.name, 
            timestamp: Date.now()
        });
        atualizarContadorPendencias();

        // Cria Preview Amarelo (Pendente)
        const g = document.getElementById(`galeria-fotos-${pid}`);
        const d = document.createElement('div');
        d.id = `foto-local-${tid}`;
        d.className = 'position-relative d-inline-block flex-shrink-0 me-2';
        d.style.width = '70px'; d.style.height = '70px';
        const imgUrl = URL.createObjectURL(file);
        
        d.innerHTML = `
            <img src="${imgUrl}" class="rounded w-100 h-100 border border-warning" 
                 style="object-fit:cover;" onload="URL.revokeObjectURL(this.src)"> 
            <div class="position-absolute top-50 start-50 translate-middle status-icon">
                <i class="fas fa-clock text-warning"></i>
            </div>
            <button type="button" class="btn btn-danger btn-sm p-0 position-absolute top-0 end-0 translate-middle rounded-circle shadow-sm" 
                    style="width:20px;height:20px;font-size:10px;z-index:10;" onclick="deletarFotoLocal(${tid})">
                <i class="fas fa-times"></i>
            </button>
        `;
        g.appendChild(d);

    } catch (e) {
        if (e.name === 'QuotaExceededError') {
            alert("Memória do celular cheia! Conecte na internet para liberar espaço.");
        } else {
            alert("Erro ao salvar foto offline.");
        }
    }
}

   // --- FUNÇÃO CORRIGIDA E BLINDADA ---
    async function enviarFoto(blobOuFile, nomeArquivo, pid, tid, rid, div) {
        const fd = new FormData();
        
        // 1. GARANTIA DE NOME (Checklist de Segurança)
        let nomeFinal = nomeArquivo;
        
        // Se veio nulo ou indefinido, cria um genérico
        if (!nomeFinal || nomeFinal === 'undefined') {
            nomeFinal = `foto_recuperada_${Date.now()}.jpg`;
        }

        // 2. GARANTIA DE EXTENSÃO (O erro 400 acontece aqui)
        // O servidor Python exige que termine com .jpg, .png, etc.
        const nomeLower = nomeFinal.toLowerCase();
        if (!nomeLower.endsWith('.jpg') && 
            !nomeLower.endsWith('.jpeg') && 
            !nomeLower.endsWith('.png') && 
            !nomeLower.endsWith('.webp')) {
            // Se não tiver extensão, FORÇAMOS .jpg
            nomeFinal += '.jpg';
        }

        // 3. GARANTIA DE TIPO MIME
        // Se o blob perdeu o tipo, assumimos jpeg
        let mimeType = blobOuFile.type;
        if (!mimeType || mimeType === '') {
            mimeType = 'image/jpeg';
        }

        console.log(`[Upload] Preparando: ${nomeFinal} | Tipo: ${mimeType} | Tamanho: ${blobOuFile.size}`);

        // 4. RECRIAÇÃO DO ARQUIVO
        // Recriamos o File object explicitamente para garantir integridade
        const arquivoParaEnvio = new File([blobOuFile], nomeFinal, { type: mimeType });

        // Adiciona ao FormData com o nome explícito no 3º argumento
        fd.append('foto', arquivoParaEnvio, nomeFinal);

        try {
            const r = await fetch(`/cli/resposta/${rid}/upload-foto`, {
                method: 'POST',
                headers: { 'X-CSRFToken': CSRF_TOKEN },
                body: fd
            });

            if (r.ok) {
                const data = await r.json();
                if (data.sucesso) {
                    console.log("[Upload] Sucesso:", data);
                    
                    // Remove do banco local
                    await dbLocal.fotos_pendentes.delete(tid);
                    
                    // Atualiza visual
                    if(div && div.parentNode) {
                        div.outerHTML = `
                            <div class="position-relative d-inline-block flex-shrink-0 me-2" id="foto-server-${data.foto_id}" style="width: 70px; height: 70px;">
                                <img src="${URL.createObjectURL(arquivoParaEnvio)}" class="rounded w-100 h-100 border border-success" style="object-fit: cover; cursor: pointer;" onclick="window.open(this.src)">
                                <button type="button" class="btn btn-danger btn-sm p-0 position-absolute top-0 end-0 translate-middle rounded-circle shadow-sm" style="width: 20px; height: 20px; font-size: 10px; z-index: 10;" onclick="deletarFotoServidor(${data.foto_id})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                    }
                    atualizarContadorPendencias();
                }
            } else {
                // Se der erro, mostra exatamente o que o servidor respondeu
                const erroTexto = await r.text();
                console.error("[Upload] Erro Servidor:", r.status, erroTexto);
                // IMPORTANTE: Se o erro for 400 (arquivo inválido), deletamos do local para não travar a fila
                // Se for arquivo inválido, não adianta tentar de novo.
                if (r.status === 400) {
                     console.warn("[Upload] Removendo arquivo corrompido/inválido da fila local.");
                     await dbLocal.fotos_pendentes.delete(tid);
                     if(div) div.remove();
                     atualizarContadorPendencias();
                }
            }
        } catch (e) {
            console.log("[Upload] Falha de Rede (Offline?) ou Código:", e);
        }
    }

    window.deletarFotoLocal = async (id) => {
        if (!confirm('Remover esta foto pendente?')) return;
        const el = document.getElementById(`foto-local-${id}`);
        if (el) el.remove();
        await dbLocal.fotos_pendentes.delete(id);
        atualizarContadorPendencias();
    };

    window.deletarFotoServidor = async (id) => {
        if (!confirm('Apagar esta foto do servidor?')) return;
        const el = document.getElementById(`foto-server-${id}`);
        if (el) el.remove(); 

        if (navigator.onLine) {
            try {
                const res = await fetch(`/cli/foto/${id}/deletar`, { method: 'DELETE', headers: { 'X-CSRFToken': CSRF_TOKEN } });
                if (!res.ok) throw new Error();
            }
            catch (e) { await agendarDelecao(id); }
        } else {
            await agendarDelecao(id);
        }
    };

    async function agendarDelecao(id) {
        await dbLocal.fila_deletar.put({ id_item: id, tipo: 'foto', timestamp: Date.now() });
        atualizarContadorPendencias();
    }

    // =========================================================
    // 6. UI & VALIDAÇÃO
    // =========================================================
    function reconhecerRespostasExistentes() {
        document.querySelectorAll('.question-card').forEach(card => {
            const radio = card.querySelector('input[type="radio"]:checked');
            const text = card.querySelector('input[type="text"], input[type="number"], input[type="date"], textarea, select');
            if (radio) verificarConformidade(radio);
            else if (text && text.value) verificarConformidade(text);
        });
    }

    function verificarConformidade(input) {
        salvarResposta(input); 
        aplicarRegraConformidade(input);
        atualizarProgressoGlobal();
    }

    function aplicarRegraConformidade(input) {
        const pid = input.dataset.perguntaId;
        const container = document.getElementById(`container-pergunta-${pid}`);
        if (!container) return;

        const val = input.value.toLowerCase().trim();
        const isNC = ['não', 'nao', '0', 'ruim', 'irregular', 'não conforme'].includes(val);
        const obsCollapse = document.getElementById(`collapseObs${pid}`);
        const obsInput = document.getElementById(`obs-${pid}`);

        if (isNC) {
            container.classList.add('border-start', 'border-4', 'border-danger');
            if (obsCollapse) new bootstrap.Collapse(obsCollapse, { show: true });
            if (obsInput) {
                obsInput.classList.add('border-danger', 'bg-white');
                obsInput.placeholder = "DESCRIÇÃO OBRIGATÓRIA PARA NÃO CONFORMIDADE";
            }
        } else {
            container.classList.remove('border-start', 'border-4', 'border-danger');
            if (obsInput) {
                obsInput.classList.remove('border-danger', 'bg-white');
                obsInput.placeholder = "Descreva o detalhe...";
            }
        }
    }

    document.getElementById('form-finalizar').addEventListener('submit', function (e) {
        let erros = [];
        let primeiroErroElemento = null;

        document.querySelectorAll('.question-card').forEach(card => {
            const pid = card.dataset.perguntaId;
            const ehObrigatoria = card.dataset.obrigatoria === 'true';
            let respondeu = false;
            const radio = card.querySelector('input[type="radio"]:checked');
            const inputs = card.querySelector('input:not([type="radio"]):not([type="file"]), textarea, select');

            if (radio) {
                respondeu = true;
                const val = radio.value.toLowerCase();
                if (['não', 'nao', 'ruim', 'irregular'].includes(val)) {
                    const obs = document.getElementById(`obs-${pid}`);
                    if (!obs || obs.value.trim() === '') {
                        erros.push(`NC sem descrição: "${card.querySelector('label').innerText.replace('*', '')}"`);
                        obs.classList.add('is-invalid');
                        if (!primeiroErroElemento) primeiroErroElemento = obs;
                        const clps = document.getElementById(`collapseObs${pid}`);
                        if (clps) new bootstrap.Collapse(clps, { show: true });
                        e.preventDefault();
                        return;
                    } else {
                        if (obs) obs.classList.remove('is-invalid');
                    }
                }
            } else if (inputs && inputs.value.trim() !== '') {
                respondeu = true;
            }

            if (ehObrigatoria && !respondeu) {
                erros.push(`Pergunta obrigatória: "${card.querySelector('label').innerText.replace('*', '')}"`);
                card.classList.add('border', 'border-danger');
                if (!primeiroErroElemento) primeiroErroElemento = card;
            } else {
                card.classList.remove('border', 'border-danger');
            }
        });

        if (erros.length > 0) {
            e.preventDefault();
            const lista = document.getElementById('alerta-validacao-lista');
            lista.innerHTML = '';
            erros.slice(0, 5).forEach(err => lista.innerHTML += `<li>${err}</li>`);
            if (erros.length > 5) lista.innerHTML += `<li>+ ${erros.length - 5} pendências...</li>`;

            document.getElementById('alerta-validacao').classList.remove('d-none');
            if (primeiroErroElemento) {
                primeiroErroElemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
                primeiroErroElemento.focus();
            }
            alert("Existem pendências! Verifique se todas as Não Conformidades possuem observação.");
        } else {
            if (!confirm("Deseja realmente finalizar?")) e.preventDefault();
        }
    });

    async function restaurarEstadoOffline() {
        const pendentes = await dbLocal.respostas_pendentes.where('aplicacao_id').equals(APLICACAO_ID).toArray();
        pendentes.forEach(item => {
            const pid = item.pergunta_id;
            const dados = item.dados_completos;
            
            const inputTxt = document.querySelector(`[name="resposta-${pid}"]:not([type="radio"])`);
            if (inputTxt && dados.resposta) {
                inputTxt.value = dados.resposta;
                aplicarRegraConformidade(inputTxt);
            }

            if (dados.resposta) {
                const radio = document.querySelector(`input[name="resposta-${pid}"][value="${dados.resposta}"]`);
                if (radio) {
                    radio.checked = true;
                    aplicarRegraConformidade(radio);
                }
            }

            if (dados.observacao) {
                const obs = document.getElementById(`obs-${pid}`);
                if (obs) obs.value = dados.observacao;
            }
            const icon = document.getElementById(`status-icon-${pid}`);
            if (icon) icon.innerHTML = '<i class="fas fa-save text-warning" title="Pendente"></i>';
        });

        const fotos = await dbLocal.fotos_pendentes.where('aplicacao_id').equals(APLICACAO_ID).toArray();
        fotos.forEach(f => {
            const g = document.getElementById(`galeria-fotos-${f.pergunta_id}`);
            if (g && !document.getElementById(`foto-local-${f.id}`)) {
                const d = document.createElement('div');
                d.id = `foto-local-${f.id}`;
                d.className = 'position-relative d-inline-block flex-shrink-0 me-2';
                d.style.width = '70px'; d.style.height = '70px';
                d.innerHTML = `
                    <img src="${URL.createObjectURL(f.blob)}" class="rounded w-100 h-100 border border-warning" style="object-fit:cover;">
                    <div class="position-absolute top-50 start-50 translate-middle status-icon"><i class="fas fa-clock text-warning"></i></div>
                    <button type="button" class="btn btn-danger btn-sm p-0 position-absolute top-0 end-0 translate-middle rounded-circle shadow-sm" 
                            style="width:20px;height:20px;font-size:10px;z-index:10;" onclick="deletarFotoLocal(${f.id})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                g.appendChild(d);
            }
        });
    }

    // --- MANIPULAÇÃO DE CANVAS E MODAL ---
    function initCanvas() {
        const c = document.getElementById('canvas-unico');
        if (c) { signaturePadGlobal = new SignaturePad(c, { backgroundColor: 'rgb(255,255,255)' }); resizeCanvas(); }
    }
    
    // Pequeno fix para o erro de aria-hidden
    modalElement.addEventListener('show.bs.modal', () => {
        modalElement.removeAttribute('aria-hidden');
    });
    modalElement.addEventListener('shown.bs.modal', resizeCanvas);
    modalElement.addEventListener('hidden.bs.modal', () => {
        modalElement.setAttribute('aria-hidden', 'true');
    });

    function resizeCanvas() {
        const c = document.getElementById('canvas-unico');
        if (c && c.offsetWidth > 0) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            c.width = c.offsetWidth * ratio; c.height = c.offsetHeight * ratio;
            c.getContext("2d").scale(ratio, ratio);
            if (signaturePadGlobal) signaturePadGlobal.clear();
        }
    }
    window.abrirModalAssinatura = (pid, texto) => {
        currentPerguntaId = pid;
        if (signaturePadGlobal) signaturePadGlobal.clear();
        document.querySelector('.modal-title').innerText = texto || 'Assinatura';
        modalAssinatura.show();
    };
    window.confirmarAssinaturaModal = () => {
        if (signaturePadGlobal.isEmpty()) { alert('Assine.'); return; }
        const d = signaturePadGlobal.toDataURL();
        const input = document.getElementById(`resposta-input-${currentPerguntaId}`);
        input.value = d;
        const img = document.getElementById(`img-preview-${currentPerguntaId}`);
        if (img) { img.src = d; img.style.display = 'block'; }
        const ph = document.getElementById(`placeholder-${currentPerguntaId}`);
        if (ph) ph.classList.add('d-none');
        salvarResposta(input); 
        modalAssinatura.hide();
    };
    window.limparCanvasAtual = () => signaturePadGlobal.clear();

    // --- UTILS ---
    function updateStatusConexao(online) {
        const div = document.getElementById('status-conexao');
        const btn = document.getElementById('btn-offline-sync');
        const float = document.getElementById('status-flutuante');
        if (online) {
            if (div) { div.className = 'alert alert-success border py-2 mb-3'; div.innerHTML = '<i class="fas fa-wifi me-2"></i>Online'; }
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-download me-2"></i> Baixar Offline'; }
            if (float) { float.classList.remove('bg-warning'); float.classList.add('bg-success'); float.innerHTML = '<i class="fas fa-wifi fa-lg"></i>'; }
        } else {
            if (div) { div.className = 'alert alert-warning border py-2 mb-3'; div.innerHTML = '<i class="fas fa-cloud-download-alt me-2"></i>Offline'; }
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-check me-2"></i> Operando Offline'; }
            if (float) { float.classList.remove('bg-success'); float.classList.add('bg-warning'); float.innerHTML = '<i class="fas fa-cloud fa-lg"></i>'; }
        }
    }

    function atualizarProgressoGlobal() {
        document.querySelectorAll('.accordion-item').forEach(item => {
            const inputs = item.querySelectorAll('.input-progresso');
            const nomesUnicos = new Set();
            inputs.forEach(inp => nomesUnicos.add(inp.name));
            const total = nomesUnicos.size;
            let respondidas = 0;
            nomesUnicos.forEach(nome => {
                const radios = item.querySelectorAll(`input[name="${nome}"][type="radio"]:checked`);
                const outros = item.querySelectorAll(`[name="${nome}"]:not([type="radio"])`);
                let ok = false;
                if (radios.length > 0) ok = true;
                outros.forEach(o => { if (o.value && o.value.trim() !== '') ok = true; });
                if (ok) respondidas++;
            });
            const badge = item.querySelector('.badge-progresso');
            if (badge) {
                badge.innerText = `${respondidas}/${total}`;
                if (respondidas >= total && total > 0) {
                    badge.className = 'badge bg-success rounded-pill badge-progresso';
                    badge.innerHTML = '<i class="fas fa-check"></i>';
                } else {
                    badge.className = 'badge bg-secondary rounded-pill badge-progresso';
                }
            }
        });
    }

    // ARQUIVO: app/cli/templates/cli/responder_aplicacao.html

async function baixarParaOffline() {
    const btn = document.getElementById('btn-offline-sync');
    const originalHtml = btn.innerHTML;
    
    // 1. Feedback Visual Imediato
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Baixando App Completo...';

    try {
        // TEM QUE SER O MESMO NOME QUE ESTÁ NO service-worker.js
        const CACHE_NAME = 'qualigestor-dynamic-v8'; 
        const cache = await caches.open(CACHE_NAME);

        // 2. LISTA DE ROTAS CRÍTICAS
        // Isso garante que ela consiga sair da auditoria e voltar para o menu
        // mesmo sem internet.
        const urlsEssenciais = [
            '/',                       // A raiz do domínio
            '/cli/',                   // A raiz do painel (MUITO IMPORTANTE)
            '/cli/home',               // O Dashboard real (conforme routes.py)
            '/cli/aplicacoes',         // A Lista real (conforme routes.py)
            window.location.href,      // O Checklist atual
            '/static/css/dashboard.css',
            '/static/css/style.css',   // Adicionei style.css que vi nos seus arquivos
            '/static/js/offline-manager.js',
            '/static/img/logo.jpg'
        ];

        // 3. FORÇA O DOWNLOAD (Bypass no Cache antigo)
        // O '{ cache: "reload" }' obriga o celular a ir na rede buscar a versão mais nova
        await Promise.all(urlsEssenciais.map(url => {
            return cache.add(new Request(url, { cache: 'reload' })).catch(err => {
                console.warn(`[Offline] Aviso: Não consegui baixar ${url}`, err);
                // Não damos throw aqui para não cancelar o resto se uma imagem falhar
            });
        }));

        // 4. PERSISTÊNCIA NO IOS
        // Tenta pedir ao iOS para não limpar os dados se o espaço acabar
        if (navigator.storage && navigator.storage.persist) {
            const isPersisted = await navigator.storage.persist();
            console.log(`[Offline] Persistência iOS ativada: ${isPersisted}`);
        }

        // 5. SUCESSO
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        btn.innerHTML = '<i class="fas fa-check-double"></i> Pronto para uso Offline!';
        
        alert("Sincronização Concluída!\n\nAgora você pode ficar sem internet. Lembre-se: NÃO faça logout. Apenas feche o app.");

    } catch (e) {
        console.error(e);
        alert("Erro ao baixar: " + e.message + "\nVerifique sua conexão e tente novamente.");
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}
    window.forcarSincronizacaoManual = sincronizarTudo;
</script>
<div style="position: fixed; bottom: 10px; left: 10px; z-index: 9999; display: flex; flex-direction: column; gap: 5px;">
    
    <button onclick="debugVerificarBanco()" class="btn btn-dark btn-sm shadow-lg border-white" style="border: 1px solid white;">
        🕵️ <span id="debug-contador">Ver Banco</span>
    </button>
    
    <button onclick="debugLimparBanco()" class="btn btn-danger btn-sm shadow-lg border-white" style="border: 1px solid white; font-size: 10px;">
        🗑️ Limpar Forçado
    </button>

</div>

<script>
    // 1. Função para contar quantos itens estão "presos" no celular
    // VERSÃO "FORENSE" - MOSTRA O TIPO DE DADO SALVO
    async function debugVerificarBanco() {
        const btn = document.getElementById('debug-contador');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
        
        try {
            if (!window.dbLocal || !window.dbLocal.fotos_pendentes) {
                alert("Erro: Banco não encontrado (window.dbLocal null).");
                return;
            }

            // Pega todos os itens para analisar
            const itens = await window.dbLocal.fotos_pendentes.toArray();
            const qtd = itens.length;
            
            btn.innerText = `Itens: ${qtd}`;

            if (qtd === 0) {
                alert("✅ BANCO VAZIO\nO iPhone enviou tudo direto (Bypass ativo) ou já sincronizou.");
            } else {
                // ANALISA O PRIMEIRO ITEM PARA VER COMO FOI SALVO
                const item = itens[0];
                let relatorio = `⚠️ EXISTEM ${qtd} FOTOS OFFLINE:\n\n`;
                
                relatorio += `📸 FOTO ID: ${item.id}\n`;
                
                // VERIFICAÇÃO DO TIPO
                if (item.blob instanceof Blob) {
                    // Cenario Ideal
                    const tamanhoMB = (item.blob.size / 1024 / 1024).toFixed(2);
                    relatorio += `💾 TIPO: BLOB (Arquivo Puro) ✅\n`;
                    relatorio += `📦 TAMANHO: ${tamanhoMB} MB\n`;
                    relatorio += `ℹ️ O iPhone ACEITOU salvar arquivos. Memória RAM está salva!`;
                } 
                else if (typeof item.blob === 'string') {
                    // Cenario de Emergência (Base64)
                    const tamanhoMB = (item.blob.length / 1024 / 1024).toFixed(2); // Aproximado
                    relatorio += `📝 TIPO: BASE64 (Texto) 🛡️\n`;
                    relatorio += `📦 TAMANHO: ~${tamanhoMB} MB\n`;
                    relatorio += `ℹ️ O iPhone BLOQUEOU arquivos, mas o Plano B salvou como texto!`;
                } 
                else {
                    relatorio += `❓ TIPO: DESCONHECIDO (${typeof item.blob})`;
                }

                alert(relatorio);
            }

        } catch (e) {
            alert("Erro na análise: " + e.message);
            btn.innerText = 'Erro';
        }
    }

    // 2. Função de Emergência para limpar na marra
    async function debugLimparBanco() {
        if(!confirm("Tem certeza? Isso vai apagar as fotos que ainda não subiram! Use só se travou tudo.")) return;
        
        try {
            await window.dbLocal.fotos_pendentes.clear();
            alert("🗑️ Banco esvaziado na força bruta.");
            debugVerificarBanco(); // Atualiza contador
        } catch (e) {
            alert("Erro ao limpar: " + e.message);
        }
    }
</script>
{% endblock %}