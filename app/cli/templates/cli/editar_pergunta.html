{% extends 'base_cliq.html' %}
{% block title %}Editar Pergunta - {{ pergunta.topico.nome }}{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.listar_questionarios') }}">Questionários</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.gerenciar_topicos', id=pergunta.topico.questionario_id) }}">{{ pergunta.topico.questionario.nome }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=pergunta.topico_id) }}">{{ pergunta.topico.nome }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Editar Pergunta</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0"><i class="fas fa-edit text-warning me-2"></i> Editar Pergunta</h2>
         <a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=pergunta.topico_id) }}" class="btn btn-sm btn-outline-secondary">
             <i class="fas fa-arrow-left me-1"></i> Voltar às Perguntas
         </a>
    </div>
    <p class="text-muted mb-4">Editando pergunta do tópico: <strong>{{ pergunta.topico.nome }}</strong></p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="card shadow-sm">
         <div class="card-header">
             <h5 class="mb-0"><i class="fas fa-edit me-2"></i> Detalhes da Pergunta</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('cli.editar_pergunta', pergunta_id=pergunta.id) }}" id="form-pergunta">
                
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                    <label for="texto" class="form-label">Texto da Pergunta <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="texto" name="texto" rows="3" required>{{ pergunta.texto or '' }}</textarea>
                </div>

                <div class="mb-3">
                    <label for="tipo" class="form-label">Tipo de Resposta <span class="text-danger">*</span></label>
                    <select class="form-select" id="tipo" name="tipo" required onchange="toggleOpcoes()">
                        {# Tenta pré-selecionar o tipo atual #}
                        <option value="SIM_NAO_NA" {% if pergunta.tipo.name == 'SIM_NAO_NA' %}selected{% endif %}>Sim / Não / N.A.</option>
                        <option value="MULTIPLA_ESCOLHA" {% if pergunta.tipo.name == 'MULTIPLA_ESCOLHA' %}selected{% endif %}>Múltipla Escolha</option>
                        <option value="ESCALA_NUMERICA" {% if pergunta.tipo.name == 'ESCALA_NUMERICA' %}selected{% endif %}>Escala Numérica</option>
                        <option value="NOTA" {% if pergunta.tipo.name == 'NOTA' %}selected{% endif %}>Nota</option>
                        <option value="TEXTO_CURTO" {% if pergunta.tipo.name == 'TEXTO_CURTO' %}selected{% endif %}>Texto Curto</option>
                        <option value="TEXTO_LONGO" {% if pergunta.tipo.name == 'TEXTO_LONGO' %}selected{% endif %}>Texto Longo</option>
                        <option value="FOTO" {% if pergunta.tipo.name == 'FOTO' %}selected{% endif %}>Foto</option>
                        <option value="DATA" {% if pergunta.tipo.name == 'DATA' %}selected{% endif %}>Data</option>
                        <option value="HORA" {% if pergunta.tipo.name == 'HORA' %}selected{% endif %}>Hora</option>
                        <option value="NUMERO" {% if pergunta.tipo.name == 'NUMERO' %}selected{% endif %}>Número</option>
                        <option value="PORCENTAGEM" {% if pergunta.tipo.name == 'PORCENTAGEM' %}selected{% endif %}>Porcentagem</option>
                        <option value="MOEDA" {% if pergunta.tipo.name == 'MOEDA' %}selected{% endif %}>Moeda</option>
                    </select>
                </div>

                <div id="opcoes-container" class="mb-3 border p-3 rounded bg-light" style="display: none;">
                    <h5>Opções de Resposta</h5>
                    <div id="opcoes-lista">
                        {# Preenche as opções existentes #}
                        {% if pergunta.tipo.name in ['MULTIPLA_ESCOLHA', 'ESCALA_NUMERICA'] and pergunta.opcoes %}
                            {% for opcao in pergunta.opcoes.order_by('ordem') %}
                                <div class="input-group mb-2">
                                    <input type="text" name="opcao_texto[]" class="form-control form-control-sm" placeholder="Texto da Opção" value="{{ opcao.texto }}" required>
                                    <input type="number" name="opcao_valor[]" class="form-control form-control-sm" placeholder="Valor (Pontos)" value="{{ opcao.valor if opcao.valor is not none else '' }}" step="any">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerOpcao(this)" title="Remover Opção">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarOpcao()">
                        <i class="fas fa-plus"></i> Adicionar Opção
                    </button>
                    <div class="form-text">Para Múltipla Escolha ou Escala, defina as opções e seus valores (pontos).</div>
                </div>

                <div class="mb-3">
                    <label for="peso" class="form-label">Peso da Pergunta</label>
                    <input type="number" class="form-control" id="peso" name="peso" value="{{ pergunta.peso | default(1) }}" min="0" step="1">
                    <div class="form-text">Define a importância desta pergunta no cálculo da nota final.</div>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="obrigatoria" name="obrigatoria" {% if pergunta.obrigatoria %}checked{% endif %}>
                        <label class="form-check-label" for="obrigatoria">Resposta Obrigatória</label>
                    </div>
                </div>
                 <div class="mb-3">
                     <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="permite_observacao" name="permite_observacao" {% if pergunta.permite_observacao %}checked{% endif %}>
                        <label class="form-check-label" for="permite_observacao">Permitir Observação Adicional</label>
                    </div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between">
                     <a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=pergunta.topico_id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Script JS para gerenciar opções dinamicamente (igual ao de nova_pergunta.html) #}
<script>
    function toggleOpcoes() {
        const tipoSelect = document.getElementById('tipo');
        const opcoesContainer = document.getElementById('opcoes-container');
        const selectedType = tipoSelect.value;

        if (selectedType === 'MULTIPLA_ESCOLHA' || selectedType === 'ESCALA_NUMERICA') {
            opcoesContainer.style.display = 'block';
             // Não adiciona automaticamente ao editar, pois já carrega as existentes
        } else {
            opcoesContainer.style.display = 'none';
            // Não limpa ao editar, pois o backend vai ignorar se o tipo não for compatível
        }
    }

    function adicionarOpcao(texto = '', valor = '') {
        const lista = document.getElementById('opcoes-lista');
        const index = lista.children.length;
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <input type="text" name="opcao_texto[]" class="form-control form-control-sm" placeholder="Texto da Opção ${index + 1}" value="${texto}" required>
            <input type="number" name="opcao_valor[]" class="form-control form-control-sm" placeholder="Valor (Pontos)" value="${valor}" step="any">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerOpcao(this)" title="Remover Opção">
                <i class="fas fa-times"></i>
            </button>
        `;
        lista.appendChild(div);
    }

    function removerOpcao(button) {
        button.closest('.input-group').remove();
        // Renumerar placeholders
        const lista = document.getElementById('opcoes-lista');
        Array.from(lista.children).forEach((div, i) => {
             div.querySelector('input[name="opcao_texto[]"]').placeholder = `Texto da Opção ${i + 1}`;
        });
    }

    // Chama toggleOpcoes na carga inicial para mostrar/ocultar corretamente
    document.addEventListener('DOMContentLoaded', toggleOpcoes); 
</script>
{% endblock %}