{% extends 'base_cliq.html' %}
{% block title %}Editar Pergunta - {{ pergunta.topico.questionario.nome }}{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.listar_questionarios') }}">Questionários</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.gerenciar_topicos', id=pergunta.topico.questionario.id) }}">{{ pergunta.topico.questionario.nome }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=pergunta.topico_id) }}">{{ pergunta.topico.nome }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Editar Pergunta</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0"><i class="fas fa-edit text-primary me-2"></i> Editar Pergunta</h2>
        <a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=pergunta.topico_id) }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
    </div>

    {% include 'includes/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 text-secondary"><i class="fas fa-question-circle me-2"></i>Detalhes da Pergunta</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('cli.editar_pergunta', pergunta_id=pergunta.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="mb-3">
                    <label for="texto" class="form-label fw-bold">Texto da Pergunta <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="texto" name="texto" rows="3" required>{{ pergunta.texto }}</textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="tipo" class="form-label fw-bold">Tipo de Resposta <span class="text-danger">*</span></label>
                        <select class="form-select" id="tipo" name="tipo" onchange="toggleOpcoes()">
                            {% for tipo in ['SIM_NAO_NA', 'MULTIPLA_ESCOLHA', 'ESCALA_NUMERICA', 'NOTA', 'TEXTO_CURTO', 'TEXTO_LONGO', 'FOTO', 'DATA', 'HORA', 'NUMERO', 'PORCENTAGEM', 'MOEDA', 'ASSINATURA'] %}
                            <option value="{{ tipo }}" {% if pergunta.tipo.name == tipo or pergunta.tipo.value == tipo %}selected{% endif %}>
                                {{ tipo.replace('_', ' ').title() }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="criterio_foto" class="form-label fw-bold">Evidência Fotográfica</label>
                        <select class="form-select border-primary" name="criterio_foto" id="criterio_foto">
                            <option value="nenhuma" {% if pergunta.criterio_foto == 'nenhuma' %}selected{% endif %}>
                                Sem Foto
                            </option>
                            <option value="opcional" {% if pergunta.criterio_foto == 'opcional' %}selected{% endif %}>
                                Opcional (Botão Visível)
                            </option>
                            <option value="obrigatoria" {% if pergunta.criterio_foto == 'obrigatoria' %}selected{% endif %}>
                                Obrigatória (Bloqueia envio sem foto)
                            </option>
                        </select>
                        <div class="form-text">Define se o avaliador deve enviar uma foto como evidência.</div>
                    </div>
                </div>

                <div id="area-opcoes" class="mb-3 border p-3 rounded bg-light" style="display: none;">
                    <h6 class="card-title">Opções de Resposta</h6>
                    <p class="small text-muted mb-2">Adicione as opções disponíveis para esta pergunta.</p>
                    
                    <div id="container-opcoes">
                        {# Usa a variável 'opcoes' passada pela rota, se existir, senão usa do objeto #}
                        {% set lista_opcoes = opcoes if opcoes is defined else [] %}
                        {% if not lista_opcoes and pergunta.opcoes %}
                            {% set lista_opcoes = pergunta.opcoes %}
                        {% endif %}

                        {% for opcao in lista_opcoes %}
                        <div class="input-group mb-2 item-opcao">
                            <input type="hidden" name="opcao_id[]" value="{{ opcao.id }}">
                            <input type="text" class="form-control form-control-sm" name="opcao_texto[]" placeholder="Texto da opção" value="{{ opcao.texto }}" required>
                            <input type="number" class="form-control form-control-sm" name="opcao_valor[]" placeholder="Pontos" value="{{ opcao.valor }}" step="0.1" style="max-width: 100px;">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerOpcao(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarOpcao()">
                        <i class="fas fa-plus me-1"></i> Adicionar Opção
                    </button>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="peso" class="form-label fw-bold">Peso na Nota</label>
                        <input type="number" class="form-control" id="peso" name="peso" value="{{ pergunta.peso }}" min="0" step="1">
                        <div class="form-text">Defina 0 para não pontuar.</div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="obrigatoria" name="obrigatoria" {% if pergunta.obrigatoria %}checked{% endif %}>
                        <label class="form-check-label" for="obrigatoria">Resposta Obrigatória</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="permite_observacao" name="permite_observacao" {% if pergunta.permite_observacao %}checked{% endif %}>
                        <label class="form-check-label" for="permite_observacao">Permitir Observações Adicionais</label>
                    </div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('cli.gerenciar_perguntas', topico_id=pergunta.topico_id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleOpcoes() {
        const tipo = document.getElementById('tipo').value;
        const areaOpcoes = document.getElementById('area-opcoes');
        const tiposComOpcoes = ['MULTIPLA_ESCOLHA', 'ESCALA_NUMERICA'];
        
        if (tiposComOpcoes.includes(tipo)) {
            areaOpcoes.style.display = 'block';
            const container = document.getElementById('container-opcoes');
            if (container.children.length === 0) {
                adicionarOpcao();
            }
        } else {
            areaOpcoes.style.display = 'none';
        }
    }

    function adicionarOpcao() {
        const container = document.getElementById('container-opcoes');
        const novaLinha = document.createElement('div');
        novaLinha.className = 'input-group mb-2 item-opcao';
        novaLinha.innerHTML = `
            <input type="hidden" name="opcao_id[]" value="">
            <input type="text" class="form-control form-control-sm" name="opcao_texto[]" placeholder="Texto da opção" required>
            <input type="number" class="form-control form-control-sm" name="opcao_valor[]" placeholder="Pontos" value="0" step="0.1" style="max-width: 100px;">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerOpcao(this)">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(novaLinha);
    }

    function removerOpcao(btn) {
        btn.closest('.item-opcao').remove();
    }

    // Inicializar estado
    document.addEventListener('DOMContentLoaded', function() {
        toggleOpcoes();
    });
</script>
{% endblock %}