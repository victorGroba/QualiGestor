{% extends "base_cliq.html" %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-0 fw-bold text-dark"><i class="fas fa-clipboard-check text-primary me-2"></i>AÃ§Ãµes Corretivas
            </h3>
            <p class="text-muted mb-0">
                {{ aplicacao.avaliado.nome }} |
                {{ (aplicacao.visita_inicio or aplicacao.data_inicio).strftime('%d/%m/%Y') }}
            </p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('cli.visualizar_aplicacao', id=aplicacao.id) }}"
                class="btn btn-outline-secondary shadow-sm">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
            <a href="{{ url_for('cli.pdf_acoes_corretivas', id=aplicacao.id) }}" target="_blank"
                class="btn btn-danger shadow-sm">
                <i class="fas fa-file-pdf me-2"></i>Gerar RelatÃ³rio
            </a>
        </div>
    </div>

    {% if not acoes %}
    <div class="alert alert-success text-center p-5 shadow-sm rounded-4">
        <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
        <h4>Tudo Certo!</h4>
        <p class="text-muted">Nenhuma NÃ£o Conformidade foi registrada nesta auditoria.</p>
    </div>
    {% else %}

    <div class="row">
        {% for acao in acoes %}

        {# Busca a resposta original para pegar as fotos #}
        {% set resposta = aplicacao.respostas.filter_by(pergunta_id=acao.pergunta_id).first() %}

        <div class="col-12 mb-5">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white border-bottom p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-light text-dark border mb-2">
                                {{ acao.pergunta.topico.ordem }}. {{ acao.pergunta.topico.nome }}
                            </span>
                            <h5 class="fw-bold text-dark mb-1">
                                {{ acao.pergunta.topico.ordem }}.{{ acao.pergunta.ordem }} - {{ acao.pergunta.texto }}
                            </h5>
                        </div>
                        <span
                            class="badge {{ 'bg-success' if acao.status == 'Realizado' else 'bg-warning text-dark' }} px-3 py-2 rounded-pill">
                            {{ acao.status }}
                        </span>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="row g-0">

                        <div class="col-lg-5 bg-light border-end">
                            <div class="p-4">
                                <h6 class="fw-bold text-muted text-uppercase small mb-3">EvidÃªncias Encontradas</h6>

                                <div class="alert alert-white border shadow-sm mb-3">
                                    <i class="fas fa-comment-alt text-danger me-2"></i>
                                    <span class="fst-italic text-dark">{{ acao.descricao_nao_conformidade }}</span>
                                </div>

                                {% if resposta and (resposta.fotos or resposta.caminho_foto) %}
                                <div class="d-flex flex-wrap gap-2">
                                    {# Fotos novas (Tabela FotoResposta) #}
                                    {% for foto in resposta.fotos %}
                                    <div class="position-relative" style="width: 100px; height: 100px;">
                                        <a href="{{ url_for('cli.uploaded_file', filename=foto.caminho) }}"
                                            target="_blank">
                                            <img src="{{ url_for('cli.uploaded_file', filename=foto.caminho) }}"
                                                class="img-thumbnail w-100 h-100 object-fit-cover shadow-sm"
                                                style="cursor: zoom-in;">
                                        </a>
                                    </div>
                                    {% endfor %}

                                    {# Foto legado (Coluna caminho_foto) #}
                                    {% if resposta.caminho_foto %}
                                    <div class="position-relative" style="width: 100px; height: 100px;">
                                        <a href="{{ url_for('cli.uploaded_file', filename=resposta.caminho_foto) }}"
                                            target="_blank">
                                            <img src="{{ url_for('cli.uploaded_file', filename=resposta.caminho_foto) }}"
                                                class="img-thumbnail w-100 h-100 object-fit-cover shadow-sm">
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <div class="text-center py-4 text-muted border rounded border-dashed">
                                    <i class="fas fa-camera-slash mb-2"></i><br>
                                    Sem fotos anexadas
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <div class="p-4">
                                <form method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <input type="hidden" name="acao_id" value="{{ acao.id }}">

                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="fw-bold text-primary text-uppercase small mb-0">DefiniÃ§Ã£o da SoluÃ§Ã£o
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-outline-primary rounded-pill px-3"
                                            onclick="gerarSugestaoIA({{ acao.id }}, '{{ acao.pergunta.texto | replace("'", "") }}'
                                            , '{{ acao.descricao_nao_conformidade | replace("'", "") }}')">
                                            <i class="fas fa-magic me-2"></i>Usar IA
                                        </button>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label small fw-bold text-muted">Criticidade</label>
                                            <select name="criticidade" class="form-select bg-light border-0 fw-bold">
                                                <option value="Baixa" {{ 'selected' if acao.criticidade=='Baixa' }}>ðŸŸ¢
                                                    Baixa</option>
                                                <option value="MÃ©dia" {{ 'selected' if acao.criticidade=='MÃ©dia' }}>ðŸŸ¡
                                                    MÃ©dia</option>
                                                <option value="Alta" {{ 'selected' if acao.criticidade=='Alta' }}>ðŸ”´
                                                    Alta</option>
                                            </select>
                                        </div>

                                        <div class="col-md-12">
                                            <label class="form-label small fw-bold text-muted">AÃ§Ã£o Corretiva Sugerida
                                                (Consultora)</label>
                                            <textarea name="sugestao" id="sugestao_{{ acao.id }}"
                                                class="form-control bg-light" rows="3"
                                                placeholder="Descreva a aÃ§Ã£o tÃ©cnica para resolver o problema...">{{ acao.sugestao_correcao or '' }}</textarea>
                                        </div>

                                        <div class="col-md-12">
                                            <div class="p-3 rounded border border-warning bg-warning bg-opacity-10">
                                                <label class="form-label small fw-bold text-dark"><i
                                                        class="fas fa-user-tie me-1"></i>O que foi feito?
                                                    (Gestor)</label>
                                                <textarea name="acao_realizada" class="form-control" rows="2"
                                                    placeholder="EspaÃ§o reservado para o gestor preencher...">{{ acao.acao_realizada or '' }}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-end mt-3">
                                        <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">
                                            <i class="fas fa-save me-2"></i>Salvar AÃ§Ã£o
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
    async function gerarSugestaoIA(id, itemTexto, observacaoTexto) {
        const campo = document.getElementById('sugestao_' + id);
        const btn = event.currentTarget;
        const textoOriginal = btn.innerHTML;

        campo.value = "Consultando a InteligÃªncia Artificial...";
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Gerando...';

        try {
            const csrf = document.querySelector('input[name="csrf_token"]').value;
            const response = await fetch('/cli/api/ia/sugerir-correcao', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                body: JSON.stringify({ item_avaliado: itemTexto, observacao: observacaoTexto })
            });

            const data = await response.json();

            if (response.ok) {
                campo.value = data.sugestao;
                const form = campo.closest('form');
                const selectCrit = form.querySelector('select[name="criticidade"]');
                if (selectCrit && data.criticidade) {
                    selectCrit.value = data.criticidade;
                }
            } else {
                campo.value = "Erro: " + (data.erro || "Falha na IA.");
            }
        } catch (e) {
            console.error(e);
            campo.value = "Erro de conexÃ£o.";
        } finally {
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    }
</script>
{% endblock %}