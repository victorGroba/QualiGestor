{% extends 'base_cliq.html' %}
{% block title %}Nova Pergunta - {{ topico.nome }}{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.index') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.listar_questionarios') }}">Questionários</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.gerenciar_topicos', id=topico.questionario_id) }}">{{ topico.questionario.nome }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=topico.id) }}">{{ topico.nome }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Nova Pergunta</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0"><i class="fas fa-plus-circle text-success me-2"></i> Nova Pergunta</h2>
         <a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=topico.id) }}" class="btn btn-sm btn-outline-secondary">
             <i class="fas fa-arrow-left me-1"></i> Voltar às Perguntas
         </a>
    </div>
    <p class="text-muted mb-4">Adicionando pergunta ao tópico: <strong>{{ topico.nome }}</strong> (Questionário: {{ topico.questionario.nome }})</p>

    {% include 'includes/_flash_messages.html' %} {# Assume que _flash_messages.html existe #}

    <div class="card shadow-sm">
        <div class="card-header">
             <h5 class="mb-0"><i class="fas fa-edit me-2"></i> Detalhes da Pergunta</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('cli.nova_pergunta', topico_id=topico.id) }}" id="form-pergunta">

                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="mb-3">
                    <label for="texto" class="form-label">Texto da Pergunta <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="texto" name="texto" rows="3" required placeholder="Ex: O ambiente está limpo e organizado?"></textarea>
                </div>

                <div class="mb-3">
                    <label for="tipo" class="form-label">Tipo de Resposta <span class="text-danger">*</span></label>
                    <select class="form-select" id="tipo" name="tipo" required onchange="toggleOpcoes()">
                        <option value="SIM_NAO_NA" selected>Sim / Não / N.A.</option>
                        <option value="MULTIPLA_ESCOLHA">Múltipla Escolha</option>
                        <option value="ESCALA_NUMERICA">Escala Numérica (Ex: 1-5)</option>
                        <option value="NOTA">Nota (Ex: 0-10)</option>
                        <option value="TEXTO_CURTO">Texto Curto</option>
                        <option value="TEXTO_LONGO">Texto Longo</option>
                        <option value="FOTO">Foto</option>
                        <option value="DATA">Data</option>
                        <option value="HORA">Hora</option>
                        <option value="NUMERO">Número</option>
                        <option value="PORCENTAGEM">Porcentagem</option>
                        <option value="MOEDA">Moeda</option>
                        <option value="ASSINATURA">Assinatura Digital</option>
                    </select>
                </div>

                <div id="opcoes-container" class="mb-3 border p-3 rounded bg-light" style="display: none;">
                    <h5>Opções de Resposta</h5>
                    <div id="opcoes-lista">
                        </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="adicionarOpcao()">
                        <i class="fas fa-plus"></i> Adicionar Opção
                    </button>
                    <div class="form-text">Para Múltipla Escolha ou Escala, defina as opções e seus valores (pontos).</div>
                </div>

                <div class="mb-3">
                    <label for="peso" class="form-label">Peso da Pergunta</label>
                    <input type="number" class="form-control" id="peso" name="peso" value="1" min="0" step="1">
                    <div class="form-text">Define a importância desta pergunta no cálculo da nota final (padrão: 1).</div>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="obrigatoria" name="obrigatoria" checked>
                        <label class="form-check-label" for="obrigatoria">Resposta Obrigatória</label>
                    </div>
                </div>
                 <div class="mb-3">
                     <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="permite_observacao" name="permite_observacao" checked>
                        <label class="form-check-label" for="permite_observacao">Permitir Observação Adicional</label>
                    </div>
                </div>

                <div class="mb-3">
                     <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="exige_foto_se_nao_conforme" name="exige_foto_se_nao_conforme">
                        <label class="form-check-label" for="exige_foto_se_nao_conforme">Exigir Foto se Não Conforme</label>
                        <div class="form-text small text-muted">Marque se uma foto for necessária caso a resposta seja "Não" ou indique não conformidade.</div>
                    </div>
                </div>
                <hr class="my-4">

                <div class="d-flex justify-content-between">
                    <a href="{{ url_for_safe('cli.gerenciar_perguntas', topico_id=topico.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i> Criar Pergunta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Script JS para gerenciar opções dinamicamente #}
<script>
    function toggleOpcoes() {
        const tipoSelect = document.getElementById('tipo');
        const opcoesContainer = document.getElementById('opcoes-container');
        const selectedType = tipoSelect.value;

        if (selectedType === 'MULTIPLA_ESCOLHA' || selectedType === 'ESCALA_NUMERICA') {
            opcoesContainer.style.display = 'block';
            if (document.getElementById('opcoes-lista').children.length === 0) {
                 adicionarOpcao();
                 if(selectedType === 'ESCALA_NUMERICA') {
                     preencherEscalaPadrao(5);
                 }
            }
        } else {
            opcoesContainer.style.display = 'none';
            document.getElementById('opcoes-lista').innerHTML = '';
        }
    }

    function adicionarOpcao(texto = '', valor = '') {
        const lista = document.getElementById('opcoes-lista');
        const index = lista.children.length;
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `
            <input type="text" name="opcao_texto[]" class="form-control form-control-sm" placeholder="Texto da Opção ${index + 1}" value="${texto}" required>
            <input type="number" name="opcao_valor[]" class="form-control form-control-sm" placeholder="Valor (Pontos)" value="${valor}" step="any">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerOpcao(this)" title="Remover Opção">
                <i class="fas fa-times"></i>
            </button>
        `;
        lista.appendChild(div);
    }

    function removerOpcao(button) {
        button.closest('.input-group').remove();
        const lista = document.getElementById('opcoes-lista');
        Array.from(lista.children).forEach((div, i) => {
             div.querySelector('input[name="opcao_texto[]"]').placeholder = `Texto da Opção ${i + 1}`;
        });
    }
     function preencherEscalaPadrao(maxValor) {
         const lista = document.getElementById('opcoes-lista');
         lista.innerHTML = '';
         for (let i = 1; i <= maxValor; i++) {
             adicionarOpcao(String(i), String(i));
         }
    }
    document.addEventListener('DOMContentLoaded', toggleOpcoes);
</script>
{% endblock %}